

# 搭建环境

## 项目介绍

### 概述

> 云尚办公系统是一套自动办公系统，系统主要包含：管理端和员工端
>
> 管理端包含：**权限管理**、**审批管理**、**公众号菜单管理**
>
> 员工端采用微信公众号操作，包含：**办公审批**、**微信授权登录**、**消息推送等功能**

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305160926396.png" alt="image-20230516092604314" style="zoom:80%;" />

> 项目服务器端架构：SpringBoot + MyBatisPlus + SpringSecurity + Redis + Activiti+ MySQL
>
> 前端架构：vue-admin-template + Node.js + Npm + Vue + ElementUI + Axios

### 核心技术⭐

| 基础框架：SpringBoot                                         |
| ------------------------------------------------------------ |
| 数据缓存：Redis                                              |
| 数据库：MySQL                                                |
| 权限控制：SpringSecurity                                     |
| 工作流引擎：Activiti                                         |
| 前端技术：vue-admin-template + Node.js + Npm + Vue + ElementUI + Axios |
| 微信公众号：公众号菜单 + 微信授权登录 + 消息推送             |

### 项目模块

最终服务器端架构模块

guigu-oa-parent：根目录，管理子模块：

​	common：公共类父模块

​		common-util：核心工具类

​		service-util：service模块工具类

​		spring-security：spring-security业务模块

​	model：实体类模块

​	service-oa：系统服务模块

### 数据库

数据库从资料文件中获取，导入数据库，Activiti表后续自动导入，数据库表如下：

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305152118852.png" alt="67177892343" style="zoom:80%;" />

### 其他资源

如：实体类、前端项目模板等都在资料文件夹中，实体类直接复制到model模块，后续不做说明。

## 搭建环境⭐

目前先搭建“云尚办公系统“项目模块。

### 搭建项目结构

#### 搭建父工程guigu-oa-parent

> 管理子模块及依赖GroupId：com.atguigu   ArtifactId：guigu-oa-parent
>
> 新建maven项目，直接下一步到完成，**删除src目录**

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305152118838.png" alt="image-20230111100533606" style="zoom:80%;" />

#### 搭建工具类父模块common

> 工具类父模块，GroupId：com.atguigu，ArtifactId：common
>
> 第一步：右键点击“guigu-oa-parent”新建"module"，**删除src目录**

![image-20230111100718036](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305152118849.png)

#### 搭建工具类模块common-util

> 核心工具类，GroupId：com.atguigu，ArtifactId：common-util
>
> **第一步：右键点击“common”新建"module"**

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305160934047.png" alt="image-20230516093458971" style="zoom:80%;" />

#### 搭建工具类模块service-util

service模块工具类，搭建方式如：common-util

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305160935494.png" alt="image-20230516093556411" style="zoom:80%;" />

#### 搭建实体类模块model

> 实体类，搭建方式如：common，引入“资料/实体类”相关代码(暂时不用)

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305160936240.png" alt="image-20230516093642166" style="zoom:80%;" />

#### 搭建项目模块service-oa

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305160937665.png" alt="image-20230516093727569" style="zoom:67%;" />

项目结构如下：

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305160938002.png" alt="image-20230516093817941" style="zoom:80%;" />

### 配置依赖关系

#### guigu-oa-parent父模块

修改guigu-oa-parent模块pom.xml文件

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org...">
    <modelVersion>4.0.0</modelVersion>
    
    <groupId>com.atguigu</groupId>
    <artifactId>guigu-oa-parent</artifactId>
    <packaging>pom</packaging>
    <version>1.0-SNAPSHOT</version>
   <!--自动引入，不用管-->
    <modules>
        <module>common</module>
        <module>model</module>
        <module>service-oa</module>
    </modules>
    <!--配置parent-->
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.3.6.RELEASE</version>
    </parent>    
   <!--配置版本-->
    <properties>
        <java.version>1.8</java.version>
        <mybatis-plus.version>3.4.1</mybatis-plus.version>
        <mysql.version>8.0.28</mysql.version>
        <knife4j.version>3.0.3</knife4j.version>
        <jwt.version>0.9.1</jwt.version>
        <fastjson.version>2.0.21</fastjson.version>
    </properties>
    <!--配置dependencyManagement锁定依赖的版本-->
    <dependencyManagement>
        <dependencies>
            <!--mybatis-plus 持久层-->
            <dependency>
                <groupId>com.baomidou</groupId>
                <artifactId>mybatis-plus-boot-starter</artifactId>
                <version>${mybatis-plus.version}</version>
            </dependency>
            <!--mysql-->
            <dependency>
                <groupId>mysql</groupId>
                <artifactId>mysql-connector-java</artifactId>
                <version>${mysql.version}</version>
            </dependency>
            <!--knife4j-->
            <dependency>
                <groupId>com.github.xiaoymin</groupId>
                <artifactId>knife4j-spring-boot-starter</artifactId>
                <version>${knife4j.version}</version>
            </dependency>
            <!--jjwt-->
            <dependency>
                <groupId>io.jsonwebtoken</groupId>
                <artifactId>jjwt</artifactId>
                <version>${jwt.version}</version>
            </dependency>
            <!--fastjson-->
            <dependency>
                <groupId>com.alibaba</groupId>
                <artifactId>fastjson</artifactId>
                <version>${fastjson.version}</version>
            </dependency>
        </dependencies>
    </dependencyManagement>
    <!--配置打包插件-->
    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.1</version>
                <configuration>
                    <source>1.8</source>
                    <target>1.8</target>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

#### common模块

> 无需新增任何东西，下面是创建模块时自动生成的
>

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 ...">
    <parent>
        <artifactId>guigu-oa-parent</artifactId>
        <groupId>com.atguigu</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>common</artifactId>
    <packaging>pom</packaging>

    <modules>
        <module>service-util</module>
        <module>common-util</module>
    </modules>

</project>
```

#### common-util模块

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org...">
    <parent>
        <artifactId>common</artifactId>
        <groupId>com.atguigu</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>common-util</artifactId>
    <packaging>jar</packaging>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
            <scope>provided </scope>
        </dependency>
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt</artifactId>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
        </dependency>
    </dependencies>
</project>
```

#### service-util模块

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/...">
    <parent>
        <artifactId>common</artifactId>
        <groupId>com.atguigu</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>service-util</artifactId>

    <dependencies>
        <dependency>
            <groupId>com.atguigu</groupId>
            <artifactId>common-util</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
        </dependency>
        <!--mysql-->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>
    </dependencies>

</project>
```

#### model模块⭐

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/...">
    <parent>
        <artifactId>guigu-oa-parent</artifactId>
        <groupId>com.atguigu</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>model</artifactId>

    <dependencies>
        <!--lombok用来简化实体类-->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <dependency>
            <groupId>com.github.xiaoymin</groupId>
            <artifactId>knife4j-spring-boot-starter</artifactId>
            <scope>provided </scope>
        </dependency>
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
            <scope>provided </scope>
        </dependency>
    </dependencies>

</project>
```

从资源文件夹中导入实体类

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305160947515.png" alt="image-20230516094747461" style="zoom:80%;" />

> **idea中安装lombok插件**，因为目前采用idea2022版本，Lombok在2020.2开始不再更新，导致高版本IDEA(2021及之后版本)无法在Plugins中搜索到Lombok插件，需要手动安装，或者也可以不安装插件，在实体类里面手动生成get、set和构造方法

> **第一步 到官网下载Lombok插件**，https://plugins.jetbrains.com/plugin/6317-lombok/versions

选择最新版本

![image-20230111101704126](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305152118860.png)

**第二步 修改参数**

![image-20230111101810041](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305152118469.png)

修改jar包里面文件内容，可以使用压缩工具打开jar包

![image-20230111101848341](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305152118493.png)

修改当前idea版本

![image-20230111101953957](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305152118516.png)

**第三步 在idea的File -> Settings -> Plugins下选中修改参数后的安装包进行安装，安装后重启idea**

![image-20230111102104410](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305152118712.png)



![image-20230111102422788](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305152118816.png)



#### service-oa模块

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/...">
    <parent>
        <artifactId>guigu-oa-parent</artifactId>
        <groupId>com.atguigu</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>service-oa</artifactId>
    <packaging>jar</packaging>

    <dependencies>
        <dependency>
            <groupId>com.atguigu</groupId>
            <artifactId>model</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        <dependency>
            <groupId>com.atguigu</groupId>
            <artifactId>service-util</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <finalName>${project.artifactId}</finalName>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>
```



## MyBatis-Plus基础

> 官网：https://baomidou.com/，MyBatis-Plus（简称 MP）是一个MyBatis的增强工具，在 MyBatis 的基础上只做增强不做改变，为简化开发、提高效率而生。
>

### 主要特点

> - **无侵入**：只做增强不做改变，引入它不会对现有工程产生影响，如丝般顺滑
> - **强大的 CRUD 操作**：内置通用 Mapper、通用 Service，仅仅通过少量配置即可实现单表大部分 CRUD 操作，更有强大的条件构造器，满足各类使用需求
> - **支持 Lambda 形式调用**：通过 Lambda 表达式，方便的编写各类查询条件，无需再担心字段写错
> - **支持主键自动生成**：支持多达 4 种主键策略（内含分布式唯一 ID 生成器 - Sequence），可自由配置，
> - **内置代码生成器**：采用代码或者 Maven 插件可快速生成 Mapper 、 Model 、 Service 、 Controller 层代码，支持模板引擎，更有超多自定义配置等您来使用
> - **内置分页插件**：基于 MyBatis 物理分页，无需关心具体操作，配置好插件之后，写分页等同于普通 List 查询
> - **分页插件支持多种数据库**：支持 MySQL、MariaDB、Oracle、DB2、H2、HSQL、SQLite、Postgre、SQLServer 

### 依赖坐标

> 上面搭建环境时已经引入了

```xml
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-boot-starter</artifactId>
    <version>3.4.1</version>
</dependency>
```

> 前面介绍了MyBatis-Plus，当前就以角色管理为例讲解MyBatis-Plus的使用，**在service-oa模块中操作**
>

### 数据库表

```sql
create database `guigu-oa` default character set utf8mb4;
use `guigu-oa`;
```

```sql
create table `sys_role` (
  `id` bigint(20) not null auto_increment comment '角色id',
  `role_name` varchar(20) not null default '' comment '角色名称',
  `role_code` varchar(20) default null comment '角色编码',
  `description` varchar(255) default null comment '描述',
  `create_time` timestamp not null default current_timestamp comment '创建时间',
  `update_time` timestamp not null default current_timestamp on update current_timestamp comment   '更新时间',
  `is_deleted` tinyint(3) not null default '0' comment '删除标记（0:不可用 1:可用）',
  primary key (`id`)
) engine=innodb auto_increment=9 default charset=utf8 comment='角色';
```

```sql
insert into `sys_role` values
(1,'系统管理员','system','系统管理员','2021-05-31 18:09:18','2022-06-08 09:21:10',0),
(2,'普通管理员','common','普通管理员','2021-06-01 08:38:40','2022-02-24 10:42:46',0),
(3,'用户管理员','yhgly',null,'2022-06-08 17:39:04','2022-06-08 17:39:04',0);
```

### 配置文件

配置 MySQL 数据库的相关配置及Mybatis-Plus日志

application.yml

```yaml
spring:
  application:
    name: service-oa
  profiles:
    active: dev
```

application-dev.yml

```yaml
server:
  port: 8800
mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl # 查看日志
spring:
  datasource:
    type: com.zaxxer.hikari.HikariDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/guigu-oa?serverTimezone=GMT%2B8&useSSL=false&characterEncoding=utf-8
    username: root
    password: 123456
```

### 启动类

> 创建文件夹com.atguigu.auth，在 Spring Boot 启动类中添加 `@MapperScan` 注解，扫描 Mapper 文件夹：
>

```java
package com.atguigu.auth;

import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
@ComponentScan("com.atguigu")
// 设置Mapper扫描
@MapperScan("com.atguigu.*.mapper")
public class ServiceAuthApplication {

    public static void main(String[] args) {
        SpringApplication.run(ServiceAuthApplication.class, args);
    }
}
```

### 实体类

> 在model模块的com/atguigu/model/system/SysRole.java下，在上面的依赖导入中已经导入了model模块
>
> 实体类注解详细文档：https://baomidou.com/pages/223848/

#### SysRole

```java
@Data
@ApiModel(description = "角色")
// @TableName：表名注解，标识实体类对应的表
@TableName("sys_role")
public class SysRole extends BaseEntity {	
	private static final long serialVersionUID = 1L;
	//@NotBlank(message = "角色名称不能为空")
	@ApiModelProperty(value = "角色名称")
	@TableField("role_name")
	private String roleName;

	@ApiModelProperty(value = "角色编码")
    // @TableField：字段注解（非主键）
    // @TableLogic：逻辑删除
	@TableField("role_code")
	private String roleCode;

	@ApiModelProperty(value = "描述")
	@TableField("description")
	private String description;
}
```

#### BaseEntity

> 所有实体类都具有的公共字段

```java
@Data
public class BaseEntity implements Serializable {
    // @TableId：主键注解，type = IdType.AUTO（数据库 ID 自增）
    @TableId(type = IdType.AUTO)
    private Long id;

    @TableField("create_time")
    private Date createTime;

    @TableField("update_time")
    private Date updateTime;

    @TableLogic
    @TableField("is_deleted")
    private Integer isDeleted;
    // exist = false：表里可以没有这个字段
    @TableField(exist = false)
    private Map<String,Object> param = new HashMap<>();
}
```

### 添加Mapper类

> 创建com.atguigu.auth.mapper.SysRoleMapper

```java
@Mapper
@Repository
public interface SysRoleMapper extends BaseMapper<SysRole> {

}
```

### CRUD测试

#### 查询

> test目录下创建：com.atguigu.auth.SysRoleMapperTest

```java
@SpringBootTest
public class SysRoleMapperTest {

    @Autowired
    private SysRoleMapper sysRoleMapper;

    @Test
    public void testSelectList() {
        System.out.println(("----- selectAll method test ------"));
        //UserMapper 中的 selectList() 方法的参数为 MP 内置的条件封装器 Wrapper
        //所以不填写就是无任何条件
        List<SysRole> users = sysRoleMapper.selectList(null);
        users.forEach(System.out::println);
    }
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305161017822.png" alt="image-20230516101734747" style="zoom:80%;" />

> **注意：**IDEA在sysRoleMapper处报错，因为找不到注入的对象，因为类是动态创建的，但是程序可以正确的执行。为了避免报错，可以在 mapper 层 的接口上添加 @Repository 或直接使用 @Resource 代替 @Autowired。通过以上几个简单的步骤，我们就实现了 User 表的 CRUD 功能，甚至连 XML 文件都不用编写！

#### 新增

```java
@Test
public void testInsert(){
    SysRole sysRole = new SysRole();
    sysRole.setRoleName("角色管理员");
    sysRole.setRoleCode("role");
    sysRole.setDescription("角色管理员");

    int result = sysRoleMapper.insert(sysRole);
    System.out.println(result); //影响的行数
    System.out.println(sysRole); //id自动回填
}
```

#### 更新

```java
@Test
public void testUpdateById(){
    SysRole sysRole = new SysRole();
    sysRole.setId(1L);
    sysRole.setRoleName("角色管理员1");

    int result = sysRoleMapper.updateById(sysRole);
    System.out.println(result);

}
```

#### 根据id删除

```yml
# application-dev.yml 加入配置,此为默认值，如果你的默认值和mp默认的一样，则不需要该配置
mybatis-plus:
  global-config:
    db-config:
      logic-delete-value: 1
      logic-not-delete-value: 0
```

```java
@Test
public void testDeleteById(){
    // 逻辑删除，is_deleted=1即表示删除
    int result = sysRoleMapper.deleteById(9L);
    System.out.println(result);
}
```

#### 批量删除

```java
@Test
public void testDeleteBatchIds() {
    // 删除id=1和2的字段
    int result = sysRoleMapper.deleteBatchIds(Arrays.asList(1, 2);
    System.out.println(result);
}
```

#### 条件构造器⭐

![image-20220608093626416](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305152118127.png)

> **注意：以下条件构造器的方法入参中的 `column `均表示数据库字段**

```java
@Test
public void testSelect1() {
    QueryWrapper<SysRole> queryWrapper = new QueryWrapper<>();
    queryWrapper.eq("role_code", "role");
    List<SysRole> users = sysRoleMapper.selectList(queryWrapper);
    System.out.println(users);
}
```

```java
@Test
public void testSelect2() {
    LambdaQueryWrapper<SysRole> queryWrapper = new LambdaQueryWrapper<>();
    queryWrapper.eq(SysRole::getRoleCode, "role");
    List<SysRole> users = sysRoleMapper.selectList(queryWrapper);
    System.out.println(users);
}
```

其他条件构造可自行测试

### 封装service层⭐

> 创建文件：com.atguigu.auth.service.SysRoleService

```java
public interface SysRoleService extends IService<SysRole> {

}
```

#### 添加service接口实现

> 创建文件：impl.SysRoleServiceImpl

```java
@Service
public class SysRoleServiceImpl extends ServiceImpl<SysRoleMapper, SysRole> 
                                implements SysRoleService {

    @Autowired
    private SysRoleMapper sysRoleMapper;
}
```

#### 测试Service接口

> 继续在test目录下创建SysRoleServiceTest文件，进行测试

```java
@SpringBootTest
public class SysRoleServiceTest {

    @Resource
    private SysRoleService sysRoleService;

    @Test
    public void testSelectList() {
        System.out.println(("----- selectAll method test ------"));
        //UserMapper 中的 selectList() 方法的参数为 MP 内置的条件封装器 Wrapper
        //所以不填写就是无任何条件
        List<SysRole> users = sysRoleService.list();
        users.forEach(System.out::println);
    }

    @Test
    public void testInsert(){
        SysRole sysRole = new SysRole();
        sysRole.setRoleName("角色管理员");
        sysRole.setRoleCode("role");
        sysRole.setDescription("角色管理员");

        boolean result = sysRoleService.save(sysRole);
        System.out.println(result); //影响的行数
        System.out.println(sysRole); //id自动回填
    }

    @Test
    public void testUpdateById(){
        SysRole sysRole = new SysRole();
        sysRole.setId(1L);
        sysRole.setRoleName("角色管理员1");

        boolean result = sysRoleService.updateById(sysRole);
        System.out.println(result);

    }

    @Test
    public void testDeleteById(){
        boolean result = sysRoleService.removeById(2L);
        System.out.println(result);
    }

    @Test
    public void testSelect1() {
        QueryWrapper<SysRole> queryWrapper = new QueryWrapper<>();
        queryWrapper.ge("role_code", "role");
        List<SysRole> users = sysRoleService.list(queryWrapper);
        System.out.println(users);
    }

    @Test
    public void testSelect2() {
        LambdaQueryWrapper<SysRole> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.ge(SysRole::getRoleCode, "role");
        List<SysRole> users = sysRoleService.list(queryWrapper);
        System.out.println(users);
    }
}
```

## 角色管理

### 测试controller层

> 创建文件：controller.SysRoleController

```java
@RestController
@RequestMapping("/admin/system/sysRole")
public class SysRoleController {

    @Autowired
    private SysRoleService sysRoleService;

    @GetMapping("findAll")
    public List<SysRole> findAll() {
        List<SysRole> roleList = sysRoleService.list();
        return roleList;
    }
}
```

访问测试：:8800/admin/system/sysRole/findAll

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305161101800.png" alt="image-20230516110138720" style="zoom:80%;" />

### 统一返回结果

> 项目中我们会将响应封装成json返回，一般我们会将所有接口的数据格式统一， 使前端(iOS Android, Web)对数据的操作更一致、轻松。一般情况下，统一返回数据格式没有固定的格式，只要能描述清楚返回的数据状态以及要返回的具体数据就可以。但是一般会包含状态码、返回消息、数据这几部分内容
>

#### 返回格式

> 包含信息：状态码、信息、数据

例如，我们的系统要求返回的基本数据格式如下：

**列表：**

```json
{
  "code": 200,
  "message": "成功",
  "data": [
    {
      "id": 2,
      "roleName": "系统管理员"
    }
  ],
  "ok": true
}
```

**分页：**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "records": [
      {
        "id": 2,
        "roleName": "系统管理员"
      },
      {
        "id": 3,
        "name": "普通管理员"
      }
    ],
    "total": 10,
    "size": 3,
    "current": 1,
    "orders": [],
    "hitCount": false,
    "searchCount": true,
    "pages": 2
  },
  "ok": true
}
```

**没有返回数据：**

```json
{
  "code": 200,
  "message": "成功",
  "data": null,
  "ok": true
}
```

**失败：**

```json
{
  "code": 201,
  "message": "失败",
  "data": null,
  "ok": false
}
```

#### 定义枚举类

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305161109709.png" alt="image-20230516110911643" style="zoom:80%;" />

> 操作模块：common-util，后续其他模块也会用到，故抽取到common-util模块
>
> 创建文件：com.atguigu.common.result.ResultCodeEnum

```java
package com.atguigu.common.result;

import lombok.Getter;

// 统一返回结果状态信息类
@Getter
public enum ResultCodeEnum {
    // 定义枚举
    SUCCESS(200,"成功"),
    FAIL(201, "失败"),
    SERVICE_ERROR(2012, "服务异常"),
    DATA_ERROR(204, "数据异常"),
    LOGIN_AUTH(208, "未登陆"),
    PERMISSION(209, "没有权限")
    ;
    // 设置code和message
    private Integer code;
    private String message;
    // 设置有参构造，目的是传递参数
    private ResultCodeEnum(Integer code, String message) {
        this.code = code;
        this.message = message;
    }
}
```

#### 定义统一返回结果⭐

> 创建文件：com.atguigu.common.result.Result

```java
// 全局统一返回结果类
@Data
public class Result<T> {

    //返回码
    private Integer code;

    //返回消息
    private String message;

    //返回数据
    private T data;

    private Result(){}

    public static <T> Result<T> build(T body, ResultCodeEnum resultCodeEnum) {
        Result<T> result =  new Result<T>();
        // 封装数据
        if (body != null) {
            result.setData(body);
        }
        // 状态码
        result.setCode(resultCodeEnum.getCode());
        // 返回信息
        result.setMessage(resultCodeEnum.getMessage());
        return result;
    }

    public static<T> Result<T> ok(){
        return build(null,ResultCodeEnum.SUCCESS);
    }

    // 操作成功
    public static<T> Result<T> ok(T data){
        return build(data, ResultCodeEnum.SUCCESS);
    }

    public static<T> Result<T> fail(){
        return build(null,ResultCodeEnum.FAIL);
    }

    // 操作失败
    public static<T> Result<T> fail(T data){
        return build(data, ResultCodeEnum.FAIL);
    }

    public Result<T> message(String msg){
        this.setMessage(msg);
        return this;
    }

    public Result<T> code(Integer code){
        this.setCode(code);
        return this;
    }
}
```

统一返回结果状态信息类下面的状态后续都会用到，所以直接引入了

#### 改造controller方法

```java
@GetMapping("findAll")
public Result<List<SysRole>> findAll() {
    List<SysRole> roleList = sysRoleService.list();
    return Result.ok(roleList);
}
```

测试接口：:8800/admin/system/sysRole/findAll

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305161426252.png" alt="image-20230516142604176" style="zoom:80%;" />

### knife4j

> 文档地址：https://doc.xiaominfo.com/，knife4j是为Java MVC框架集成Swagger生成Api文档的增强解决方案
>

#### API文档

前后端分离开发模式中，api文档是最好的沟通方式。Swagger 是一个规范和完整的框架，用于生成、描述、调用和可视化 RESTful 风格的 Web 服务。

> 1、及时性 (接口变更后，能够及时准确地通知相关前后端开发人员)
>
> 2、规范性 (并且保证接口的规范性，如接口的地址，请求方式，参数及响应格式和错误信息)
>
> 3、一致性 (接口信息一致，不会出现因开发人员拿到的文档版本不一致，而出现分歧)
>
> 4、可测性 (直接在接口文档上进行测试，以方便理解业务)

#### 集成knife4j

> knife4j属于service模块公共资源，因此我们集成到service-uitl模块
>

##### 添加依赖

操作模块：service-uitl

```xml
<dependency>
    <groupId>com.github.xiaoymin</groupId>
    <artifactId>knife4j-spring-boot-starter</artifactId>
</dependency>
```

说明：guigu-auth-parent已加入版本管理

##### 添加knife4j配置类

> 操作模块：service-uitl，创建文件：com.atguigu.common.config.knife4j.Knife4jConfig
>

```java
package com.atguigu.common.config.knife4j;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import springfox.documentation.builders.ApiInfoBuilder;
import springfox.documentation.builders.ParameterBuilder;
import springfox.documentation.builders.PathSelectors;
import springfox.documentation.builders.RequestHandlerSelectors;
import springfox.documentation.schema.ModelRef;
import springfox.documentation.service.ApiInfo;
import springfox.documentation.service.Contact;
import springfox.documentation.service.Parameter;
import springfox.documentation.spi.DocumentationType;
import springfox.documentation.spring.web.plugins.Docket;
import springfox.documentation.swagger2.annotations.EnableSwagger2WebMvc;
import java.util.ArrayList;
import java.util.List;

/**
 * knife4j配置信息
 */
@Configuration
@EnableSwagger2WebMvc
public class Knife4jConfig {

    @Bean
    public Docket adminApiConfig(){
        List<Parameter> pars = new ArrayList<>();
        ParameterBuilder tokenPar = new ParameterBuilder();
        tokenPar.name("token")
                .description("用户token")
                .defaultValue("")
                .modelRef(new ModelRef("string"))
                .parameterType("header")
                .required(false)
                .build();
        pars.add(tokenPar.build());
        //添加head参数end

        Docket adminApi = new Docket(DocumentationType.SWAGGER_2)
                .groupName("adminApi")
                .apiInfo(adminApiInfo())
                .select()
                //只显示admin路径下的页面
                .apis(RequestHandlerSelectors.basePackage("com.atguigu"))
                .paths(PathSelectors.regex("/admin/.*"))
                .build()
                .globalOperationParameters(pars);
        return adminApi;
    }

    private ApiInfo adminApiInfo(){

        return new ApiInfoBuilder()
                .title("后台管理系统-API文档")
                .description("本文档描述了后台管理系统微服务接口定义")
                .version("1.0")
                .contact(new Contact("atguigu", "http://atguigu.com", "atguigu@qq.com"))
                .build();
    }


}
```

##### Controller层添加注解

```java
@Api(tags = "角色管理")
@RestController
@RequestMapping("/admin/system/sysRole")
public class SysRoleController {

    @Autowired
    private SysRoleService sysRoleService;

    @ApiOperation(value = "获取全部角色列表")
    @GetMapping("findAll")
    public Result<List<SysRole>> findAll() {
        List<SysRole> roleList = sysRoleService.list();
        return Result.ok(roleList);
    }
}
```

##### 访问测试

:8800/doc.html

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305161439834.png" alt="image-20230516143935724" style="zoom:80%;" />

### 分页查询

#### 配置分页插件

> 操作模块：service-util，service公共资源
>
> 说明：我们将@MapperScan("com.atguigu.auth.mapper")提取到该配置类上面，统一管理，启动类就不需要了。

```java
package com.atguigu.common.config.mp;

import com.baomidou.mybatisplus.annotation.DbType;
import com.baomidou.mybatisplus.autoconfigure.ConfigurationCustomizer;
import com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;
import com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
@MapperScan("com.atguigu.auth.mapper")
public class MybatisPlusConfig {

    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
    /**
     * 新的分页插件,一缓和二缓遵循mybatis的规则,需要设置 
       MybatisConfiguration#useDeprecatedExecutor = false 
       避免缓存出现问题(该属性会在旧插件移除后一同移除，因此插件会过期，可以删除该配置)
    */
    @Bean
    public ConfigurationCustomizer configurationCustomizer() {
        return configuration -> configuration.setUseDeprecatedExecutor(false);
    }
}
```

#### 条件分页查询

> 封装查询条件(可选)

```java
public class SysRoleQueryVo implements Serializable {
   private static final long serialVersionUID = 1L;
   private String roleName;
   public String getRoleName() {
      return roleName;
   }
   public void setRoleName(String roleName) {
      this.roleName = roleName;
   }
}
```

> 进行分页查询

```java
// SysRoleQueryVo 条件对象
@ApiOperation("条件分页查询")
@GetMapping("{page}/{limit}")
// page 当前页  limit 每页显示记录数 SysRoleQueryVo 查询条件(可选)
public Result<IPage<SysRole>> pageQueryRole(@PathVariable Long page,
                                            @PathVariable Long limit,
                                            SysRoleQueryVo sysRoleQueryVo) {
    // 调用service的方法实现
    // 创建Page对象，传递分页相关参数
    // page 当前页  limit 每页显示记录数
    Page<SysRole> pageParam = new Page<>(page,limit);
    //2 封装条件，判断条件是否为空，不为空进行封装
    LambdaQueryWrapper<SysRole> wrapper = new LambdaQueryWrapper<>();
    // 如果没传对象，则不进行拼接
    String roleName = sysRoleQueryVo.getRoleName();
    if(!StringUtils.isEmpty(roleName)) {
        //封装 like模糊查询
        wrapper.like(SysRole::getRoleName,roleName);
    }
    //3 调用方法实现
    IPage<SysRole> pageModel = sysRoleService.page(pageParam, wrapper);
    return Result.ok(pageModel);
}
```

访问测试：:8800/doc.html

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305161452303.png" alt="image-20230516145242197" style="zoom: 67%;" />

### CURD方法

> 说明：通过knife4j测试接口，分页和查询全部见上面

#### 根据ID获取

```java
@ApiOperation(value = "根据ID获取")
@GetMapping("get/{id}")
public Result get(@PathVariable Long id) {
    SysRole role = sysRoleService.getById(id);
    return Result.ok(role);
}
```

#### 新增角色

```java
@ApiOperation(value = "新增角色")
@PostMapping("save")
public Result save(@RequestBody SysRole role) {
    boolean is_success = sysRoleService.save(role);
    if (is_success) {
        return Result.ok();
    } else {
        return Result.fail();
    }
}
```

#### 修改角色

```java
@ApiOperation(value = "修改角色")
@PutMapping("update")
public Result updateById(@RequestBody SysRole role) {
    boolean is_success = sysRoleService.updateById(role);
    if (is_success) {
        return Result.ok();
    } else {
        return Result.fail();
    }
}
```

#### 删除角色

```java
@ApiOperation(value = "删除角色")
@DeleteMapping("remove/{id}")
public Result remove(@PathVariable Long id) {
    boolean is_success = sysRoleService.removeById(id);
    if (is_success) {
        return Result.ok();
    } else {
        return Result.fail();
    }
}
```

#### 根据id列表删除

```java
@ApiOperation(value = "根据id列表删除")
@DeleteMapping("batchRemove")
public Result batchRemove(@RequestBody List<Long> idList) {
    boolean is_success = sysRoleService.removeByIds(idList);
    if (is_success) {
        return Result.ok();
    } else {
        return Result.fail();
    }
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305161515354.png" alt="image-20230516151517279" style="zoom:80%;" />

### 配置日期时间格式

> application-dev.yml添加以下内容，注意：只对Date类型生效，对LocalDate等类型不生效
>

```yaml
spring: 
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8
```

### 统一异常处理

#### 异常模拟

```java
@ApiOperation(value = "获取全部角色列表")
@GetMapping("findAll")
public Result<List<SysRole>> findAll() {
    List<SysRole> roleList = sysRoleService.list();
    // 模拟异常效果
    int a = 10/0;
    return Result.ok(roleList);
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305161528928.png" alt="image-20230516152802865" style="zoom:80%;" />

我们想让异常结果也显示为统一的返回结果对象，并且统一处理系统的异常信息，那么需要统一异常处理。

#### 全局异常处理

> 操作模块：service-util，package com.atguigu.common.handler;
>

```java
// 全局异常处理类
@RestControllerAdvice
public class GlobalExceptionHandler {

    // Exception.class所有异常都处理，方法名称任意
    @ExceptionHandler(Exception.class)
    public Result error(Exception e){
        e.printStackTrace();
        return Result.fail().message("执行全局异常处理...");
    }
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305161533294.png" alt="image-20230516153318226" style="zoom:80%;" />

#### 处理特定异常

> 有特定先执行特定，没有特定再去执行全局异常处理

```java
@ExceptionHandler(ArithmeticException.class)
public Result error(ArithmeticException e){
	e.printStackTrace();
	return Result.fail().message("执行了特定异常处理");
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305161535686.png" alt="image-20230516153531612" style="zoom:80%;" />

#### 处理自定义异常

##### 创建自定义异常类

```java
package com.atguigu.common.execption;

import com.atguigu.common.result.ResultCodeEnum;
import lombok.Data;

/**
 * 自定义全局异常类
 */
@Data
public class GuiguException extends RuntimeException {

    private Integer code;
    private String message;

    /**
     * 通过状态码和错误消息创建异常对象
     * @param code
     * @param message
     */
    public GuiguException(Integer code, String message) {
        super(message);
        this.code = code;
        this.message = message;
    }

    /**
     * 接收枚举类型对象
     * @param resultCodeEnum
     */
    public GuiguException(ResultCodeEnum resultCodeEnum) {
        super(resultCodeEnum.getMessage());
        this.code = resultCodeEnum.getCode();
        this.message = resultCodeEnum.getMessage();
    }

    @Override
    public String toString() {
        return "GuliException{" +
                "code=" + code +
                ", message=" + this.getMessage() +
                '}';
    }
}
```

##### 业务中需要位置抛出

```java
@ApiOperation(value = "获取全部角色列表")
@GetMapping("findAll")
public Result<List<SysRole>> findAll() {
    List<SysRole> roleList = sysRoleService.list();
    // 模拟异常效果
    try {
        int a = 10/0;
    }catch(Exception e) {
        throw new GuiguException(20001,"出现自定义异常");
    }
    return Result.ok(roleList);
}
```

##### 添加异常处理方法

```java
@ExceptionHandler(GuiguException.class)
public Result error(GuiguException e){
	e.printStackTrace();
	return Result.fail().message(e.getMessage()).code(e.getCode());
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305161539930.png" alt="image-20230516153920861" style="zoom:80%;" />

# 										前端基础知识

## 前端开发介绍

> 前端工程师“Front-End-Developer”源自于美国。大约从2005年开始正式的前端工程师角色被行业所认可，到了2010年，互联网开始全面进入移动时代，前端开发的工作越来越重要。
>

> 最初所有的开发工作都是由后端工程师完成的，随着业务越来越繁杂，工作量变大，于是我们将项目中的可视化部分和一部分交互功能的开发工作剥离出来，形成了前端开发。由于互联网行业的急速发展，导致了在不同的国家，有着截然不同的分工体制。
>

> 在日本和一些人口比较稀疏的国家，例如加拿大、澳洲等，流行“Full-Stack Engineer”，也就是我们通常所说的全栈工程师。通俗点说就是一个人除了完成前端开发和后端开发工作以外，有的公司从产品设计到项目开发再到后期运维可能都是同一个人，甚至可能还要负责UI、配动画，也可以是扫地、擦窗、写文档、维修桌椅等等。
>

> 而在美国等互联网环境比较发达的国家项目开发的分工协作更为明确，整个项目开发分为前端、中间层和后端三个开发阶段，这三个阶段分别由三个或者更多的人来协同完成。国内的大部分互联网公司只有前端工程师和后端工程师，中间层的工作有的由前端来完成，有的由后端来完成。
>

> PRD（产品原型-产品经理） - PSD（视觉设计-UI工程师） - HTML/CSS/JavaScript（PC/移动端网页，实现网页端的视觉展示和交互-前端工程师）
>

## 下载和安装VS Code

### 下载地址

https://code.visualstudio.com/

### 插件安装

为方便后续开发，建议安装如下插件

![image-20220225153946727](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305152119982.png)

### 创建项目

> vscode本身没有新建项目的选项，所以要先创建一个空的文件夹，如project_xxxx。
>
> 然后打开vscode，再在vscode里面选择 File -> Open Folder 打开文件夹，这样才可以创建项目。

### 保存工作区

> 打开文件夹后，选择“文件 -> 将工作区另存为...”，为工作区文件起一个名字，存储在刚才的文件夹下即可
>

### 新建文件夹和网页

### 预览网页

> **以文件路径方式打开网页预览**，需要安装“open in browser”插件：文件右键 -> Open In Default Browser
>
> 127.0.0.1:5500/xxx.html

**以服务器方式打开网页预览**

> 需要安装“Live Server”插件：文件右键 -> Open with Live Server
>

### 设置字体大小

> 左边栏Manage -> settings -> 搜索 “font” -> Font size
>

## ES6基础

> ECMAScript 6.0（以下简称 ES6）是 JavaScript 语言的下一代标准，已经在 2015 年 6 月正式发布了。它的目标，是使得 JavaScript 语言可以用来编写复杂的大型应用程序，成为企业级开发语言。本部分只学习前端开发中ES6的最少必要知识，方便后面项目开发中对代码的理解。
>

### 模板字符串

创建 模板字符串.html

```javascript
// 2、字符串插入变量和表达式。变量名写在 ${} 中，${} 中可以放入 JavaScript 表达式。
let name = "Mike"
let age = 27
let info = `My Name is ${name},I am ${age+1} years old next year.`
console.log(info)
// My Name is Mike,I am 28 years old next year.
```

###  对象拓展运算符

> 创建 对象拓展运算符.html，拓展运算符（...）用于取出参数对象所有可遍历属性然后拷贝到当前对象。
>

```javascript
// 1、拷贝对象
let person1 = {name: "Amy", age: 15}
let someone = { ...person1 }
console.log(someone)  //{name: "Amy", age: 15}
```

### 箭头函数

> 创建 箭头函数.html，箭头函数提供了一种更加简洁的函数书写方式。基本语法是：`参数 => 函数体`
>

```javascript
// 传统
var f1 = function(a){
    return a
}
console.log(f1(1))
// ES6
var f2 = a => a
console.log(f2(1))
```

```javascript
// 当箭头函数没有参数或者有多个参数，要用 () 括起来。
// 当箭头函数函数体有多行语句，用 {} 包裹起来，表示代码块，
// 当只有一行语句，并且需要返回结果时，可以省略 {} , 结果会自动返回。
var f3 = (a,b) => {
    let result = a+b
    return result
}
console.log(f3(6,2))  // 8
// 前面代码相当于：
var f4 = (a,b) => a+b
```

箭头函数多用于匿名函数的定义

## Vue基础

### 基础

> Vue (读音 /vjuː/，类似于 view) 是一套用于构建用户界面的渐进式框架。Vue 的核心库只关注视图层，不仅易于上手，还便于与第三方库或既有项目整合。另一方面，当与现代化的工具链以及各种支持类库结合使用时，Vue 也完全能够为复杂的单页应用提供驱动。官方网站：https://cn.vuejs.org 
>

创建 demo.html

```html
<!-- id标识vue作用的范围 -->
<div id="app">
    <!-- {{}} 插值表达式，绑定vue中的data数据 -->
    {{ message }}
</div>
<script src="vue.min.js"></script>
<script>
    // 创建一个vue对象
    new Vue({
        el: '#app',//绑定vue作用的范围
        data: {//定义页面中显示的模型数据
            message: 'Hello Vue!'
        }
    })
</script>
```

这就是声明式渲染：Vue.js 的核心是一个允许采用简洁的模板语法来声明式地将数据渲染进 DOM 的系统这里的核心思想就是没有繁琐的DOM操作，例如jQuery中，我们需要先找到div节点，获取到DOM对象，然后进行一系列的节点操作

### 生命周期

创建 vue实例的生命周期.html

```html
<body>
    <div id="app">
        {{info}}
    </div>
    <script src="vue.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            data: {
               info:'hello atguigu' 
            },
            created() { //渲染前
                debugger
                console.log('created....')
            },
            mounted() { //渲染后
                debugger
                console.log('mounted....')
            }
        })
    </script>
</body>
```

### Axios

Axios是独立于Vue的一个项目，基于promise用于浏览器和node.js的http客户端

- 在浏览器中可以帮助我们完成 ajax请求的发送

- 在node.js中可以向远程接口发送请求，**引入vue和axios的js文件**


```html
<script src="vue.min.js"></script>
<script src="axios.min.js"></script>
```

**进行axios调用**

```javascript
var app = new Vue({
    el: '#app',
    data: {
        memberList: []//数组
    },
    created() {
        this.getList()
    },
    methods: {
        getList(id) {
            axios.get('data.json')
            .then(response => {
                console.log(response)
                this.memberList = response.data.data.items
            })
            .catch(error => {
                console.log(error)
            })
        }
    }
})
```

**创建data.json文件**

```json
{
    "success":true,
    "code":20000,
    "message":"成功",
    "data":{
        "list":[
            {"name":"lucy","age":20},
            {"name":"mary","age":30},
            {"name":"jack","age":40}
        ]
    }
}
```

**控制台查看输出**

## Node.js基础

### Node.js简介

> 简单的说 Node.js 就是运行在服务端的 JavaScript。Node.js是一个事件驱动I/O服务端JavaScript环境，基于Google的V8引擎，V8引擎执行Javascript的速度非常快，性能非常好。如果你是一个前端程序员，你不懂得像PHP、Python或Ruby等动态编程语言，然后你想创建自己的服务，那么Node.js是一个非常好的选择。
>

> Node.js 是运行在服务端的 JavaScript，如果你熟悉Javascript，那么你将会很容易的学会Node.js。当然，如果你是后端程序员，想部署一些高性能的服务，那么学习Node.js也是一个非常好的选择。
>

### Node.js安装

> 官网：https://nodejs.org/en/   中文网：http://nodejs.cn/ ，下载完成直接点击安装即可
>

> LTS：长期支持版本，Current：最新版
>

```shell
node -v
```

### 简单入门

创建 01-控制台程序.js

```javascript
console.log('Hello Node.js')
```

进入到程序所在的目录，输入

```cmake
node 01-控制台程序.js
```

浏览器的内核包括两部分核心：

> - DOM渲染引擎；
> - js解析器（js引擎）
> - js运行在浏览器中的内核中的js引擎内部

Node.js是脱离浏览器环境运行的JavaScript程序，基于V8 引擎（Chrome 的 JavaScript的引擎）

## NPM

### NPM简介

> NPM全称Node Package Manager，是Node.js包管理工具，是全球最大的模块生态系统，里面所有的模块都是开源免费的；也是Node.js的包管理工具，相当于前端的Maven 。
>

> NPM工具的安装位置：我们通过npm 可以很方便地下载js库，管理前端工程。Node.js默认安装的npm包和工具的位置：Node.js目录\node_modules，在这个目录下你可以看见 npm目录，npm本身就是被NPM包管理器管理的一个工具，说明 Node.js已经集成了npm工具
>

```shell
#在命令提示符输入 npm -v 可查看当前npm版本
npm -v
```

### 使用npm管理项目

#### 创建文件夹npm

#### 项目初始化

```shell
#建立一个空文件夹，在命令提示符进入该文件夹  执行命令初始化
npm init
#按照提示输入相关信息，如果是用默认值则直接回车即可。
#name: 项目名称
#version: 项目版本号
#description: 项目描述
#keywords: {Array}关键词，便于用户搜索到我们的项目
#最后会生成package.json文件，这个是包的配置文件，相当于maven的pom.xml
#我们之后也可以根据需要进行修改。
```

```shell
#如果想直接生成 package.json 文件，那么可以使用命令
npm init -y
```

#### 修改npm镜像源

NPM官方的管理的包都是从 http://npmjs.com下载的，但是这个网站在国内速度很慢。

这里推荐使用淘宝 NPM 镜像 http://npm.taobao.org/ ，淘宝 NPM 镜像是一个完整 npmjs.com 镜像，同步频率目前为 10分钟一次，以保证尽量与官方服务同步。**设置镜像地址：**

```shell
#经过下面的配置，以后所有的 npm install 都会经过淘宝的镜像地址下载
npm config set registry https://registry.npm.taobao.org 
#查看npm配置信息
npm config list
```

#### npm install命令的使用

```shell
#使用 npm install 安装依赖包的最新版，
#模块安装的位置：项目目录\node_modules
#安装会自动在项目目录下添加 package-lock.json文件，这个文件帮助锁定安装包的版本
#同时package.json 文件中，依赖包会被添加到dependencies节点下，类似maven中的 <dependencies>
npm install jquery
#npm管理的项目在备份和传输的时候一般不携带node_modules文件夹
npm install #根据package.json中的配置下载依赖，初始化项目
#如果安装时想指定特定的版本
npm install jquery@2.1.x
```

## 模块化开发

### 模块化简介 

#### 模块化产生的背景

随着网站逐渐变成"互联网应用程序"，嵌入网页的Javascript代码越来越庞大，越来越复杂。

![image-20220222094939898](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305152119986.png)

> Javascript模块化编程，已经成为一个迫切的需求。理想情况下，开发者只需要实现核心的业务逻辑，其他都可以加载别人已经写好的模块。但是，Javascript不是一种模块化编程语言，它不支持"类"（class），包（package）等概念，更遑论"模块"（module）了。
>

#### 什么是模块化开发

传统非模块化开发有如下的缺点：

- 命名冲突
- 文件依赖

模块化规范：

- CommonJS模块化规范

- ES6模块化规范


### ES6模块化写法（一）

每个文件就是一个模块，有自己作用域。在一个文件里定义的变量、函数、类，都是私有的，对其他文件不可见。ES6使用 export 和 import 来导出、导入模块。

#### 导出模块

创建 src/userApi.js

```javascript
export function getList() {
    console.log('获取数据列表')
}

export function save() {
    console.log('保存数据')
}
```

#### 导入模块

创建 src/userComponent.js

```javascript
//只取需要的方法即可，多个方法用逗号分隔
import { getList, save } from "./userApi.js"
getList()
save()
```

**注意：这时程序无法运行，因为ES6的模块化无法在Node.js中执行，需要用Babel编辑成ES5后再执行。**

#### 安装Babel

Babel是一个广泛使用的转码器，可以将ES6代码转为ES5代码，从而在现有环境执行执行

**安装命令行转码工具**

Babel提供babel-cli工具，用于命令行转码。它的安装命令如下：

```shell
npm install --global babel-cli
#查看是否安装成功
babel --version
```

#### 配置.babelrc

Babel的配置文件是.babelrc，存放在项目的根目录下，该文件用来设置转码规则和插件，presets字段设定转码规则，将es2015规则加入 .babelrc：

```javascript
{
    "presets": ["es2015"],
    "plugins": []
}
```

#### 安装转码器

在项目中安装

```shell
npm install --save-dev babel-preset-es2015
```

#### 转码

```shell
# 整个目录转码
mkdir dist1
# --out-dir 或 -d 参数指定输出目录
babel src -d dist1
```

#### 运行程序 

```shell
node dist1/userComponent.js
```

### ES6模块化写法（二）

#### 导出模块

创建 es6/userApi2.js

```javascript
export default {
    getList() {
        console.log('获取数据列表2')
    },
    save() {
        console.log('保存数据2')
    }
}
```

#### 导入模块

创建 es6/userComponent2.js

```javascript
import user from "./userApi2.js"
user.getList()
user.save()
```

#### 转码

```shell
# 整个目录转码
mkdir dist2
# --out-dir 或 -d 参数指定输出目录
babel es6 -d dist2
```

#### 运行程序 

```shell
node dist2/userComponent2.js
```

# 角色管理前端

## 前端框架

### vue-element-admin 

vue-element-admin是基于element-ui 的一套后台管理系统集成方案。

> 功能https://panjiachen.github.io/vue-element-admin-site/zh/guide/#功能
>
> **GitHub地址：**https://github.com/PanJiaChen/vue-element-admin
>
> **项目在线预览：**https://panjiachen.gitee.io/vue-element-admin

### vue-admin-template⭐

> vue-admin-template是基于vue-element-admin的一套后台管理系统基础模板（最少精简版），可作为模板二次开发
>

> **GitHub地址：**https://github.com/PanJiaChen/vue-admin-template

> **建议：**你可以在 `vue-admin-template` 的基础上进行二次开发，把 `vue-element-admin`当做工具箱，想要什么功能或者组件就去 `vue-element-admin` 那里复制过来。

#### 安装

```sh
# 拉取并修改项目名称 vue-admin-template 改为 guigu-auth-ui
git clone https://github.com/PanJiaChen/vue-admin-template.git guigu-auth-ui
cd guigu-auth-ui
# 安装依赖
# 经过下面的配置，以后所有的 npm install 都会经过淘宝的镜像地址下载
npm config set registry https://registry.npm.taobao.org 
# 查看npm配置信息
npm config list
npm install
# 启动。执行后，浏览器自动弹出并访问:9528/
npm run dev
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305161636337.png" alt="image-20230516163644232" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305161636725.png" alt="image-20230516163657609" style="zoom:80%;" />

#### 源码目录结构

```sh
|-dist 生产环境打包生成的打包项目
|-mock 使用mockjs来mock接口
|-public 包含会被自动打包到项目根路径的文件夹
	|-index.html 唯一的页面
|-src
	|-api 包含接口请求函数模块
		|-table.js  表格列表mock数据接口的请求函数
		|-user.js  用户登陆相关mock数据接口的请求函数
	|-assets 组件中需要使用的公用资源
		|-404_images 404页面的图片
	|-components 非路由组件
		|-SvgIcon svg图标组件
		|-Breadcrumb 面包屑组件(头部水平方向的层级组件)
		|-Hamburger 用来点击切换左侧菜单导航的图标组件
	|-icons
		|-svg 包含一些svg图片文件
		|-index.js 全局注册SvgIcon组件,加载所有svg图片并暴露所有svg文件名的数组
	|-layout
		|-components 组成整体布局的一些子组件
		|-mixin 组件中可复用的代码
		|-index.vue 后台管理的整体界面布局组件
	|-router
		|-index.js 路由器
	|-store
		|-modules
			|-app.js 管理应用相关数据
			|-settings.js 管理设置相关数据
			|-user.js 管理后台登陆用户相关数据
		|-getters.js 提供子模块相关数据的getters计算属性
		|-index.js vuex的store
	|-styles
		|-xxx.scss 项目组件需要使用的一些样式(使用scss)
	|-utils 一些工具函数
		|-auth.js 操作登陆用户的token cookie
		|-get-page-title.js 得到要显示的网页title
		|-request.js axios二次封装的模块
		|-validate.js 检验相关工具函数
		|-index.js 日期和请求参数处理相关工具函数
	|-views 路由组件文件夹
		|-dashboard 首页
		|-login 登陆
	|-App.vue 应用根组件
	|-main.js 入口js
	|-permission.js 使用全局守卫实现路由权限控制的模块
	|-settings.js 包含应用设置信息的模块
|-.env.development 指定了开发环境的代理服务器前缀路径
|-.env.production 指定了生产环境的代理服务器前缀路径
|-.eslintignore eslint的忽略配置
|-.eslintrc.js eslint的检查配置
|-.gitignore git的忽略配置
|-.npmrc 指定npm的淘宝镜像和sass的下载地址
|-babel.config.js babel的配置
|-jsconfig.json 用于vscode引入路径提示的配置
|-package.json 当前项目包信息
|-package-lock.json 当前项目依赖的第三方包的精确信息
|-vite.config.js webpack相关配置(如: 代理服务器)
```

## 登录&退出登录⭐

### views/login/index.vue

更改页面标题

```vue
<div class="title-container">
  <h3 class="title">硅谷通用权限系统</h3>
</div>
```

### vite.config.js

> - 注释掉mock接口配置，配置代理转发请求到目标接口
> - 在vue.config.js的devServer代码块中，注释掉before: require('./mock/mock-server.js')，在其后面加上下面即可
> - 在.env_development文件中配置了VUE_APP_BASE_API= '/dev-api'，因此所有请求均带有/dev-api，如下

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305161648944.png" alt="image-20230516164822864" style="zoom:80%;" />

```js
// before: require('./mock/mock-server.js')
proxy: {
  '/dev-api': { // 匹配所有以 '/dev-api'开头的请求路径
    target: ':8800', // 匹配到路径进行转发，将:9528/dev-api/替换它
    changeOrigin: true, // 支持跨域
    pathRewrite: { // 重写路径: 去掉路径中开头的'/dev-api'
      '^/dev-api': ''
    }
  }
}
```

### utils/request.js

> 将响应状态码由20000改成后端的200
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305161703494.png" alt="image-20230516170352417" style="zoom:80%;" />

### api/user.js

> 修改称访问后端路径

```js
import request from '@/utils/request'

export function login(data) {
  return request({
    url: '/admin/system/index/login',
    method: 'post',
    data
  })
}

export function getInfo(token) {
  return request({
    url: '/admin/system/index/info',
    method: 'get',
    params: { token }
  })
}

export function logout() {
  return request({
    url: '/admin/system/index/logout',
    method: 'post'
  })
}
```

### 后端接口

> service-oa模块：src/main/java/com/atguigu/auth/controller/IndexController.java

> 是根据网络请求的响应来看如何写的

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305161700276.png" alt="image-20230516170049189" style="zoom:80%;" />

```java
// 后台登录登出
@Api(tags = "后台登录管理")
@RestController
@RequestMapping("/admin/system/index")
public class IndexController {

    // 登录
    @PostMapping("login")
    public Result login() {
        Map<String, Object> map = new HashMap<>();
        map.put("token","admin-token");
        return Result.ok(map);
    }
    
    // 获取用户信息
    @GetMapping("info")
    public Result info() {
        Map<String, Object> map = new HashMap<>();
        map.put("roles","[admin]");
        map.put("name","admin");
        map.put("avatar","https://oss.aliyuncs.com/aliyun_id_photo_bucket/default_handsome.jpg");
        return Result.ok(map);
    }
    // 退出
    @PostMapping("logout")
    public Result logout(){
        return Result.ok();
    }
}
```

### 测试登录 & 登出

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305161712510.png" alt="image-20230516171201429" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305161707492.png" alt="image-20230516170723407" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305161708879.png" alt="image-20230516170801790" style="zoom:80%;" />

## 角色列表

### 创建页面并修改路由

> 在src/views文件夹下创建以下文件夹和文件
>
> **创建文件夹：system/sysRole,创建文件：list.vue**

```vue
<template>
  <div class="app-container">
    角色列表
  </div>
</template>
```

> **修改 src/router/index.js 文件，添加路由constantRoutes**

```js
{
  path: '/system',
  component: Layout,
  meta: {
    title: '系统管理',
    icon: 'el-icon-s-tools'
  },
  alwaysShow: true,
  children: [
    {
      path: 'sysRole',
      component: () => import('@/views/system/sysRole/list'),
      meta: {
        title: '角色管理',
        icon: 'el-icon-s-help'
      }
    }
  ]
},
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305162008398.png" alt="image-20230516200817308" style="zoom:80%;" />

### 网络请求

> **角色管理相关的API请求函数，创建文件 src/api/system/sysRole.js**

```js
import request from '@/utils/request'
// 将前缀路径抽取出来
const api_name = '/admin/system/sysRole'
export default {
   // 获取角色分页列表(带搜索)
   getPageList(page, limit, searchObj) {
      return request({
          url: `${api_name}/${page}/${limit}`,
          method: 'get',
          // 如果普通对象参数写法，params:对象参数名称
          // 如果使用json格式传递，data:对象参数名称，区别在于用没用@RequestBody
          params: searchObj
      })
   }
}
```

### 初始化vue组件

> **src/views/system/sysRole/list.vue**

```vue
<template>
  <div class="app-container">
    角色列表
  </div>
</template>
<script>
// 引入网络请求接口的API文件
import api from '@/api/system/sysRole'
export default {
  // 定义数据模型
  data() {
    return {
    }
  },
  // 页面渲染成功后获取数据
  created() {
    this.fetchData()
  },
  // 定义方法
  methods: {
    fetchData() {
    }
  }
}
</script>
```

### 定义data

```js
// 定义数据模型
data() {
  return {
    list: [], // 列表数据
    total: 0, // 总记录数
    page: 1, // 页码
    limit: 2, // 每页记录数
    searchObj: {}, // 查询条件
    multipleSelection: []// 批量删除选中的记录列表
  }
},
```

### 定义methods

```js
methods: {
  fetchData(current=1) {
    this.page = current
    // 调用api，参数分别是当前页，每页记录数，搜索条件
    api.getPageList(this.page, this.limit, this.searchObj).then(response => {
      this.list = response.data.records
      this.total = response.data.total
    })
  },
}
```

### 表格渲染

```scss
<template>
  <div class="app-container">
    <!-- 表格 -->
    <el-table
      :data="list"
      stripe
      border
      style="width: 100%;margin-top: 10px;"
      >
      <el-table-column type="selection"/>
      <el-table-column
        label="序号"
        width="70"
        align="center">
        <template slot-scope="scope">
          {{ (page - 1) * limit + scope.$index + 1 }}
        </template>
      </el-table-column>
      <el-table-column prop="roleName" label="角色名称" />
      <el-table-column prop="roleCode" label="角色编码" />
      <el-table-column prop="createTime" label="创建时间" width="160"/>
      <el-table-column label="操作" width="200" align="center">
        <template slot-scope="scope">
          <el-button type="primary" icon="el-icon-edit" size="mini"
                     @click="edit(scope.row.id)" title="修改"/>
          <el-button type="danger" icon="el-icon-delete" size="mini"
                     @click="removeDataById(scope.row.id)" title="删除"/>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305162041495.png" alt="image-20230516204137401" style="zoom:80%;" />

### 分页组件

```vue
<!-- 分页组件 -->
<el-pagination
  @size-change="handleSizeChange"
  :current-page="page"
  :total="total"
  :page-size="limit"
  :page-sizes="[1, 2, 3, 4]"
  style="padding: 30px 0; text-align: center;"
  layout="total, sizes, prev, pager, next, jumper"
  @current-change="fetchData"/>
```

```js
// 定义方法
methods: {
  fetchData(current=1) {
    this.page = current
    // 调用api
    api.getPageList(this.page, this.limit, this.searchObj).then(response => {
      this.list = response.data.records
      this.total = response.data.total
    })
  },
  // 让每页显示数据可调整，注意最后要this.fetchData()重新获取数据
  handleSizeChange(val) {
    console.log(`每页 ${val} 条`);
    this.limit = val
    this.fetchData()
  },
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305162042623.png" alt="image-20230516204243549" style="zoom:80%;" />

### 顶部查询表单

```html
<!--查询表单-->
<div class="search-div">
  <el-form label-width="70px" size="small">
    <el-row>
      <el-col :span="24">
        <el-form-item label="角色名称">
          <el-input style="width: 100%" v-model="searchObj.roleName"
                    placeholder="角色名称"></el-input>
        </el-form-item>
      </el-col>
    </el-row>
    <el-row style="display:flex">
      <el-button type="primary" icon="el-icon-search" size="mini"
                 @click="fetchData()">搜索</el-button>
      <el-button icon="el-icon-refresh" size="mini" @click="resetData">重置</el-button>
    </el-row>
  </el-form>
</div>
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305162042742.png" alt="image-20230516204230669" style="zoom:80%;" />

分页和清空方法

```js
// 重置表单
resetData() {
    console.log('重置查询表单')
    this.searchObj = {}
    this.fetchData()
}
```

## 角色删除

### 网络请求

> **src/api/system/sysRole.js**

```js
removeById(id) {
  return request({
    url: `${api_name}/remove/${id}`,
    method: 'delete'
  })
}
```

### 定义methods

> **src/views/system/sysRole/list.vue**，使用MessageBox 弹框组件

```js
// 根据id删除数据
removeDataById(id) {
    // debugger
    this.$confirm('此操作将永久删除该记录, 是否继续?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
    }).then(() => { // promise
        // 点击确定，远程调用ajax
        return api.removeById(id)
    }).then((response) => {
        this.fetchData(this.page)
        this.$message.success(response.message || '删除成功')
    })
},
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305162056284.png" alt="image-20230516205653198" style="zoom:80%;" />

## 角色添加

### 定义api

>  **src/api/system/sysRole.js**
>

```js
save(role) {
  return request({
    url: `${api_name}/save`,
    method: 'post',
    data: role
  })
}
```

### 定义data

```js
export default {
  // 定义数据模型
  data() {
    return {
      ...
      // 添加所需字段
      dialogVisible: false,
      sysRole: {},
      saveBtnDisabled: false
    }
  },
}
```

### 定义添加按钮

> **src/views/system/sysRole/list.vue**，表格上面添加按钮，就和搜索按钮放在一起

```vue
<el-row style="display:flex;justify-content: flex-start">
  <el-button type="primary" icon="el-icon-search" size="mini"@click="fetchData()">搜索</el-button>
  <el-button icon="el-icon-refresh" size="mini" @click="resetData">重置</el-button>
  <el-button type="success" icon="el-icon-plus" size="mini" @click="add">添 加</el-button>
</el-row>
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305162103540.png" alt="image-20230516210321460" style="zoom:80%;" />

### 定义弹出层

> **src/views/system/sysRole/list.vue**，表格最下面添加弹出层

```vue
<el-dialog title="添加/修改" :visible.sync="dialogVisible" width="40%" >
  <el-form ref="dataForm" :model="sysRole" label-width="150px" size="small" 
           style="padding-right: 40px;">
    <el-form-item label="角色名称">
      <el-input v-model="sysRole.roleName"/>
    </el-form-item>
    <el-form-item label="角色编码">
      <el-input v-model="sysRole.roleCode"/>
    </el-form-item>
  </el-form>
  <span slot="footer" class="dialog-footer">
    <el-button @click="dialogVisible = false" size="small" 
               icon="el-icon-refresh-right">取 消</el-button>
    <el-button type="primary" icon="el-icon-check" @click="saveOrUpdate()" 
               size="small">确 定</el-button>
  </span>
</el-dialog>
```

### 实现功能

```js
// 点击添加按钮，打开模态框
add(){
  this.dialogVisible = true
},
// 这个方法是填完模态框信息后的确定按钮事件
// 根据sysRole对象是否有id判断是添加还是修改
// 因为更新会回显数据，此时会查当前id值，而添加是新的，没有id，只有对应的字段
saveOrUpdate() {
  this.saveBtnDisabled = true // 防止表单重复提交
  if (!this.sysRole.id) {
    this.saveData()
  } else {
    this.updateData()
  }
},

// 新增
saveData() {
  api.save(this.sysRole).then(response => {
    this.$message.success(response.message || '操作成功')
    this.dialogVisible = false
    this.fetchData(this.page)
  })
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305162105522.png" alt="image-20230516210534431" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305162107299.png" alt="image-20230516210757207" style="zoom:80%;" />

## 角色修改与数据回显

### 网络请求

>  **src/api/system/sysRole.js**
>

```js
// 根据id进行查询，数据回显
getById(id) {
  return request({
    url: `${api_name}/get/${id}`,
    method: 'get'
  })
},
// 更新数据
updateById(role) {
  return request({
    url: `${api_name}/update`,
    method: 'put',
    data: role
  })
}
```

### 定义methods

> **methods中定义fetchDataById**

```js
// 显示弹框，并根据id查询数据
edit(id) {
  this.dialogVisible = true
  this.fetchDataById(id)
},
// 根据id进行查询数据，将数据保存到sysRole对象中
fetchDataById(id) {
  api.getById(id).then(response => {
    this.sysRole = response.data
  })
}
// 更新数据，关闭弹框，重新查询显示数据
updateData() {
  api.updateById(this.sysRole).then(response => {
    this.$message.success(response.message || '操作成功')
    this.dialogVisible = false
    this.fetchData(this.page)
  })
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305162111954.png" alt="image-20230516211129865" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305162111900.png" alt="image-20230516211141812" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305162111903.png" alt="image-20230516211156819" style="zoom:80%;" />

## 批量删除

### 网络请求

>  **src/api/system/sysRole.js**
>

```js
batchRemove(idList) {
  return request({
    url: `${api_name}/batchRemove`,
    method: `delete`,
    data: idList
  })
},
```

### 初始化组件

> **src/views/system/sysRole/list.vue**，在table组件上添加 **批量删除 按钮**

```vue
<!-- 工具条 -->
<div class="tools-div">
  <el-button type="success" icon="el-icon-plus" size="mini" @click="add">添 加</el-button>
  <el-button class="btn-add" size="mini" @click="batchRemove()" >批量删除</el-button>
</div>
```

> **在table组件上添加复选框**

```vue
<el-table
  v-loading="listLoading"
  :data="list"
  stripe
  border
  style="width: 100%;margin-top: 10px;"
  # 下面这行也要加上
  @selection-change="handleSelectionChange">
  <!--复选框写在表格的第一行即可-->
  <el-table-column type="selection"/>
```

### 实现功能

> **data定义数据**

```js
multipleSelection: []// 批量删除选中的记录列表
```

> **完善方法**

```js
// 当多选选项发生变化的时候调用
handleSelectionChange(selection) {
   console.log(selection)
   this.multipleSelection = selection
},
// 批量删除
batchRemove() {
  if (this.multipleSelection.length === 0) {
     this.$message.warning('请选择要删除的记录！')
     return
  }
  this.$confirm('此操作将永久删除该记录, 是否继续?', '提示', {
    confirmButtonText: '确定',
    cancelButtonText: '取消',
    type: 'warning'
  }).then(() => {
    // 点击确定，远程调用ajax
    // 遍历selection，将id取出放入id列表
    var idList = []
    this.multipleSelection.forEach(item => {
      idList.push(item.id)
    })
    // 调用api
    return api.batchRemove(idList)
  }).then((response) => {
    this.fetchData()
    this.$message.success(response.message)
  })
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305162130901.png" alt="image-20230516213004803" style="zoom:80%;" />



# 用户管理

## 用户管理

### 用户和角色关系

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305171042976.png" alt="image-20230517104231868" style="zoom:80%;" />

### 数据库表

#### 角色表

> 前面已经创建，就是前面的角色管理

```sql
create table `sys_role` (
  `id` bigint(20) not null auto_increment comment '角色id',
  `role_name` varchar(20) not null default '' comment '角色名称',
  `role_code` varchar(20) default null comment '角色编码',
  `description` varchar(255) default null comment '描述',
  `create_time` timestamp not null default current_timestamp comment '创建时间',
  `update_time` timestamp not null default current_timestamp on update 
    current_timestamp comment '更新时间',
  `is_deleted` tinyint(3) not null default '0' comment '删除标记（0:不可用 1:可用）',
  primary key (`id`)
) engine=innodb auto_increment=1 default charset=utf8 comment='角色';
```

```sql
insert into `sys_role` values
(1,'系统管理员','system','系统管理员','2021-05-31 18:09:18','2022-06-08 09:21:10',0),
(2,'普通管理员','common','普通管理员','2021-06-01 08:38:40','2022-02-24 10:42:46',0),
(3,'用户管理员','yhgly',null,'2022-06-08 17:39:04','2022-06-08 17:39:04',0);
```

#### 用户表

```sql
create table `sys_user` (
  `id` bigint(20) not null auto_increment comment '会员id',
  `username` varchar(20) not null default '' comment '用户名',
  `password` varchar(32) not null default '' comment '密码',
  `name` varchar(50) default null comment '姓名',
  `phone` varchar(11) default null comment '手机',
  `head_url` varchar(200) default null comment '头像地址',
  `dept_id` bigint(20) default null comment '部门id',
  `post_id` bigint(20) default null comment '岗位id',
  `open_id` varchar(255) default null comment '微信openid',
  `description` varchar(255) default null comment '描述',
  `status` tinyint(3) default null comment '状态（1：正常 0：停用）',
  `create_time` timestamp not null default current_timestamp comment '创建时间',
  `update_time` timestamp not null default current_timestamp on update 
  current_timestamp comment '更新时间',
  `is_deleted` tinyint(3) not null default '0' comment '删除标记（0:不可用 1:可用）',
  primary key (`id`),
  unique key `idx_username` (`username`)
) engine=innodb auto_increment=1 default charset=utf8mb4 comment='用户表';
```

```sql
insert into `sys_user` values
(1,'admin','96e79218','admin','15000000000','',1022,null,'',null,1,'2021-05-31 18:08:43','2022-12-13 14:52:31',0),
(2,'wjl','96e79218965eb72c92a549dd5a330112','王经理','15000000002','',1022,6,'',null,1,'2022-02-08 10:35:38','2022-12-22 10:05:03',0),
(3,'lrsjl','96e79218965eb72c92a549dd5a330112','李人事经理','15000000004',null,2018,5,'',null,1,'2022-05-24 11:05:40','2022-12-22 10:05:21',0),
(4,'lisi','96e79218965eb72c92a549dd5a330112','李四','15000000001',null,1021,10,'omwf25izkon9dktgoy0dogqvnghk',null,1,'2022-12-06 09:32:31','2022-12-21 09:25:06',0),
(5,'zzjl','96e79218965eb72c92a549dd5a330112','张总经理','15000000003',null,10,8,'',null,1,'2022-12-07 16:47:00','2022-12-22 10:05:07',0),
(6,'xkfzr','96e79218965eb72c92a549dd5a330112','张学科','15000000005',null,1010,11,null,null,1,'2022-12-14 09:18:12','2022-12-14 09:18:12',0),
(7,'zhangsan','96e79218965eb72c92a549dd5a330112','张三','15000000006',null,1021,10,null,null,1,'2022-12-26 11:26:45','2022-12-27 09:11:37',0),
(11,'zhangsan01','96e79218965eb72c92a549dd5a330112','张三01','15000000007',null,1021,10,null,null,1,'2022-12-26 11:27:33','2022-12-27 09:11:38',0),
(12,'zhangsan02','96e79218965eb72c92a549dd5a330112','张三02','15000000008',null,1021,10,null,null,1,'2022-12-26 11:27:39','2022-12-27 09:11:39',0);
```

#### 关系表

```sql
create table `sys_user_role` (
  `id` bigint(20) not null auto_increment comment '主键id',
  `role_id` bigint(20) not null default '0' comment '角色id',
  `user_id` bigint(20) not null default '0' comment '用户id',
  `create_time` timestamp not null default current_timestamp comment '创建时间',
  `update_time` timestamp not null default current_timestamp on update 
   current_timestamp comment '更新时间',
  `is_deleted` tinyint(3) not null default '0' comment '删除标记（0:不可用 1:可用）',
  primary key (`id`),
  key `idx_role_id` (`role_id`),
  key `idx_admin_id` (`user_id`)
) engine=innodb auto_increment=1 default charset=utf8 comment='用户角色';
```

```sql
insert into `sys_user_role` values
(2,2,2,'2022-01-20 20:49:37','2022-02-24 10:43:07',0),
(3,1,1,'2022-05-19 10:37:27','2022-05-24 16:55:53',1),
(4,2,1,'2022-05-19 10:37:27','2022-05-24 16:55:53',1),
(5,1,1,'2022-05-24 16:55:53','2022-05-24 16:55:53',0),
(6,2,3,'2022-05-25 16:09:31','2022-05-25 16:09:31',0),
(7,2,4,'2022-06-02 11:08:14','2022-06-02 11:15:36',1),
(8,2,4,'2022-06-02 11:15:36','2022-06-02 16:10:53',1),
(9,1,4,'2022-06-02 11:15:36','2022-06-02 16:10:53',1),
(10,1,4,'2022-06-02 16:10:53','2022-06-02 16:10:53',0);
```

### 代码生成

#### 实体类

> 已经在model模块的system文件夹中创建

```java
@Data
@ApiModel(description = "用户")
@TableName("sys_user")
public class SysUser extends BaseEntity {
   
   private static final long serialVersionUID = 1L;

   @ApiModelProperty(value = "用户名")
   @TableField("username")
   private String username;

   @ApiModelProperty(value = "密码")
   @TableField("password")
   private String password;

   @ApiModelProperty(value = "姓名")
   @TableField("name")
   private String name;

   @ApiModelProperty(value = "手机")
   @TableField("phone")
   private String phone;

   @ApiModelProperty(value = "头像地址")
   @TableField("head_url")
   private String headUrl;

   @ApiModelProperty(value = "部门id")
   @TableField("dept_id")
   private Long deptId;

   @ApiModelProperty(value = "岗位id")
   @TableField("post_id")
   private Long postId;

   @ApiModelProperty(value = "描述")
   @TableField("description")
   private String description;

   @ApiModelProperty(value = "openId")
   @TableField("open_id")
   private String openId;

   @ApiModelProperty(value = "状态（1：正常 0：停用）")
   @TableField("status")
   private Integer status;
   // 用户被分配的角色，重要
   @TableField(exist = false)
   private List<SysRole> roleList;
   //岗位
   @TableField(exist = false)
   private String postName;
   //部门
   @TableField(exist = false)
   private String deptName;
}
```

> 下面开始在service-oa中操作

#### 代码生成器⭐

> 依赖引入

```xml
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-generator</artifactId>
    <version>3.4.1</version>
</dependency>

<dependency>
    <groupId>org.apache.velocity</groupId>
    <artifactId>velocity-engine-core</artifactId>
    <version>2.0</version>
</dependency>
```

> 在service-oa中创建src/test/java/com/atguigu/auth/CodeGet.java

```java
public class CodeGet {

    public static void main(String[] args) {

        // 1、创建代码生成器
        AutoGenerator mpg = new AutoGenerator();

        // 2、全局配置
        GlobalConfig gc = new GlobalConfig();
        gc.setOutputDir("D:\\SpringBoot新项目\\guigu-oa-parent\\service-oa"+"/src/main/java");
        gc.setServiceName("%sService"); //去掉Service接口的首字母I，因为生成器会自动加I,所以要去掉
        gc.setAuthor("renshuo"); // 设置作者
        gc.setOpen(false); // 设置目录是否展开，没啥用
        mpg.setGlobalConfig(gc);

        // 3、数据源配置
        DataSourceConfig dsc = new DataSourceConfig();
        dsc.setUrl("jdbc:mysql://localhost:3306/guigu-oa?serverTimezone=GMT%2B8&useSSL=false");
        dsc.setDriverName("com.mysql.cj.jdbc.Driver");
        dsc.setUsername("root");
        dsc.setPassword("123456");
        dsc.setDbType(DbType.MYSQL);
        mpg.setDataSource(dsc);

        // 4、包配置
        PackageConfig pc = new PackageConfig();
        pc.setParent("com.atguigu.auth");
        // pc.setModuleName("auth"); //模块名，这个不设置也行
        pc.setController("controller");
        pc.setService("service");
        pc.setMapper("mapper");
        mpg.setPackageInfo(pc);

        // 5、策略配置
        StrategyConfig strategy = new StrategyConfig();
        strategy.setInclude("sys_user");
        //数据库表映射到实体的命名策略
        strategy.setNaming(NamingStrategy.underline_to_camel);
        //数据库表字段映射到实体的命名策略
        strategy.setColumnNaming(NamingStrategy.underline_to_camel);
        // lombok 模型 @Accessors(chain = true) setter链式操作
        strategy.setEntityLombokModel(true); 
        strategy.setRestControllerStyle(true); //restful api风格控制器
        strategy.setControllerMappingHyphenStyle(true); //url中驼峰转连字符
        mpg.setStrategy(strategy);

        // 6、执行
        mpg.execute();
    }
}
```

> 点击执行，生成完成

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305171105998.png" alt="image-20230517110537899" style="zoom:80%;" />

> 删除entity包，并修改service和mapper的实体类引入成model模块内部的包

#### 手动创建

> 如果不想使用代码生成器，可以手动创建

##### Mapper

```java
package com.atguigu.auth.mapper;

public interface SysUserMapper extends BaseMapper<SysUser> {

}
```

##### service接口

> **SysUserService接口**

```java
package com.atguigu.system.service;

public interface SysUserService extends IService<SysUser> {

}
```

##### service接口实现

> **SysUserServiceImpl实现**

```java
package com.atguigu.system.service.impl;

@Service
public class SysUserServiceImpl extends ServiceImpl<SysUserMapper, SysUser> 
    implements SysUserService {

}
```

### 接口实现⭐

> package com.atguigu.auth.controller

#### 基本结构

```java
@Api(tags = "用户管理")
@RestController
@RequestMapping("/admin/system/sysUser")
public class SysUserController {

    @Autowired
    private SysUserService service;

}
```

#### 条件分页

```java
//用户条件分页查询
@ApiOperation("用户条件分页查询")
@GetMapping("{page}/{limit}")
public Result index(@PathVariable Long page,
                    @PathVariable Long limit,
                    SysUserQueryVo sysUserQueryVo) {
    //创建page对象
    Page<SysUser> pageParam = new Page<>(page,limit);

    //封装条件，判断条件值不为空
    LambdaQueryWrapper<SysUser> wrapper = new LambdaQueryWrapper<>();
    //获取条件值
    String username = sysUserQueryVo.getKeyword();
    String createTimeBegin = sysUserQueryVo.getCreateTimeBegin();
    String createTimeEnd = sysUserQueryVo.getCreateTimeEnd();
    //判断条件值不为空
    //like 模糊查询
    if(!StringUtils.isEmpty(username)) {
        wrapper.like(SysUser::getUsername,username);
    }
    //ge 大于等于
    if(!StringUtils.isEmpty(createTimeBegin)) {
        wrapper.ge(SysUser::getCreateTime,createTimeBegin);
    }
    //le 小于等于
    if(!StringUtils.isEmpty(createTimeEnd)) {
        wrapper.le(SysUser::getCreateTime,createTimeEnd);
    }
    //调用mp的方法实现条件分页查询
    IPage<SysUser> pageModel = service.page(pageParam, wrapper);
    return Result.ok(pageModel);
}
```

#### 根据ID获取

```java
@ApiOperation(value = "获取用户")
@GetMapping("get/{id}")
public Result get(@PathVariable Long id) {
    SysRole role = service.getById(id);
    return Result.ok(role);
}
```

#### 新增用户

```java
@ApiOperation(value = "新增用户")
@PostMapping("save")
public Result save(@RequestBody SysUser user) {
    boolean is_success = service.save(role);
    if (is_success) {
        return Result.ok();
    } else {
        return Result.fail();
    }
}
```

#### 修改用户



```java
@ApiOperation(value = "修改用户)
@PutMapping("update")
public Result updateById(@RequestBody SysUser user) {
    boolean is_success = service.updateById(role);
    if (is_success) {
        return Result.ok();
    } else {
        return Result.fail();
    }
}
```

#### 删除用户

```java
@ApiOperation(value = "删除用户")
@DeleteMapping("remove/{id}")
public Result remove(@PathVariable Long id) {
    boolean is_success = service.removeById(id);
    if (is_success) {
        return Result.ok();
    } else {
        return Result.fail();
    }
}
```

#### knife4j测试

:8800/doc.html

![image-20220602095058457](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305152120132.png)

### 前端实现⭐

#### 添加路由

> 新建vue文件：**src/views/system/sysUser/list.vue**

```vue
<template>
   <div>
     321
   </div>
</template>
```

> **修改 src/router/index.js 文件，添加用户管理的路由**

```js
{
  path: '/system',
  component: Layout,
  meta: {
    title: '系统管理',
    icon: 'el-icon-s-tools'
  },
  alwaysShow: true,
  children: [
    {
      name: 'sysUser',
      path: 'sysUser',
      component: () => import('@/views/system/sysUser/list'),
      meta: {
        title: '用户管理',
        icon: 'el-icon-s-custom'
      },
    },
    {
      path: 'sysRole',
      component: () => import('@/views/system/sysRole/list'),
      meta: {
        title: '角色管理',
        icon: 'el-icon-s-help'
      },
    }
  ]
},
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305171426900.png" alt="image-20230517142609792" style="zoom:80%;" />

#### 网络请求

> **创建文件 src/api/system/sysUser.js**

```js
import request from '@/utils/request'

const api_name = '/admin/system/sysUser'

export default {

  getPageList(page, limit, searchObj) {
    return request({
      url: `${api_name}/${page}/${limit}`,
      method: 'get',
      params: searchObj // url查询字符串或表单键值对
    })
  },
  getById(id) {
    return request({
      url: `${api_name}/get/${id}`,
      method: 'get'
    })
  },

  save(role) {
    return request({
      url: `${api_name}/save`,
      method: 'post',
      data: role
    })
  },

  updateById(role) {
    return request({
      url: `${api_name}/update`,
      method: 'put',
      data: role
    })
  },
  removeById(id) {
    return request({
      url: `${api_name}/remove/${id}`,
      method: 'delete'
    })
  }
}
```

> **创建src/views/system/sysUser/list.vue**

#### 表格实现

```vue
<!-- 列表 -->
<el-table
  v-loading="listLoading"
  :data="list"
  stripe
  border
  style="width: 100%;margin-top: 10px;">
  <el-table-column
    label="序号"
    width="70"
    align="center">
    <template slot-scope="scope">
      {{ (page - 1) * limit + scope.$index + 1 }}
    </template>
  </el-table-column>

  <el-table-column prop="username" label="用户名" width="100"/>
  <el-table-column prop="name" label="姓名" width="100"/>
  <el-table-column prop="phone" label="手机" width="120"/>
  <el-table-column prop="postName" label="岗位" width="100"/>
  <el-table-column prop="deptName" label="部门" width="100"/>
  <el-table-column label="所属角色" width="130">
    <template slot-scope="scope">
      <span v-for="item in scope.row.roleList" :key="item.id" 
            style="margin-right: 10px;">{{ item.roleName }}</span>
    </template>
  </el-table-column>
  <el-table-column label="状态" width="80">
    <template slot-scope="scope">
      <el-switch
        v-model="scope.row.status === 1"
        @change="switchStatus(scope.row)">
      </el-switch>
    </template>
  </el-table-column>

  <el-table-column prop="createTime" label="创建时间"/>
  <el-table-column label="操作">
    <template slot-scope="scope">
      <el-button type="primary" icon="el-icon-edit" size="mini" 
                 @click="edit(scope.row.id)" title="修改"/>
      <el-button type="danger" icon="el-icon-delete" size="mini" 
                 @click="removeDataById(scope.row.id)" title="删除" />
    </template>
  </el-table-column>
</el-table>
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305172051979.png" alt="image-20230517205121775" style="zoom:80%;" />



#### 分页组件

```vue
<!-- 分页组件 -->
<el-pagination
  :current-page="page"
  :total="total"
  :page-size="limit"
  :page-sizes="[5, 10, 20, 30, 40, 50, 100]"
  style="padding: 30px 0; text-align: center;"
  layout="sizes, prev, pager, next, jumper, ->, total, slot"
  @current-change="fetchData"
  @size-change="changeSize"/>
```

#### 搜索栏

```vue
<div class="search-div">
  <el-form label-width="70px" size="small">
    <el-row>
      <el-col :span="8">
        <el-form-item label="关 键 字">
          <el-input style="width: 95%" v-model="searchObj.keyword"
                    placeholder="用户名/姓名/手机号码"></el-input>
        </el-form-item>
      </el-col>
      <el-col :span="8">
        <el-form-item label="操作时间">
          <el-date-picker
            v-model="createTimes"
            type="datetimerange"
            range-separator="至"
            start-placeholder="开始时间"
            end-placeholder="结束时间"
            value-format="yyyy-MM-dd HH:mm:ss"
            style="margin-right: 10px;width: 100%;"
          />
        </el-form-item>
      </el-col>
    </el-row>
    <el-row style="display:flex">
      <el-button type="primary" icon="el-icon-search" size="mini" 
                 :loading="loading" @click="fetchData()">搜索</el-button>
      <el-button icon="el-icon-refresh" size="mini" @click="resetData">重置</el-button>
    </el-row>
  </el-form>
</div>
```

#### 新增/修改弹框

```vue
<el-dialog title="添加/修改" :visible.sync="dialogVisible" width="40%" >
  <el-form ref="dataForm" :model="sysUser"  label-width="100px" size="small" 
           style="padding-right: 40px;">
    <el-form-item label="用户名" prop="username">
      <el-input v-model="sysUser.username"/>
    </el-form-item>
    <el-form-item v-if="!sysUser.id" label="密码" prop="password">
      <el-input v-model="sysUser.password" type="password"/>
    </el-form-item>
    <el-form-item label="姓名" prop="name">
      <el-input v-model="sysUser.name"/>
    </el-form-item>
    <el-form-item label="手机" prop="phone">
      <el-input v-model="sysUser.phone"/>
    </el-form-item>
  </el-form>
  <span slot="footer" class="dialog-footer">
    <el-button @click="dialogVisible = false" size="small" 
               icon="el-icon-refresh-right">取 消</el-button>
    <el-button type="primary" icon="el-icon-check" @click="saveOrUpdate()" 
               size="small">确 定</el-button>
  </span>
</el-dialog>
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305172054534.png" alt="image-20230517205443413" style="zoom:80%;" />

#### 新增用户

```vue
<!-- 工具条 -->
<div class="tools-div">
  <el-button type="success" icon="el-icon-plus" size="mini" @click="add">添 加</el-button>
</div>
```

#### 数据准备

```js
import api from '@/api/system/sysUser'
const defaultForm = {
  id: '',
  username: '',
  password: '',
  name: '',
  phone: '',
  status: 1
}
```

```js
data() {
  return {
    listLoading: true, // 数据是否正在加载
    list: null, // banner列表
    total: 0, // 数据库中的总记录数
    page: 1, // 默认页码
    limit: 10, // 每页记录数
    searchObj: {}, // 查询表单对象
    createTimes: [],
    dialogVisible: false,
    sysUser: defaultForm,
    saveBtnDisabled: false,
  }
},
```

#### 生命周期函数

```js
// 生命周期函数：内存准备完毕，页面尚未渲染
created() {
  console.log('list created......')
  this.fetchData()
},

// 生命周期函数：内存准备完毕，页面渲染成功
mounted() {
  console.log('list mounted......')
},
```

#### 分页方法

```js
// 当页码发生改变的时候
changeSize(size) {
  console.log(size)
  this.limit = size
  this.fetchData(1)
},
```

#### 列表数据方法

```js
// 加载banner列表数据
fetchData(page = 1) {
  debugger
  this.page = page
  console.log('翻页。。。' + this.page)
  if(this.createTimes && this.createTimes.length ==2) {
    this.searchObj.createTimeBegin = this.createTimes[0]
    this.searchObj.createTimeEnd = this.createTimes[1]
  }
  api.getPageList(this.page, this.limit, this.searchObj).then(
    response => {
      //this.list = response.data.list
      this.list = response.data.records
      this.total = response.data.total
      // 数据加载并绑定成功
      this.listLoading = false
    }
  )
},
```

#### 重置表单

```js
// 重置查询表单
resetData() {
  console.log('重置查询表单')
  this.searchObj = {}
  this.createTimes = []
  this.fetchData()
},
```

#### 根据id删除数据

```js
// 根据id删除数据
removeDataById(id) {
  // debugger
  this.$confirm('此操作将永久删除该记录, 是否继续?', '提示', {
    confirmButtonText: '确定',
    cancelButtonText: '取消',
    type: 'warning'
  }).then(() => { // promise
    // 点击确定，远程调用ajax
    return api.removeById(id)
  }).then((response) => {
    this.fetchData(this.page)
    this.$message.success(response.message || '删除成功')
  }).catch(() => {
    this.$message.info('取消删除')
  })
},
```

#### 新增方法

```js
add(){
  this.dialogVisible = true
  this.sysUser = Object.assign({}, defaultForm)
},
```

```js
// 新增
saveData() {
  api.save(this.sysUser).then(response => {
    this.$message.success('操作成功')
    this.dialogVisible = false
    this.fetchData(this.page)
  })
},
```

#### 修改方法

```js
edit(id) {
  this.dialogVisible = true
  this.fetchDataById(id)
},

fetchDataById(id) {
  api.getById(id).then(response => {
    this.sysUser = response.data
  })
},
```

```js
saveOrUpdate() {
  this.$refs.dataForm.validate(valid => {
    if (valid) {
      this.saveBtnDisabled = true // 防止表单重复提交
      if (!this.sysUser.id) {
        this.saveData()
      } else {
        this.updateData()
      }
    }
  })
},
```

```js
// 根据id更新记录
updateData() {
   api.updateById(this.sysUser).then(response => {
     this.$message.success(response.message || '操作成功')
     this.dialogVisible = false
     this.fetchData(this.page)
   })
 }
}
```

## 用户分配角色

### 接口分析

> 1、**进入分配页面：获取已分配角色与全部角色，进行页面展示**
>
> 2、**保存分配角色：删除之前分配的角色和保存现在分配的角色**

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305172125326.png" alt="image-20230517212544178" style="zoom:80%;" />

### 代码生成器

> 生成后，删除controller和entity，修改mapper和service的实体类地址

```java
public class CodeGet {

    public static void main(String[] args) {

        // 1、创建代码生成器
        AutoGenerator mpg = new AutoGenerator();

        // 2、全局配置
        // 全局配置
        GlobalConfig gc = new GlobalConfig();
        gc.setOutputDir("D:\\SpringBoot新项目\\guigu-oa-parent\\service-oa"+"/src/main/java");
        gc.setServiceName("%sService");    //去掉Service接口的首字母I，因为生成器会自动加I,所以要去掉
        gc.setAuthor("renshuo"); // 设置作者
        gc.setOpen(false); // 设置目录是否展开，没啥用
        mpg.setGlobalConfig(gc);

        // 3、数据源配置
        DataSourceConfig dsc = new DataSourceConfig();
        dsc.setUrl("jdbc:mysql://localhost:3306/guigu-oa?serverTimezone=GMT%2B8&useSSL=false");
        dsc.setDriverName("com.mysql.cj.jdbc.Driver");
        dsc.setUsername("root");
        dsc.setPassword("123456");
        dsc.setDbType(DbType.MYSQL);
        mpg.setDataSource(dsc);

        // 4、包配置
        PackageConfig pc = new PackageConfig();
        pc.setParent("com.atguigu.auth");
        //pc.setModuleName("auth"); //模块名
        pc.setController("controller");
        pc.setService("service");
        pc.setMapper("mapper");
        mpg.setPackageInfo(pc);

        // 5、策略配置
        StrategyConfig strategy = new StrategyConfig();
        strategy.setInclude("sys_user_role");
        //数据库表映射到实体的命名策略
        strategy.setNaming(NamingStrategy.underline_to_camel);
        //数据库表字段映射到实体的命名策略
        strategy.setColumnNaming(NamingStrategy.underline_to_camel);
        // lombok 模型 @Accessors(chain = true) setter链式操作
        strategy.setEntityLombokModel(true); 
        strategy.setRestControllerStyle(true); //restful api风格控制器
        strategy.setControllerMappingHyphenStyle(true); //url中驼峰转连字符
        mpg.setStrategy(strategy);
        // 6、执行
        mpg.execute();
    }
}
```

### controller方法

> model类中的分配菜单

```java
@ApiModel(description = "分配菜单")
@Data
public class AssginRoleVo {
    @ApiModelProperty(value = "用户id")
    private Long userId;

    @ApiModelProperty(value = "角色id列表")
    private List<Long> roleIdList;
}
```

> 操作类：SysRoleController

```java
@ApiOperation(value = "根据用户ID获取角色数据")
@GetMapping("/toAssign/{userId}")
public Result toAssign(@PathVariable Long userId) {
    // 方法是自定义方法
    Map<String, Object> roleMap = sysRoleService.findRoleDataByUserId(userId);
    return Result.ok(roleMap);
}

@ApiOperation(value = "根据用户分配角色")
@PostMapping("/doAssign") // AssginRoleVo是分配菜单
public Result doAssign(@RequestBody AssginRoleVo assginRoleVo) {
    sysRoleService.doAssign(assginRoleVo);
    return Result.ok();
}
```

> 操作类：SysUserController

```java
@Resource
private SysRoleService sysRoleService;

//用户条件分页查询
@ApiOperation("用户条件分页查询")
@GetMapping("{page}/{limit}")
public Result index(@PathVariable Long page,
                    @PathVariable Long limit,
                    SysUserQueryVo sysUserQueryVo) {
    //创建page对象
    Page<SysUser> pageParam = new Page<>(page,limit);

    //封装条件，判断条件值不为空
    LambdaQueryWrapper<SysUser> wrapper = new LambdaQueryWrapper<>();

    //获取条件值
    String username = sysUserQueryVo.getKeyword();
    String createTimeBegin = sysUserQueryVo.getCreateTimeBegin();
    String createTimeEnd = sysUserQueryVo.getCreateTimeEnd();
    //判断条件值不为空
    //like 模糊查询
    if(!StringUtils.isEmpty(username)) {
        wrapper.like(SysUser::getUsername,username);
    }
    //ge 大于等于
    if(!StringUtils.isEmpty(createTimeBegin)) {
        wrapper.ge(SysUser::getCreateTime,createTimeBegin);
    }
    //le 小于等于
    if(!StringUtils.isEmpty(createTimeEnd)) {
        wrapper.le(SysUser::getCreateTime,createTimeEnd);
    }
    // 调用mp的方法实现条件分页查询
    IPage<SysUser> pageModel = service.page(pageParam, wrapper);
    // 获取SysRoleServiceImpl的查找角色方法
    List<SysUser> records = pageModel.getRecords();
    records.forEach(item -> {
        Map<String, List<SysRole>> roleDataByUserId = sysRoleService
                                   .findRoleDataByUserId(item.getId());
        item.setRoleList(roleDataByUserId.get("assginRoleList"));
    });
    return Result.ok(pageModel);
}
```

### service接口

> 操作类：SysRoleService
>

```java
// 根据用户获取角色数据
Map<String, Object> findRoleDataByUserId(Long userId);
// 分配角色
void doAssign(AssginRoleVo assginRoleVo);
```

### service接口实现⭐

> 操作类：SysRoleServiceImpl
>

```java
@Resource
private SysUserRoleService sysUserRoleService;
```

```java
@Override
public Map<String, List<SysRole>> findRoleDataByUserId(Long userId) {
    //查询所有角色，返回list集合，返回
    List<SysRole> allRolesList = baseMapper.selectList(null);
    //根据userid查询角色用户关系表，查询userid对应所有角色id
    LambdaQueryWrapper<SysUserRole> wrapper = new LambdaQueryWrapper<>();
    wrapper.eq(SysUserRole::getUserId,userId);
    List<SysUserRole> existUserRoleList = sysUserRoleService.list(wrapper);
    // 从查询出来的用户id对应角色的list集合，获取所有角色id
    List<Long> existRoleIdList = existUserRoleList.stream()
            .map(SysUserRole::getRoleId).collect(Collectors.toList());
    // 根据查询所有角色id，找到对应角色信息，判断角色是否包含在id列表中
    List<SysRole> assginRoleList = new ArrayList<>();
    for (SysRole role : allRolesList) {
        if(existRoleIdList.contains(role.getId())) {
            assginRoleList.add(role);
        }
    }
    // 把得到的两部分数据封装到map中
    Map<String, List<SysRole>> roleMap = new HashMap<>();
    roleMap.put("assginRoleList", assginRoleList);
    roleMap.put("allRolesList", allRolesList);
    return roleMap;
}
```

```java
// 为用户分配角色
@Override
public void doAssign(AssginRoleVo assginRoleVo) {
    // 把用户之前分配角色数据删除，用户角色关系表里面，根据userid删除
    LambdaQueryWrapper<SysUserRole> wrapper = new LambdaQueryWrapper<>();
    wrapper.eq(SysUserRole::getUserId,assginRoleVo.getUserId());
    sysUserRoleService.remove(wrapper);
    // 重新进行分配
    List<Long> roleIdList = assginRoleVo.getRoleIdList();

    for(Long roleId : roleIdList) {
        if(StringUtils.isEmpty(roleId)) {
           continue;
        }
        SysUserRole userRole = new SysUserRole();
        userRole.setUserId(assginRoleVo.getUserId());
        userRole.setRoleId(roleId);
        sysUserRoleService.save(userRole);
    }
}
```

### SysUserRoleMapper类

```java
package com.atguigu.system.mapper;

import com.atguigu.model.system.SysUserRole;
import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import org.apache.ibatis.annotations.Mapper;
import org.springframework.stereotype.Repository;

@Repository
@Mapper
public interface SysUserRoleMapper extends BaseMapper<SysUserRole> {

}
```

### 前端实现

> src/api/system/sysRole.js

```js
getRoles(adminId) {
  return request({
    url: `${api_name}/toAssign/${adminId}`,
    method: 'get'
  })
},

assignRoles(assginRoleVo) {
  return request({
    url: `${api_name}/doAssign`,
    method: 'post',
    data: assginRoleVo
  })
}
```

```vue
<el-table-column label="所属角色" width="200">
  <template slot-scope="scope">
    <el-tag v-for="item in scope.row.roleList" :key="item.id"
            style="margin-left: 3px;">{{ item.roleName }}</el-tag>
  </template>
</el-table-column>
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305181443444.png" alt="image-20230518144324322" style="zoom:80%;" />

```vue
<el-table-column label="操作" width="180" align="center" fixed="right">
  <template slot-scope="scope">
    <el-button type="primary" icon="el-icon-edit" size="mini"
               @click="edit(scope.row.id)" title="修改"/>
    <el-button type="danger" icon="el-icon-delete" size="mini" 
               @click="removeDataById(scope.row.id)" title="删除" />
    <el-button type="warning" icon="el-icon-baseball" size="mini" 
               @click="showAssignRole(scope.row)" title="分配角色"/>
  </template>
</el-table-column>
```

```vue
<el-dialog title="分配角色" :visible.sync="dialogRoleVisible">
  <el-form label-width="80px">
    <el-form-item label="用户名">
      <el-input disabled :value="sysUser.username"></el-input>
    </el-form-item>

    <el-form-item label="角色列表">
      <el-checkbox :indeterminate="isIndeterminate" 
                   v-model="checkAll" @change="handleCheckAllChange">全选</el-checkbox>
      <div style="margin: 15px 0;"></div>
      <el-checkbox-group v-model="userRoleIds" @change="handleCheckedChange">
        <el-checkbox v-for="role in allRoles" :key="role.id" 
                     :label="role.id">{{role.roleName}}</el-checkbox>
      </el-checkbox-group>
    </el-form-item>
  </el-form>
  <div slot="footer">
    <el-button type="primary" @click="assignRole" size="small">保存</el-button>
    <el-button @click="dialogRoleVisible = false" size="small">取消</el-button>
  </div>
</el-dialog>
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305181441981.png" alt="image-20230518144125854" style="zoom:80%;" />

```js
const defaultForm = {
  id: '',
  username: '',
  password: '',
  name: '',
  phone: '',
  status: 1
}
export default {
  data() {
    return {
      list: null, // banner列表
      total: 0, // 数据库中的总记录数
      page: 1, // 默认页码
      limit: 10, // 每页记录数
      searchObj: {}, // 查询表单对象
      createTimes: [],
      dialogVisible: false,
      sysUser: defaultForm,
      saveBtnDisabled: false,
      dialogRoleVisible: false,
      allRoles: [], // 所有角色列表
      assginRole: [], // 角色列表
      userRoleIds: [], // 用户的角色ID的列表
      isIndeterminate: false, // 是否是不确定的
      checkAll: false // 是否全选
    }
  },
```

```js
showAssignRole (row) {
  this.sysUser = row
  this.dialogRoleVisible = true
  this.getRoles()
},
```

```js
getRoles () {
  roleApi.getRoles(this.sysUser.id).then(response => {
    const {allRolesList, assginRoleList} = response.data
    this.allRoles = allRolesList
    this.assginRole = assginRoleList
    this.userRoleIds = assginRoleList.map(item => item.id)
    this.checkAll = allRolesList.length===assginRoleList.length
    this.isIndeterminate = assginRoleList.length>0 && assginRoleList.length<allRolesList.length
  })
},
```

```js
// 全选勾选状态发生改变的监听
handleCheckAllChange (value) {// value 当前勾选状态true/false
  // 如果当前全选, userRoleIds就是所有角色id的数组, 否则是空数组
  this.userRoleIds = value ? this.allRoles.map(item => item.id) : []
  // 如果当前不是全选也不全不选时, 指定为false
  this.isIndeterminate = false
},
```

```js
// 角色列表选中项发生改变的监听
handleCheckedChange (value) {
  const {userRoleIds, allRoles} = this
  this.checkAll = userRoleIds.length === allRoles.length && allRoles.length>0
  this.isIndeterminate = userRoleIds.length>0 && userRoleIds.length<allRoles.length
},

assignRole () {
  let assginRoleVo = {
    userId: this.sysUser.id,
    roleIdList: this.userRoleIds
  }
  roleApi.assignRoles(assginRoleVo).then(response => {
    this.$message.success(response.message || '分配角色成功')
    this.dialogRoleVisible = false
    this.fetchData(this.page)
  })
},
```



## 更改用户状态

### 需求分析

> 用户状态：状态（1：正常 0：停用），当用户状态为正常时，可以访问后台系统，当用户状态停用后，不可以登录后台系统

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305181428710.png" alt="image-20230518142813509" style="zoom: 80%;" />

### controller方法

> 操作类：SysUserController
>

```java
@ApiOperation(value = "更新状态")
@GetMapping("updateStatus/{id}/{status}")
public Result updateStatus(@PathVariable Long id, @PathVariable Integer status) {
    service.updateStatus(id, status);
    return Result.ok();
}
```

### service接口

> 操作类：SysUserService
>

```java
void updateStatus(Long id, Integer status);
```

### service接口实现

> 操作类：SysUserServiceImpl
>

```java
@Transactional
@Override
public void updateStatus(Long id, Integer status) {
    SysUser sysUser = this.getById(id);
    if(status.intValue() == 1) {
        sysUser.setStatus(status);
    } else {
        sysUser.setStatus(0);
    }
    this.updateById(sysUser);
}
```

### 前端实现

#### 网络请求

> **src/api/system/sysUser.js**

```js
updateStatus(id, status) {
  return request({
    url: `${api_name}/updateStatus/${id}/${status}`,
    method: 'get'
  })
}
```

#### 页面配置

> **更改src/views/system/sysUser/list.vue**

```vue
<el-table-column label="状态" width="80">
  <template slot-scope="scope">
    <el-switch
      v-model="scope.row.status === 1"
      @change="switchStatus(scope.row)">
    </el-switch>
  </template>
</el-table-column>
```

```js
switchStatus(row) {
  row.status = row.status === 1 ? 0 : 1
  api.updateStatus(row.id, row.status).then(response => {
    if (response.code) {
      this.$message.success(response.message || '操作成功')
      this.dialogVisible = false
      this.fetchData()
    }
  })
}
```



# 菜单管理

## 菜单管理需求

### 需求描述

> 不同角色的用户登录后台管理系统拥有不同的菜单权限与功能权限，我们前端是基于：vue-admin-template这个模块开发的，因此我们菜单表设计也必须基于前端模板进行设计。前端框架vue-admin-template菜单其实就是我们配置的路由：

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305181448314.png" alt="image-20230518144809133" style="zoom:80%;" />

### 数据库表⭐

#### 菜单表

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305181456474.png" alt="image-20230518145640319" style="zoom:80%;" />

> 重点字段说明：
>
> ​	type：菜单类型，分为：目录、菜单与按钮
>
> ​				目录：一个分类（可理解为一级菜单）、目录下级节点可以为目录与菜单
>
> ​				菜单：一个具体页面，菜单的下级节点只能是按钮
>
> ​				按钮：页面上的功能
>
> ​	path：对应路由里面的路由地址path
>
> ​	component：对应路由里面的组件component
>
> ​	perms：对应菜单的功能权限标识
>
> ​	icom：对应路由的菜单图标

```sql
create table `sys_menu` (
  `id` bigint(20) not null auto_increment comment '编号',
  `parent_id` bigint(20) not null default '0' comment '所属上级',
  `name` varchar(20) not null default '' comment '名称',
  `type` tinyint(3) not null default '0' comment '类型(0:目录,1:菜单,2:按钮)',
  `path` varchar(100) default null comment '路由地址',
  `component` varchar(100) default null comment '组件路径',
  `perms` varchar(100) default null comment '权限标识',
  `icon` varchar(100) default null comment '图标',
  `sort_value` int(11) default null comment '排序',
  `status` tinyint(4) default null comment '状态(0:禁止,1:正常)',
  `create_time` timestamp not null default current_timestamp comment '创建时间',
  `update_time` timestamp not null default current_timestamp on update 
   current_timestamp comment '更新时间',
  `is_deleted` tinyint(3) not null default '0' comment '删除标记（0:不可用 1:可用）',
  primary key (`id`),
  key `idx_parent_id` (`parent_id`)
) engine=innodb auto_increment=1 default charset=utf8mb4 comment='菜单表';
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305181455429.png" alt="image-20230518145534262" style="zoom:80%;" />

#### 角色菜单表

```sql
create table `sys_role_menu` (
  `id` bigint(20) not null auto_increment,
  `role_id` bigint(20) not null default '0',
  `menu_id` bigint(11) not null default '0',
  `create_time` timestamp not null default current_timestamp comment '创建时间',
  `update_time` timestamp not null default current_timestamp on update 
    current_timestamp comment '更新时间',
  `is_deleted` tinyint(3) not null default '0' comment '删除标记（0:不可用 1:可用）',
  primary key (`id`),
  key `idx_role_id` (`role_id`),
  key `idx_menu_id` (`menu_id`)
) engine=innodb auto_increment=1 default charset=utf8 comment='角色菜单';
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305181500426.png" alt="image-20230518150024259" style="zoom:80%;" />

#### 页面效果![image-20220608145017289](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305152120510.png)



## 菜单管理

### 代码生成器

> 生成两张表，删除SysRoleMenuController，entity，修改mapper和service的实体类到model模块

```java
public class CodeGet {

    public static void main(String[] args) {
        // 1、创建代码生成器
        AutoGenerator mpg = new AutoGenerator();
        // 2、全局配置
        GlobalConfig gc = new GlobalConfig();
        gc.setOutputDir("D:\\SpringBoot新项目\\guigu-oa-parent\\service-oa"+"/src/main/java");
        gc.setServiceName("%sService");  //去掉Service接口的首字母I，因为生成器会自动加I,所以要去掉
        gc.setAuthor("renshuo"); // 设置作者
        gc.setOpen(false); // 设置目录是否展开，没啥用
        mpg.setGlobalConfig(gc);

        // 3、数据源配置
        DataSourceConfig dsc = new DataSourceConfig();
        dsc.setUrl("jdbc:mysql://localhost:3306/guigu-oa?serverTimezone=GMT%2B8&useSSL=false");
        dsc.setDriverName("com.mysql.cj.jdbc.Driver");
        dsc.setUsername("root");
        dsc.setPassword("123456");
        dsc.setDbType(DbType.MYSQL);
        mpg.setDataSource(dsc);

        // 4、包配置
        PackageConfig pc = new PackageConfig();
        pc.setParent("com.atguigu.auth");
        //pc.setModuleName("auth"); //模块名
        pc.setController("controller");
        pc.setService("service");
        pc.setMapper("mapper");
        mpg.setPackageInfo(pc);

        // 5、策略配置
        StrategyConfig strategy = new StrategyConfig();
        //数据库表映射到实体的命名策略
        strategy.setInclude("sys_menu","sys_role_menu");
        strategy.setNaming(NamingStrategy.underline_to_camel);
        //数据库表字段映射到实体的命名策略
        strategy.setColumnNaming(NamingStrategy.underline_to_camel);
        // lombok 模型 @Accessors(chain = true) setter链式操作
        strategy.setEntityLombokModel(true); 
        strategy.setRestControllerStyle(true); //restful api风格控制器
        strategy.setControllerMappingHyphenStyle(true); //url中驼峰转连字符
        mpg.setStrategy(strategy);
        // 6、执行
        mpg.execute();
    }
}
```

### 实体类

> model/SysMenu，重点：children

```java
@Data
@ApiModel(description = "菜单")
@TableName("sys_menu")
public class SysMenu extends BaseEntity {
   
   private static final long serialVersionUID = 1L;

   @ApiModelProperty(value = "所属上级")
   @TableField("parent_id")
   private Long parentId;

   @ApiModelProperty(value = "名称")
   @TableField("name")
   private String name;

   @ApiModelProperty(value = "类型(1:菜单,2:按钮)")
   @TableField("type")
   private Integer type;

   @ApiModelProperty(value = "路由地址")
   @TableField("path")
   private String path;

   @ApiModelProperty(value = "组件路径")
   @TableField("component")
   private String component;

   @ApiModelProperty(value = "权限标识")
   @TableField("perms")
   private String perms;

   @ApiModelProperty(value = "图标")
   @TableField("icon")
   private String icon;

   @ApiModelProperty(value = "排序")
   @TableField("sort_value")
   private Integer sortValue;

   @ApiModelProperty(value = "状态(0:禁止,1:正常)")
   @TableField("status")
   private Integer status;

   // 下级列表
   @TableField(exist = false)
   private List<SysMenu> children;
    
   //是否选中
   @TableField(exist = false)
   private boolean isSelect;
}
```

### 控制器类⭐

```java
package com.atguigu.system.controller;

import com.atguigu.common.result.Result;
import com.atguigu.model.system.SysMenu;
import com.atguigu.system.service.SysMenuService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
import java.util.List;

@Api(tags = "菜单管理")
@RestController
@RequestMapping("/admin/system/sysMenu")
public class SysMenuController {

    @Autowired
    private SysMenuService sysMenuService;

    @ApiOperation(value = "获取菜单")
    @GetMapping("findNodes")
    public Result findNodes() {
        List<SysMenu> list = sysMenuService.findNodes();
        return Result.ok(list);
    }

    @ApiOperation(value = "新增菜单")
    @PostMapping("save")
    public Result save(@RequestBody SysMenu permission) {
        sysMenuService.save(permission);
        return Result.ok();
    }

    @ApiOperation(value = "修改菜单")
    @PutMapping("update")
    public Result updateById(@RequestBody SysMenu permission) {
        sysMenuService.updateById(permission);
        return Result.ok();
    }

    @ApiOperation(value = "删除菜单")
    @DeleteMapping("remove/{id}")
    public Result remove(@PathVariable Long id) {
        sysMenuService.removeById(id);
        return Result.ok();
    }

}
```

### 菜单树型实现⭐

> SysMenuService

```java
public interface SysMenuService extends IService<SysMenu> {
    List<SysMenu> findNodes();
}
```

> **SysUserServiceImpl实现**

```java
@Service
public class SysMenuServiceImpl extends ServiceImpl<SysMenuMapper, SysMenu> implements SysMenuService {

    @Autowired
    private SysMenuMapper sysMenuMapper;

    @Override
    public List<SysMenu> findNodes() {
        // 全部权限列表
        List<SysMenu> sysMenuList = this.list();
        if (CollectionUtils.isEmpty(sysMenuList)) return null;
        // 构建树形数据
        List<SysMenu> result = MenuHelper.buildTree(sysMenuList);
        return result;
    }
    // 只有没有下一层菜单才可以删除
    @Override
    public boolean removeById(Serializable id) {
        int count = this.count(new LambdaQueryWrapper<SysMenu>().eq(SysMenu::getParentId, id));
        if (count > 0) {
            throw new GuiguException(201,"菜单不能删除");
        }
        sysMenuMapper.deleteById(id);
        return false;
    }
}
```

> **添加帮助类**新建：utils/MenuHelper

```java
// 根据菜单数据构建菜单数据
public class MenuHelper {

    // 使用递归方法建菜单(重点：递归入口和结束条件)
    public static List<SysMenu> buildTree(List<SysMenu> sysMenuList) {
        // 创建list集合，用于最终数据
        List<SysMenu> trees = new ArrayList<>();
        // 把所有菜单数据进行遍历
        for (SysMenu sysMenu : sysMenuList) {
            // 递归入口进入，即parentId=0，表示顶层菜单
            if (sysMenu.getParentId().longValue() == 0) {
                // 调用方法找到children，传入当前菜单和整个菜单，并把结果添加到最终集合中
                trees.add(findChildren(sysMenu,sysMenuList));
            }
        }
        return trees;
    }

    // 递归查找子节点
    public static SysMenu findChildren(SysMenu sysMenu, List<SysMenu> treeNodes) {
        // 设置children节点
        sysMenu.setChildren(new ArrayList<SysMenu>());
        // 遍历所有菜单数据，判断 id 和 parentId对应关系
        for (SysMenu it : treeNodes) {
            // 当前id=parentid表示相同，进行封装
            // 就是说如果当前节点的parentId和某一个字段的id相同，则这个id相同的节点为父节点
            if(sysMenu.getId().longValue() == it.getParentId().longValue()) {
                if (sysMenu.getChildren() == null) {
                    sysMenu.setChildren(new ArrayList<>());
                }
                sysMenu.getChildren().add(findChildren(it,treeNodes));
            }
        }
        return sysMenu;
    }
}
```

### 数据库表

> 上面的树型菜单对id和parentId要求非常严格，因此数据库表如下

```sql
insert into `sys_menu` values
(2,0,'系统管理',0,'system','Layout',null,'el-icon-s-tools',1,1,'2021-05-31 18:05:37',
 '2022-06-09 09:23:24',0),
(3,2,'用户管理',1,'sysUser','system/sysUser/list','','el-icon-s-custom',1,1,
 '2021-05-31 18:05:37','2022-06-09 09:22:47',0),
(4,2,'角色管理',1,'sysRole','system/sysRole/list','','el-icon-user-solid',2,1,
 '2021-05-31 18:05:37','2022-06-09 09:37:18',0),
(5,4,'角色授权',2,'assignAuth','system/sysRole/assignAuth','','el-icon-s-unfold',3,1,
 '2021-05-31 18:05:37','2022-06-09 09:37:21',0),
(6,2,'菜单管理',1,'sysMenu','system/sysMenu/list','','el-icon-s-unfold',3,1,
 '2021-05-31 18:05:37','2022-06-09 09:37:21',0);
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305191022415.png" alt="image-20230519102236342" style="zoom:80%;" />

### knife4j测试

:8800/doc.html

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305181522582.png" alt="image-20230518152233390" style="zoom:80%;" />

### 前端实现

#### 添加路由

> **修改 src/router/index.js 文件**

```js
{
  name: 'sysMenu',
  path: '/sysMenu',
  component: () => import('@/views/system/sysMenu/list'),
  meta: {
    title: '菜单管理',
    icon: 'el-icon-s-unfold'
  },
}
```

#### 定义基础api

**创建文件 src/api/system/sysMenu.js**

```js
import request from '@/utils/request'

// 菜单管理相关的API请求函数
const api_name = '/admin/system/sysMenu'

export default {

  // 获取权限(菜单/功能)列表
  findNodes() {
    return request({
      url: `${api_name}/findNodes`,
      method: 'get'
    })
  },

  // 删除一个权限项
  removeById(id) {
    return request({
      url: `${api_name}/remove/${id}`,
      method: "delete"
    })
  },

  // 保存一个权限项
  save(sysMenu) {
    return request({
      url: `${api_name}/save`,
      method: "post",
      data: sysMenu
    })
  },

  // 更新一个权限项
  updateById(sysMenu) {
    return request({
      url: `${api_name}/update`,
      method: "put",
      data: sysMenu
    })
  }
}
```

#### 实现页面功能⭐

> **创建src/views/system/sysMenu/list.vue**

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305181534035.png" alt="image-20230518153418821" style="zoom:80%;" />

```vue
<template>
  <div class="app-container">
    <!-- 工具条 -->
    <div class="tools-div">
      <el-button type="success" icon="el-icon-plus" size="mini" @click="add()">添 加</el-button>
    </div>
    <el-table
      :data="sysMenuList"
      style="width: 100%;margin-bottom: 20px;margin-top: 10px;"
      row-key="id"
      border
      :default-expand-all="false"
      :tree-props="{children: 'children'}">

      <el-table-column prop="name" label="菜单名称" width="160"/>
      <el-table-column label="图标">
        <template slot-scope="scope">
          <i :class="scope.row.icon"></i>
        </template>
      </el-table-column>
      <el-table-column prop="perms" label="权限标识" width="160"/>
      <el-table-column prop="path" label="路由地址" width="120"/>
      <el-table-column prop="component" label="组件路径" width="160"/>
      <el-table-column prop="sortValue" label="排序" width="60"/>
      <el-table-column label="状态" width="80">
        <template slot-scope="scope">
          <el-switch
            v-model="scope.row.status === 1" disabled="true">
          </el-switch>
        </template>
      </el-table-column>
      <el-table-column prop="createTime" label="创建时间" width="160"/>
      <el-table-column label="操作" width="180" align="center" fixed="right">
        <template slot-scope="scope">
          <el-button type="success" v-if="scope.row.type !== 2" icon="el-icon-plus" 
                     size="mini" @click="add(scope.row)" title="添加下级节点"/>
          <el-button type="primary" icon="el-icon-edit" size="mini" 
                     @click="edit(scope.row)" title="修改"/>
          <el-button type="danger" icon="el-icon-delete" size="mini" 
                     @click="removeDataById(scope.row.id)" title="删除" 
                     :disabled="scope.row.children.length > 0"/>
        </template>
      </el-table-column>
    </el-table>

    <el-dialog :title="dialogTitle" :visible.sync="dialogVisible" width="40%" >
      <el-form ref="dataForm" :model="sysMenu" label-width="150px" size="small" 
               style="padding-right: 40px;">
        <el-form-item label="上级部门" v-if="sysMenu.id === ''">
          <el-input v-model="sysMenu.parentName" disabled="true"/>
        </el-form-item>
        <el-form-item label="菜单类型" prop="type">
          <el-radio-group v-model="sysMenu.type" :disabled="typeDisabled">
            <el-radio :label="0" :disabled="type0Disabled">目录</el-radio>
            <el-radio :label="1" :disabled="type1Disabled">菜单</el-radio>
            <el-radio :label="2" :disabled="type2Disabled">按钮</el-radio>
          </el-radio-group>
        </el-form-item>
        <el-form-item label="菜单名称" prop="name">
          <el-input v-model="sysMenu.name"/>
        </el-form-item>
        <el-form-item label="图标" prop="icon" v-if="sysMenu.type !== 2">
          <el-select v-model="sysMenu.icon" clearable>
            <el-option v-for="item in iconList" :key="item.class" 
                       :label="item.class" :value="item.class">
            <span style="float: left;">
             <i :class="item.class"></i>  <!-- 如果动态显示图标，这里添加判断 -->
            </span>
              <span style="padding-left: 6px;">{{ item.class }}</span>
            </el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="排序">
          <el-input-number v-model="sysMenu.sortValue" controls-position="right" :min="0" />
        </el-form-item>
        <el-form-item prop="path">
              <span slot="label">
                <el-tooltip content="访问的路由地址，如：`sysUser`" placement="top">
                <i class="el-icon-question"></i>
                </el-tooltip>
                路由地址
              </span>
          <el-input v-model="sysMenu.path" placeholder="请输入路由地址" />
        </el-form-item>
        <el-form-item prop="component" v-if="sysMenu.type !== 0">
              <span slot="label">
                <el-tooltip content="访问的组件路径，如：`system/user/index`，
                                     默认在`views`目录下" placement="top">
                <i class="el-icon-question"></i>
                </el-tooltip>
                组件路径
              </span>
          <el-input v-model="sysMenu.component" placeholder="请输入组件路径" />
        </el-form-item>
        <el-form-item v-if="sysMenu.type === 2">
          <el-input v-model="sysMenu.perms" placeholder="请输入权限标识" maxlength="100" />
          <span slot="label">
                <el-tooltip content="控制器中定义的权限字符，如：   
                                     @PreAuthorize(hasAuthority('bnt.sysRole.list'))" 
                            placement="top">
                <i class="el-icon-question"></i>
                </el-tooltip>
                权限字符
              </span>
        </el-form-item>
        <el-form-item label="状态" prop="type">
          <el-radio-group v-model="sysMenu.status">
            <el-radio :label="1">正常</el-radio>
            <el-radio :label="0">停用</el-radio>
          </el-radio-group>
        </el-form-item>
      </el-form>
      <span slot="footer" class="dialog-footer">
        <el-button @click="dialogVisible = false" size="small" 
                   icon="el-icon-refresh-right">取 消</el-button>
        <el-button type="primary" icon="el-icon-check" @click="saveOrUpdate()" 
                   size="small">确 定</el-button>
      </span>
    </el-dialog>
  </div>
</template>


<script>
import api from '@/api/system/sysMenu'
const defaultForm = {
  id: '',
  parentId: '',
  name: '',
  type: 0,
  path: '',
  component: '',
  perms: '',
  icon: '',
  sortValue: 1,
  status: 1
}
export default {
  // 定义数据
  data() {
    return {
      sysMenuList: [],
      expandKeys: [], // 需要自动展开的项

      typeDisabled: false,
      type0Disabled: false,
      type1Disabled: false,
      type2Disabled: false,
      dialogTitle: '',

      dialogVisible: false,
      sysMenu: defaultForm,
      saveBtnDisabled: false,

      iconList: [
        {
          class: "el-icon-s-tools",
        },
        {
          class: "el-icon-s-custom",
        },
        {
          class: "el-icon-setting",
        },
        {
          class: "el-icon-user-solid",
        },
        {
          class: "el-icon-s-help",
        },
        {
          class: "el-icon-phone",
        },
        {
          class: "el-icon-s-unfold",
        },
        {
          class: "el-icon-s-operation",
        },
        {
          class: "el-icon-more-outline",
        },
        {
          class: "el-icon-s-check",
        },
        {
          class: "el-icon-tickets",
        },
        {
          class: "el-icon-s-goods",
        },
        {
          class: "el-icon-document-remove",
        },
        {
          class: "el-icon-warning",
        },
        {
          class: "el-icon-warning-outline",
        },
        {
          class: "el-icon-question",
        },
        {
          class: "el-icon-info",
        }
      ]
    }
  },

  // 当页面加载时获取数据
  created() {
    this.fetchData()
  },

  methods: {
    // 调用api层获取数据库中的数据
    fetchData() {
      console.log('加载列表')
      api.findNodes().then(response => {
        this.sysMenuList = response.data
        console.log(this.sysMenuList)
      })
    },

    // 根据id删除数据
    removeDataById(id) {
      // debugger
      this.$confirm('此操作将永久删除该记录, 是否继续?', '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => { // promise
        // 点击确定，远程调用ajax
        return api.removeById(id)
      }).then((response) => {
        this.fetchData()
        this.$message({
          type: 'success',
          message: '删除成功!'
        })
      }).catch(() => {
         this.$message.info('取消删除')
      })
    },

    // -------------
    add(row){
      debugger
      this.typeDisabled = false
      this.dialogTitle = '添加下级节点'
      this.dialogVisible = true

      this.sysMenu = Object.assign({}, defaultForm)
      this.sysMenu.id = ''
      if(row) {
        this.sysMenu.parentId = row.id
        this.sysMenu.parentName = row.name
        //this.sysMenu.component = 'ParentView'
        if(row.type === 0) {
          this.sysMenu.type = 1
          this.typeDisabled = false
          this.type0Disabled = false
          this.type1Disabled = false
          this.type2Disabled = true
        } else if(row.type === 1) {
          this.sysMenu.type = 2
          this.typeDisabled = true
        }
      } else {
        this.dialogTitle = '添加目录节点'
        this.sysMenu.type = 0
        this.sysMenu.component = 'Layout'
        this.sysMenu.parentId = 0
        this.typeDisabled = true
      }
    },

    edit(row) {
      debugger
      this.dialogTitle = '修改节点'
      this.dialogVisible = true

      this.sysMenu = Object.assign({}, row)
      this.typeDisabled = true
    },

    saveOrUpdate() {
      if(this.sysMenu.type === 0 && this.sysMenu.parentId !== 0) {
        this.sysMenu.component = 'ParentView'
      }
      this.$refs.dataForm.validate(valid => {
        if (valid) {
          this.saveBtnDisabled = true // 防止表单重复提交
          if (!this.sysMenu.id) {
            this.saveData()
          } else {
            this.updateData()
          }
        }
      })
    },

    // 新增
    saveData() {
      api.save(this.sysMenu).then(response => {
        this.$message.success(response.message || '操作成功')
        this.dialogVisible = false
        this.fetchData(this.page)
      })
    },

    // 根据id更新记录
    updateData() {
      api.updateById(this.sysMenu).then(response => {
        this.$message.success(response.message || '操作成功')
        this.dialogVisible = false
        this.fetchData()
      })
    }
  }
}
</script>
```

## 角色分配菜单⭐

### 给角色分配权限

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305181541800.png" alt="image-20230518154155611" style="zoom:80%;" />

#### 接口分析

> 1、进入分配页面：获取全部菜单及按钮，选中已选复选框，进行页面展示
>
> 2、保存分配权限：删除之前分配的权限和保存现在分配的权限

#### controller方法

> 操作类：SysMenuController

```java
@ApiModel(description = "分配菜单")
@Data
public class AssginMenuVo {
    @ApiModelProperty(value = "角色id")
    private Long roleId;

    @ApiModelProperty(value = "菜单id列表")
    private List<Long> menuIdList;
}
```

```java
@ApiOperation(value = "根据角色获取菜单")
@GetMapping("toAssign/{roleId}")
public Result toAssign(@PathVariable Long roleId) {
    List<SysMenu> list = sysMenuService.findSysMenuByRoleId(roleId);
    return Result.ok(list);
}

@ApiOperation(value = "给角色分配权限")
@PostMapping("/doAssign")
public Result doAssign(@RequestBody AssginMenuVo assginMenuVo) {
    sysMenuService.doAssign(assginMenuVo);
    return Result.ok();
}
```

#### service接口

> 操作类：SysMenuService

```java
public interface SysMenuService extends IService<SysMenu> {
    // 获取树型菜单
    List<SysMenu> findNodes();
    // 根据角色获取授权权限数据
    List<SysMenu> findSysMenuByRoleId(Long roleId);
    // 保存角色权限
    void doAssign(AssginMenuVo assginMenuVo);  
}
```

#### service接口实现

> 操作类：SysMenuServiceImpl
>

```java
@Resource
private SysRoleMenuMapper sysRoleMenuMapper;
```

```java
@Override
public List<SysMenu> findSysMenuByRoleId(Long roleId) {
    // 查询所有菜单- 添加条件 status=1
    List<SysMenu> allSysMenuList = this.list(new LambdaQueryWrapper<SysMenu>()
            .eq(SysMenu::getStatus, 1));
    //根据角色id role_id查询，角色菜单关系表里面，角色id对应的所有的菜单id
    List<SysRoleMenu> sysRoleMenuList = sysRoleMenuMapper
                    .selectList(new LambdaQueryWrapper<SysRoleMenu>()
                    .eq(SysRoleMenu::getRoleId, roleId));
    // 根据获取菜单id，获取对应菜单对象
    List<Long> menuIdList = sysRoleMenuList.stream().map(e -> e.getMenuId())
            .collect(Collectors.toList());
    // 拿着菜单id和所有菜单集合里面的id进行比较，如果相同封装
    allSysMenuList.forEach(permission -> {
        if (menuIdList.contains(permission.getId())) {
            permission.setSelect(true);
        } else {
            permission.setSelect(false);
        }
    });
    // 返回规定树型显示格式菜单列表
    List<SysMenu> sysMenuList = MenuHelper.buildTree(allSysMenuList);
    return sysMenuList;
}
```

```java
@Transactional
@Override
public void doAssign(AssginMenuVo assginMenuVo) {
    // 根据角色id删除原来分配的菜单
    sysRoleMenuMapper.delete(new LambdaQueryWrapper<SysRoleMenu>()
                             .eq(SysRoleMenu::getRoleId, assginMenuVo.getRoleId()));
    // 从参数里面获取菜单新分配的菜单id列表进行遍历，把每个id数据添加到菜单角色表
    for (Long menuId : assginMenuVo.getMenuIdList()) {
        if (StringUtils.isEmpty(menuId)) continue;
        SysRoleMenu rolePermission = new SysRoleMenu();
        rolePermission.setRoleId(assginMenuVo.getRoleId());
        rolePermission.setMenuId(menuId);
        sysRoleMenuMapper.insert(rolePermission);
    }
}
```

### 前端实现

#### 添加路由

> 创建页面：@/views/system/sysRole/assignAuth

```vue
<template>
<div>321</div>
</template>

<script>
export default {
  name: "assignAuth"
}
</script>

<style scoped>

</style>
```

> 修改 src/router/index.js 文件
>

```js
{
  path: 'assignAuth',
  component: () => import('@/views/system/sysRole/assignAuth'),
  meta: {
    activeMenu: '/system/sysRole',
    title: '角色授权'
  },
  hidden: true, // 表示不显示该路由
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305181603777.png" alt="image-20230518160318619" style="zoom:80%;" />

#### 角色列表添加按钮及方法

```vue
<el-button type="warning" icon="el-icon-baseball" size="mini" 
           @click="showAssignAuth(scope.row)" title="分配权限"/>
```

```js
// 跳转路由并传入id和roleName
showAssignAuth(row) {
  this.$router.push('/system/assignAuth?id='+row.id+'&roleName='+row.roleName);
},
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305181603906.png" alt="image-20230518160334746" style="zoom:80%;" />

#### 添加api

> **创建文件 src/api/system/sysMenu.js**

```js
// 查看某个角色的权限列表
toAssign(roleId) {
  return request({
    url: `${api_name}/toAssign/${roleId}`,
    method: 'get'
  })
},

// 给某个角色授权
doAssign(assginMenuVo) {
  return request({
    url: `${api_name}/doAssign`,
    method: "post",
    data: assginMenuVo
  })
}
```

#### 实现页面功能

> **创建src/views/system/sysMenu/assignAuth.vue**

```vue
<template>
  <div class="app-container">
    <div style="padding: 20px 20px 0 20px;">
      授权角色：{{ $route.query.roleName }}
    </div>
    <el-tree
      style="margin: 20px 0"
      ref="tree"
      :data="sysMenuList"
      node-key="id"
      show-checkbox
      default-expand-all
      :props="defaultProps"/>
    <div style="padding: 20px 20px;">
      <el-button :loading="loading" type="primary" icon="el-icon-check"
                 size="mini" @click="save">保存</el-button>
      <el-button @click="$router.push('/system/sysRole')" size="mini" 
                 icon="el-icon-refresh-right">返回</el-button>
    </div>
  </div>
</template>
<script>
  import api from '@/api/system/sysMenu'
  export default {
    name: 'roleAuth',
    data() {
      return {
        loading: false, // 用来标识是否正在保存请求中的标识, 防止重复提交
        sysMenuList: [], // 所有
        defaultProps: {
          children: 'children',
          label: 'name'
        },
      };
    },

    created() {
      this.fetchData()
    },

    methods: {
      // 初始化
      fetchData() {
        const roleId = this.$route.query.id
        api.toAssign(roleId).then(result => {
          const sysMenuList = result.data
          this.sysMenuList = sysMenuList
          const checkedIds = this.getCheckedIds(sysMenuList)
          console.log('getPermissions() checkedIds', checkedIds)
          this.$refs.tree.setCheckedKeys(checkedIds)
        })
      },

      // 得到所有选中的id列表
      getCheckedIds (auths, initArr = []) {
        return auths.reduce((pre, item) => {
          if (item.select && item.children.length === 0) {
            pre.push(item.id)
          } else if (item.children) {
            this.getCheckedIds(item.children, initArr)
          }
          return pre
        }, initArr)
      },

      // 保存权限列表
      save() {
        //获取到当前子节点及父节点
        const allCheckedNodes = this.$refs.tree.getCheckedNodes(false, true);
        let idList = allCheckedNodes.map(node => node.id);
        console.log(idList)
        let assginMenuVo = {
          roleId: this.$route.query.id,
          menuIdList: idList
        }
        this.loading = true
        api.doAssign(assginMenuVo).then(result => {
          this.loading = false
          this.$message.success(result.$message || '分配权限成功')
          this.$router.push('/system/sysRole');
        })
      }
    }
  };
</script>
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305181606606.png" alt="image-20230518160634449" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202305181606994.png" alt="image-20230518160653832" style="zoom:80%;" />























