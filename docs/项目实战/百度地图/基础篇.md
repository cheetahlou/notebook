

# 百度地图

## 地图技术概述f

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.8.30/202209201226103.png" alt="image-20220920122644009" style="zoom:80%;" />

## 地图应用场景⭐

### 网约车行业

> 在网约车场景中实现准定位、导航、司乘同显、精准计费等核心需求。

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.8.30/202209201228457.png" alt="image-20220920122815377" style="zoom:80%;" />

### 智能穿戴产品

> 实现智能穿戴设备定位、导航、轨迹追踪导等各种需求。

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.8.30/202209201229223.png" alt="image-20220920122915109" style="zoom:80%;" />

### 智能物流行业

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.8.30/202209201229848.png" alt="image-20220920122945764" style="zoom:80%;" />

### 智能景区行业

> 通过地图服务实现景区智能化、场景化，打造个性化智能景区

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.8.30/202209201230534.png" alt="image-20220920123039420" style="zoom:80%;" />

### 车联网行业

> 汽车企业通过地图数据和在线地图服务，实现车载导航、自动驾驶和手车互联等场景需求

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.8.30/202209201235265.png" alt="image-20220920123525173" style="zoom:80%;" />

## 国内常见地图厂商⭐

### 厂商官网

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207130940138.png" alt="image-20220713094021047" style="zoom: 50%;" />

### 厂商比较

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207130941102.png" alt="image-20220713094136036" style="zoom:67%;" />



## 百度地图基本API

百度地图提供了各种平台的SDK，地址：https://lbsyun.baidu.com/ 如下：

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207130943980.png" alt="image-20220713094312915" style="zoom:50%;" />

## 账号与API准备⭐

### 获取密钥ak

- 使用百度地图API首选需要注册百度账户，然后进行登录。
- 登录成功后，创建应用，获取到密钥ak。

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207130949328.png" alt="image-20220713094958275" style="zoom:67%;" />

### 设置应用名称与类型

> - 输入应用名称以及应用类型。
> - 这里先选择浏览器端进行学习。
> - 白名单中设置“*”号，说明没有域名限制。

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207130951176.png" alt="image-20220713095108128" style="zoom:50%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207130951013.png" alt="image-20220713095157949" style="zoom:67%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207130952373.png" alt="image-20220713095226324" style="zoom:67%;" />



# 浏览器端 API

## 前期准备⭐

### 必备密钥

> 密钥：https://api.map.baidu.com/api?v=1.0&type=webgl&ak=LHHGlmhcb4ENvIXpR9QQ2tBYa6ooUowX

```html
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Baidu Map </title>
    <style type="text/css">
        html{height:100%}
        body{height:100%;margin:0px;padding:0px}
        #container{height:100%}
    </style>
    <!--引入网址和ak-->
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=1.0&type=webgl&ak=LHHGlmhcb4ENvIXpR9QQ2tBYa6ooUowX"></script>
</head>
```

### 坐标拾取

> 官网：https://api.map.baidu.com/lbsapi/getpoint/index.html
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.8.30/202209201637295.png" alt="image-20220920163751151" style="zoom:80%;" />

## 地图基本使用

创建地图的基本步骤如下：

> - 编写HTML页面的基础代码
> - 引入百度地图API文件
> - 初始化地图逻辑以及设置各种参数

> 官方文档：https://lbsyun.baidu.com/index.php?title=jspopularGL/guide/show 
>

> HelloWorld文档：https://lbsyun.baidu.com/index.php?title=jspopularGL/guide/helloworld
>
> 控件是负责与地图交互的UI元素，百度地图API支持比例尺、缩放、定位、城市选择列表、版权

```html
<html>
<body>
<!-- 地图需要一个HTML元素作为容器，这样才能展现到页面上。这里我们创建了一个div元素 -->
<div id="container"></div>
<script type="text/javascript">
    // 位于BMapGL命名空间下的Map类表示地图，通过new操作符可以创建一个地图实例
    // 其参数可以是元素id也可以是元素对象
    var map = new BMapGL.Map("container");          
    var point = new BMapGL.Point(116.404, 39.915);  // 设置中心点坐标
    map.centerAndZoom(point, 15);                 // 地图初始化，同时设置地图展示级别
    map.enableScrollWheelZoom(true);     // 开启鼠标滚轮缩放
    map.setHeading(64.5);   // 设置地图旋转角度
    map.setTilt(65);       // 设置地图的倾斜角度

    var scaleCtrl = new BMapGL.ScaleControl();  // 添加比例尺控件
    map.addControl(scaleCtrl);
    var zoomCtrl = new BMapGL.ZoomControl();  // 添加缩放控件
    map.addControl(zoomCtrl);
    var cityCtrl = new BMapGL.CityListControl();  // 添加城市列表控件
    map.addControl(cityCtrl);
</script>
</body>
</html>
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207131001799.png" alt="image-20220713100115668" style="zoom: 45.5%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207131002996.png" alt="image-20220713100246915" style="zoom:50%;" />

## 添加标注点

```html
<body>
<div id="container"></div>
<script type="text/javascript">
    var map = new BMapGL.Map("container");          // 创建地图实例
    var point = new BMapGL.Point(116.404, 39.915);  // 创建点坐标
    map.centerAndZoom(point, 15);                 // 初始化地图，设置中心点坐标和地图级别
    map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放

    var  point2 = new BMapGL.Point(116.380194,39.922018);
    var marker = new BMapGL.Marker(point2);        // 创建标注(自定义的点)
    map.addOverlay(marker);                     // 将标注添加到地图中
	// 添加自定义图片
    var myIcon = new BMapGL.Icon("logo.png", new BMapGL.Size(180, 53), {
        // 指定定位位置。
        // 当标注显示在地图上时，其所指向的地理位置距离图标左上
        // 角各偏移10像素和25像素。您可以看到在本例中该位置即是
        // 图标中央下端的尖角位置。
        anchor: new BMapGL.Size(-10, 12),
        // 设置图片偏移。
        // 当您需要从一幅较大的图片中截取某部分作为标注图标时，您
        // 需要指定大图的偏移位置，此做法与css sprites技术类似。
        imageOffset: new BMapGL.Size(0, 0)   // 设置图片偏移(即是否剪切图片)
    });
    // 创建标注对象并添加到地图
    var marker = new BMapGL.Marker(point, {icon: myIcon});
    map.addOverlay(marker);
    // 点击标注事件
    marker.addEventListener("click", function(){
        alert("您点击了标注");
    });
    map.addOverlay(circle);
</script>
</body>
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.8.17/image-20230713144650447.png" alt="image-20230713144650447" style="zoom:80%;" />



## 添加覆盖物

> 所有叠加或覆盖到地图的内容，我们统称为地图覆盖物。覆盖物拥有自己的地理坐标，当您拖动或缩放地图时，它们会相应的移动。目前JSAPI GL版支持的覆盖物以基本图形为主。
>

> 文档：https://lbsyun.baidu.com/index.php?title=jspopularGL/guide/addOverlay 
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207131003731.png" alt="image-20220713100358656" style="zoom:67%;" />

| **覆盖物** | **类名** | **说明**                           |
| ---------- | -------- | ---------------------------------- |
| 抽象基类   | Overlay  | 所有的覆盖物均继承此类的方法       |
| 点         | Marker   | 表示地图上的点，可自定义标注的图标 |
| 折线       | Polyline | 表示地图上的折线                   |
| 多边形     | Polygon  | 表示地图上的多边形                 |
| 圆         | Circle   | 表示地图上的圆                     |

```html
<body>
<div id="container"></div>
<script type="text/javascript">
    var map = new BMapGL.Map("container");          // 创建地图实例
    var point = new BMapGL.Point(116.404, 39.915);  // 创建点坐标
    map.centerAndZoom(point, 15);                 // 初始化地图，设置中心点坐标和地图级别
    map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
    // 折线，设置坐标，通过坐标拾取器获取到坐标,展示地图创建基本地图，之后添加折线覆盖物到地图中
    // 折线覆盖物可以分别设置描边粗细、颜色、填充颜色等属性。
    var polyline = new BMapGL.Polyline([
        new BMapGL.Point(116.399, 39.910),
        new BMapGL.Point(116.405, 39.920),
        new BMapGL.Point(116.425, 39.900)
        // 连线的颜色，宽度，透明度0-1
    ], {strokeColor:"blue", strokeWeight:2, strokeOpacity:0.8});
    map.addOverlay(polyline);

    // 多边形,会把这些线连接起来
    var polygon = new BMapGL.Polygon([
        new BMapGL.Point(116.387112,39.920977),
        new BMapGL.Point(116.385243,39.913063),
        new BMapGL.Point(116.394226,39.917988),
        new BMapGL.Point(116.401772,39.921364),
        new BMapGL.Point(116.41248,39.927893)
    ], {strokeColor:"blue", strokeWeight:2, strokeOpacity:0.5});
    map.addOverlay(polygon);

    // 圆形，参数分别是中心坐标，半径，连线样式
    var circle = new BMapGL.Circle(point , 1000, {
        strokeColor:"red",
        strokeOpacity:0.8,
        strokeWeight:3
    });
    map.addOverlay(circle);
</script>
</body>
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.8.17/image-20230713144934798.png" alt="image-20230713144934798" style="zoom:80%;" />

## 地图事件

> 百度地图API拥有一个自己的事件模型，程序员可监听地图API对象的自定义事件，使用方法和DOM事件类似。但请注意，地图API事件是独立的，与标准DOM事件不同。
>

> 文档：https://lbsyun.baidu.com/index.php?title=jspopularGL/guide/event 
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207131012132.png" alt="image-20220713101221044" style="zoom:67%;" />

```html
<div id="container"></div>
<script type="text/javascript">
    var map = new BMapGL.Map("container");          // 创建地图实例
    var point = new BMapGL.Point(116.404, 39.915);  // 创建点坐标
    map.centerAndZoom(point, 15);                 // 初始化地图，设置中心点坐标和地图级别
    map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
    // 添加事件监听即可
    map.addEventListener('click', function(e) {
        alert('点击的经纬度：' + e.latlng.lng + ', ' + e.latlng.lat);
        var mercator = map.lnglatToMercator(e.latlng.lng, e.latlng.lat);
        alert('点的墨卡托坐标：' + mercator[0] + ', ' + mercator[1]);
    });
</script>
```



## 地图样式

百度地图支持设置地图样式，比如将地图设置为地球模式，

文档：https://lbsyun.baidu.com/index.php?title=jspopularGL/guide/maptype 

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207131012008.png" alt="image-20220713101254780" style="zoom:67%;" />

```html
<div id="container"></div>
<script type="text/javascript">
    var map = new BMapGL.Map("container");          // 创建地图实例
    var point = new BMapGL.Point(116.404, 39.915);  // 创建点坐标
    map.centerAndZoom(point, 15);                 // 初始化地图，设置中心点坐标和地图级别
    map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
    map.setMapType(BMAP_EARTH_MAP);      // 设置地图类型为地球模式
</script>
```



## 地图检索⭐

> 百度地图支持在地图中兴趣点的检索服务
>

> 示例：[https://lbsyun.baidu.com/jsdemo.htm#localSearchKey](https://lbsyun.baidu.com/jsdemo.htm) 
>

### 关键字检索

> 北京市“银行”关键字的检索结果，并展示在地图上
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207131013160.png" alt="image-20220713101351064" style="zoom:67%;" />

```html
<div id="container"></div>
<script type="text/javascript">
    var map = new BMapGL.Map("container");          // 创建地图实例
    var point = new BMapGL.Point(116.404, 39.915);  // 创建点坐标
    map.centerAndZoom(point, 15);                 // 初始化地图，设置中心点坐标和地图级别
    map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
    // 搜索函数
    var local = new BMapGL.LocalSearch(map, {
        renderOptions:{map: map},
        // 页面容量100个
        pageCapacity:100
    });
    local.search("银行");
</script>
```

### 关键字+范围检索

> 百度地图支持在地图中兴趣点的检索服务，示例：https://lbsyun.baidu.com/jsdemo.htm)
>

#### 圆形范围

> 北京市地图上圆形覆盖范围内的“景点”检索结果，并展示在地图上
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207131014637.png" alt="image-20220713101439572" style="zoom:67%;" />

```html
<div id="container"></div>
<script type="text/javascript">
    var map = new BMapGL.Map("container");          // 创建地图实例
    var point = new BMapGL.Point(116.404, 39.915);  // 创建点坐标
    map.centerAndZoom(point, 15);                 // 初始化地图，设置中心点坐标和地图级别
    map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
    // 圆形搜索范围
    // point：圆心，2000：圆形半径，单位为米，strokeWeight：圆形边框线条宽度
    // fillOpacity：填充颜色的透明度，strokeOpacity：边框线条的透明度，范围都是0-1
    var circle = new BMapGL.Circle(point,2000,{fillColor:"blue", 
                                               strokeWeight: 1 ,
                                               fillOpacity: 0.3, 
                                               strokeOpacity: 0.3});
    map.addOverlay(circle);
    var local =  new BMapGL.LocalSearch(map, {renderOptions: {map: map, 
                                                              autoViewport: false}});
    local.searchNearby('景点',point,2000);
</script>
```

#### 矩阵范围

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.8.30/202209201612282.png" alt="image-20220920161204219" style="zoom:80%;" />

```html
<body>
<div id="container"></div>
<script type="text/javascript">
    // 百度地图API功能
    var map = new BMapGL.Map("container");            // 创建Map实例
    map.centerAndZoom(new BMapGL.Point(116.274625,39.961627), 11);
    map.enableScrollWheelZoom();     //启用滚轮放大缩小
    var local = new BMapGL.LocalSearch(map, {
        renderOptions:{map: map}
    });
    var pStart = new BMapGL.Point(116.274625,39.961627);
    var pEnd = new BMapGL.Point(116.367474,39.988609);
    var bs = new BMapGL.Bounds(pStart,pEnd);   //自己规定范围
    local.searchInBounds("银行", bs);
    var polygon = new BMapGL.Polygon([
        new BMapGL.Point(pStart.lng,pStart.lat),
        new BMapGL.Point(pEnd.lng,pStart.lat),
        new BMapGL.Point(pEnd.lng,pEnd.lat),
        new BMapGL.Point(pStart.lng,pEnd.lat)
    ], {strokeColor:"blue", strokeWeight:6, strokeOpacity:0.5});
    map.addOverlay(polygon);
</script>
</body>
```

### 多关键字检索

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.8.30/202209201604788.png" alt="image-20220920160440697" style="zoom:80%;" />

```html
<style type="text/css">
    body, html,#allmap {width: 100%;height: 100%; margin:0;font-family:"微软雅黑";}
    #l-map{height:300px;width:100%;}
    #r-result{width:100%;}
</style>
<body>
    <div id="l-map"></div>
    <div id="r-result"></div>
</body>
<script type="text/javascript">
  // 百度地图API功能
  var map = new BMapGL.Map("l-map");            // 创建Map实例
  map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
  map.centerAndZoom(new BMapGL.Point(116.404, 39.915), 11);
  var myKeys = ["酒店", "加油站"]; // 多个关键字
  var local = new BMapGL.LocalSearch(map, {
    renderOptions:{map: map, panel:"r-result"},
    pageCapacity:5
  });
  local.search(myKeys, map.getBounds());
</script>
```

### 本地检索

#### 本地检索结果面板

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.8.30/202209201618922.png" alt="image-20220920161805848" style="zoom:80%;" />

```html
<style type="text/css">
    body, html{width: 100%;height: 100%; margin:0;font-family:"微软雅黑";}
    #l-map{height:300px;width:100%;}
    #r-result{width:100%;}
</style>
<body>
<div id="l-map"></div>
<div id="r-result"></div>
</body>

<script type="text/javascript">
    // 百度地图API功能
    var map = new BMapGL.Map("l-map");            // 创建Map实例
    map.centerAndZoom(new BMapGL.Point(116.404, 39.915), 11);
    map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
    var local = new BMapGL.LocalSearch(map, {
        renderOptions: {map: map, panel: "r-result"}
    });
    local.search("餐饮");
</script>
```



#### 本地检索数据接口

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.8.30/202209201620960.png" alt="image-20220920162009904" style="zoom:80%;" />

```html
<script type="text/javascript">
    // 百度地图API功能
    var map = new BMapGL.Map("l-map");
    map.centerAndZoom(new BMapGL.Point(116.404, 39.915), 11);
    map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
    var options = {
        onSearchComplete: function(results){
            // 判断状态是否正确
            if (local.getStatus() == BMAP_STATUS_SUCCESS){
                var s = [];
                for (var i = 0; i < results.getCurrentNumPois(); i ++){
                    s.push(results.getPoi(i).title + ", " + results.getPoi(i).address);
                }
                document.getElementById("r-result").innerHTML = s.join("<br/>");
            }
        }
    };
    var local = new BMapGL.LocalSearch(map, options);
    local.search("公园");
</script>
```



## 数据可视化

> MapVGL，是一款基于WebGL的地理信息可视化库，可以用来展示大量基于3D的地理信息点线面数据。
>

> 文档：https://lbsyun.baidu.com/solutions/mapvdata 
>

> 示例Demo：https://lbsyun.baidu.com/solutions/mapvdata
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207131032862.png" alt="image-20220713103240767" style="zoom:67%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207131015065.png" alt="image-20220713101510964" style="zoom:67%;" />



# Web服务端API

## 功能概述

> 百度地图Web服务API为开发者提供http/https接口，即开发者通过http/https形式发起检索请求，获取返回json或xml格式的检索数据。用户可以基于此开发JavaScript、C#、C++、Java等语言的地图应用。
>

> 地址： https://lbsyun.baidu.com/index.php?title=webapi 
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207131015702.png" alt="image-20220713101554611" style="zoom:67%;" />

## 创建应用

### 创建服务

> - 输入应用名称以及应用类型。
> - 这里先选择服务器端进行学习。
> - IP白名单中设置“0.0.0.0/0”号，说明对IP地址没有限制

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207131016503.png" alt="image-20220713101656448" style="zoom:67%;" />

### 坐标依赖

```xml
<dependency>
    <groupId>cn.hutool</groupId>
    <artifactId>hutool-all</artifactId>
    <version>5.5.2</version>
</dependency>
```

## 坐标转换

目前中国主要有以下三种坐标系：

> WGS84：为一种大地坐标系，也是目前广泛使用的GPS全球卫星定位系统使用的坐标系
>
> GCJ02：是由中国国家测绘局制订的地理信息系统的坐标系统，由WGS84坐标系经加密后的坐标系
>
> BD09：百度坐标系，在GCJ02坐标系基础上再次加密，其中bd09ll表示百度经纬度坐标，bd09mc表示百度墨卡托米制坐标

> Web Api中提供了将非百度坐标转换成百度坐标体系的接口服务。
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202303131549702.png" alt="image-20230313154900595" style="zoom:80%;" />

> 文档：https://lbsyun.baidu.com/index.php?title=webapi/guide/changeposition 
>

```java
private String ak = "sZWkMbcUn2zbmDsuM7Au1KUT1LSSa7s2";
private String url = "https://api.map.baidu.com/geoconv/v1/?coords=114.21892734521,29.575429778924&from=1&to=5&ak={}";
// 测试坐标转换服务：将其他类型坐标转换成百度坐标
@Test
public void testGeoconv() {
    //这里使用的是Hutool工具包，占位符,将{}替换为ak
    url = StrUtil.format(url, ak);
    //发起get请求
    String body = HttpRequest.get(url).execute().body();
    System.out.println(body);
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207131045582.png" alt="image-20220713104525547" style="zoom:67%;" />

## IP定位服务

> 普通IP定位是一套以HTTP/HTTPS形式提供的轻量级定位接口，用户可以通过该服务，根据IP定位来获取**大致位置**。文档：https://lbsyun.baidu.com/index.php?title=webapi/ip-api 
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207131019014.png" alt="image-20220713101940952" style="zoom:67%;" />

### 请求参数

```sh
https://api.map.baidu.com/location/ip?ak=您的AK&ip=您的IP&coor=bd09ll //GET请求 
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202303131606472.png" alt="image-20230313160628384" style="zoom:80%;" />

### 返回结果（JSON格式）

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202303131607189.png" alt="image-20230313160708092" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202303131607238.png" alt="image-20230313160746155" style="zoom:80%;" />

### 实战案例

```java
ObjectMapper mapper = new ObjectMapper();

@Test
public void testLocation() throws Exception {
    String url = "https://api.map.baidu.com/location/ip?ak={}&ip=140.206.149.83&coor=bd09ll";
    url = StrUtil.format(url, ak);
    // 发起GET请求
    String body = HttpRequest.get(url).execute().body();
    // JSON转换成Map输出
    Map map = mapper.readValue(body, Map.class);
    System.out.println(map);
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.8.30/202209201633138.png" alt="image-20220920163307090" style="zoom:80%;" />



## 地点输入提示服务

> 用户可通过该服务，匹配用户输入关键词的地点推荐列表。
>
> 文档：https://lbsyun.baidu.com/index.php?title=webapi/place-suggestion-api

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207131020353.png" alt="image-20220713102020299" style="zoom:67%;" />

### 功能介绍

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202303131610126.png" alt="image-20230313161004034" style="zoom:80%;" />

```sh
https://api.map.baidu.com/place/v2/suggestion?query=天安门&region=北京&city_limit=true&output=json&ak=你的ak //GET请求
```

### 请求参数

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202303131611208.png" alt="image-20230313161151043" style="zoom: 80%;" />

### 返回结果参数

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202303131613112.png" alt="image-20230313161358995" style="zoom:80%;" />

```java
@Test
public void testSuggestion(){
    String url = "https://api.map.baidu.com/place/v2/suggestion?query=清华大&region=北京&city_limit=true&output=json&ak={}";
    url = StrUtil.format(url, ak);
    //发起get请求
    String body = HttpRequest.get(url).execute().body();
    System.out.println(body);
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207131052489.png" alt="image-20220713105234436" style="zoom:67%;" />

## 路线规划

> 路线规划服务（又名Direction API）是一套REST风格的Web服务API，以HTTP/HTTPS形式提供了路线规划服务。目前，Direction API支持公交、骑行、驾车路线规划，Direction API支持中国大陆地区。
>

> 文档：https://lbsyun.baidu.com/index.php?title=webapi/direction-api-v2 
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.6.30/202207131020799.png" alt="image-20220713102056748" style="zoom:67%;" />

### 功能介绍

> 驾车路线规划：根据起终点坐标规划驾车出行路线和耗时，支持：
>
> 支持10个途经点、支持设置偏好：常规路线、不走高速、躲避拥堵
>
> 支持传入起点车头方向，辅助判断起点所在正逆向车道，辅助更准确算路

> 骑行路线规划：根据起终点坐标规划骑行出行路线和耗时，支持普通自行车和电动自行车出行方式
>
> 步行路线规划：根据起终点坐标规划步行出行路线和耗时
>
> 公交路线规划：根据起终点坐标规划同城公共交通出行路线和耗时，支持公交、地铁出行方式

### 实战案例

```java
@Test
public void testDriving(){
    // origin：起点，destination：终点
    String url = "https://api.map.baidu.com/direction/v2/driving?alternatives=1&origin=40.009645,116.333374&destination=39.937016,116.453576&ak={}";
    //这里使用的是Hutool工具包
    url = StrUtil.format(url, ak);
    //发起get请求
    String body = HttpRequest.get(url).execute().body();
    System.out.println(body);
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.8.17/image-20230713151250945.png" alt="image-20230713151250945" style="zoom:80%;" />



# 地图找房

## 功能说明

> - 在房源信息类网站中，为了方便用户查找房源，推出了地图找房的功能，房源数据展示更加直观
> - 例如：链家网：https://map.lianjia.com/map/310000/ESF/

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202303131633799.png" alt="image-20230313163359605" style="zoom:80%;" />

## BMapGLLib

> BMapGLLib是百度地图提供的一个JavaScript库，用于在Web端显示基于百度地图的地图、地图覆盖物和交互控件等。BMapGLLib支持WebGL技术，可以实现更高效的渲染和更流畅的交互效果。可以快速开发出高性能、交互丰富的Web地图应用，例如地图展示、路径规划、位置搜索等。

> BMapGLLib提供了丰富的API，包括地图显示控制、地图覆盖物绘制、交互控件添加、事件监听等。同时，BMapGLLib也提供了很多默认的地图样式和交互效果，可以直接使用或者进行定制。通过使用BMapGLLib，开发者可以很方便地实现各种地图功能和效果。

> 代码地址：https://github.com/huiyan-fe/BMapGLLib

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202303131642310.png" alt="image-20230313164246151" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202303131643496.png" alt="image-20230313164326351" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202303131643235.png" alt="image-20230313164358113" style="zoom:80%;" />

## 静态页面

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.8.30/202209201250626.png" alt="image-20220920125028500" style="zoom:80%;" />

```html
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>地图找房 - 地图搜索 </title>
    <style>
        html {
            height: 100%
        }

        body {
            height: 100%;
            margin: 0px;
            padding: 0px
        }

        #container {
            height: 100%
        }

        .district {
            width: 84px;
            height: 84px;
            line-height: 16px;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 1px solid transparent;
            border-radius: 50%;
            overflow: hidden;
            text-align: center;
            font-family: PingFangSC-Semibold;
            color: #fff;
            background: #00ae66 !important;
            box-sizing: border-box;
        }

        .district i {
            font-size: 12px;
            color: hsla(0, 0%, 100%, .7);
            line-height: 12px;
            margin-top: 4px;
            font-style: normal;
        }

        #platform > div > div > div {
            background: none !important;
        }
    </style>
    <!-- 引入jquery   -->
    <script type="text/javascript" src="jquery-3.6.0.min.js"></script>
    <!-- 引入百度地图ak   -->
    <script type="text/javascript"
            src="http://api.map.baidu.com/api?v=1.0
                 &type=webgl&ak=91ZGySxxQNEevlw0bnZoegqSiF5McxQj"></script>
    <!-- 引入上面的工具包，复制到min.js即可   -->
    <script src="RichMarker.min.js"></script>
</head>
```

```html
<body>
<div id="container"></div>

<script type="application/javascript">
    function showInfo(map) {
        // 可视范围矩形坐标，其中sw表示矩形区域的西南角，参数ne表示矩形区域的东北角
        let bound = map.getBounds(); 
        let zoom = map.getZoom(); //缩放级别
        console.log(bound);
        console.log(zoom);
        // 准备静态数据
        let data = [
            {"name":"徐汇","price":"1028.43","total":"6584",
             "longitude":121.43676,"latitude":31.18831},
            {"name":"黄浦","price":"1016.19","total":"7374",
             "longitude":121.49295,"latitude":31.22337},
            {"name":"长宁","price":"1008.34","total":"4380",
             "longitude":121.42462,"latitude":31.22036},
            {"name":"静安","price":"1005.34","total":"8077",
             "longitude":121.4444,"latitude":31.22884},
            {"name":"普陀","price":"1026.14","total":"5176",
             "longitude":121.39703,"latitude":31.24951},
            {"name":"金山","price":"1099.67","total":"6",
             "longitude":121.34164,"latitude":30.74163},
            {"name":"松江","price":"1017.71","total":"14",
             "longitude":121.22879,"latitude":31.03222},
            {"name":"青浦","price":"1038.11","total":"751",
             "longitude":121.12417,"latitude":31.14974},
            {"name":"奉贤","price":"1108.63","total":"35",
             "longitude":121.47412,"latitude":30.9179},
            {"name":"浦东","price":"1030.22","total":"8294",
             "longitude":121.5447,"latitude":31.22249},
            {"name":"嘉定","price":"1041.45","total":"1620",
             "longitude":121.2655,"latitude":31.37473},
            {"name":"宝山","price":"1050.65","total":"102",
             "longitude":121.4891,"latitude":31.4045},
            {"name":"闵行","price":"1027.15","total":"941",
             "longitude":121.38162,"latitude":31.11246},
            {"name":"杨浦","price":"1007.78","total":"2747",
             "longitude":121.526,"latitude":31.2595},
            {"name":"虹口","price":"1025.81","total":"4187",
             "longitude":121.48162,"latitude":31.27788}];
        showMapMarker(data, map)
    }

    // 显示覆盖物
    function showMapMarker(data, map) {
        for (let vo of data) {
            let html = "<div class=\"district\">" + vo.name + 
                       "<span>" + vo.price + "万</span><i>" + vo.total + "套</i></div>";
            let marker = new BMapGLLib.RichMarker(html, 
                                                  new BMapGL.Point(vo.longitude, vo.latitude));
            map.addOverlay(marker);
        }
    }

    // 清除覆盖物
    function clearMapMarker(map) {
        let markers = map.getOverlays(); // 获取到地图上所有的覆盖物
        for (let marker of markers) { // 循环将其删除
            map.removeOverlay(marker);
        }
    }

    $(function () {
        // 地图默认位置，上海市
        let defaultX = 121.48130241985999;
        let defaultY = 31.235156971414239;
        let defaultZoom = 12; // 默认缩放比例

        let map = new BMapGL.Map("container");          // 创建地图实例
        let point = new BMapGL.Point(defaultX, defaultY);  // 创建点坐标
        map.centerAndZoom(point, defaultZoom); // 初始化地图，设置中心点坐标和地图级别
        map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
        //显示比例尺
        map.addControl(new BMapGL.ScaleControl({anchor: BMAP_ANCHOR_BOTTOM_RIGHT}));

        map.addEventListener("dragstart", () => {  //拖动开始事件
            clearMapMarker(map)
        });
        map.addEventListener("dragend", () => { //拖动结束事件
            showInfo(map)
        });
        map.addEventListener("zoomstart", () => { //缩放开始事件
            clearMapMarker(map)
        });
        map.addEventListener("zoomend", () => { //缩放结束事件
            showInfo(map)
        });
        //初始显示数据
        showInfo(map);
    });
</script>
</body>
```

## 构造数据⭐

> 为了数据的真实性，我们从网上抓取一些小区的数据，小区的位置数据通过百度地图API获取

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.8.30/202209201252422.png" alt="image-20220920125227375" style="zoom:80%;" />

> 创建house数据库，运行脚本文件

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.8.17/image-20230713155322583.png" alt="image-20230713155322583" style="zoom:80%;" />

### 行政区数据

> 案例以上海市为例，其有16个行政区。tb_district
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202303131710744.png" alt="image-20230313171038618" style="zoom:80%;" />

### 商圈数据

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202303131712413.png" alt="image-20230313171218323" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202303131712462.png" alt="image-20230313171239340" style="zoom:80%;" />

### 小区数据

> 小区数据抓取网上的数据。抓取完成后，共有20510条数据。（建议使用提供的数据即可）
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202303131713924.png" alt="image-20230313171320812" style="zoom:80%;" />

### 房源数据

> 由于房源数据仅仅是展现数量，所以就不再进行数据抓取了，按照小区数据进行构造即可。
>
> 每个小区随机构造1~20个房源数据。最终构造完成有106094条数据。

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202303131715826.png" alt="image-20230313171554709" style="zoom:80%;" />

## MongoDB⭐

> MongoDB的聚合操作是以管道的形式完成的，在一个管道处理完毕后将结果传递给下一个管道处理。

### 安装MongoDB

```sh
#拉取镜像
docker pull mongo:5.0.3

#创建容器
docker create --name mongodb-server -p 27017:27017 -v mongodb-data:/data/db mongo:4.0.3 --auth

#启动容器
docker start mongodb-server

#进入容器
docker exec -it mongodb-server /bin/bash

#进入admin数据库
mongo
use admin

#添加管理员，其拥有管理用户和角色的权限
db.createUser({ user: 'root', pwd: 'root', roles: [ { role: "root", db: "admin" } ] })
#退出后进行认证

#进行认证
mongo -u "root" -p "root" --authenticationDatabase "admin"

#通过admin添加普通用户
use admin
db.createUser({ user: 'house', pwd: 'oudqBFGmGY8pU6WS', roles: [ { role: "readWrite", db: "house" } ] });

#通过tanhua用户登录进行测试
mongo -u "house" -p "oudqBFGmGY8pU6WS" --authenticationDatabase "admin"

#发现可以正常进入控制台进行操作
```

### 聚合操作

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202303131720451.png" alt="image-20230313172018343" style="zoom:80%;" />

### 聚合操作符

> MongoDB的聚合操作符主要用于处理数据(诸如统计平均值,求和等)，并返回计算后的数据结果。
>
> 类似SQL语句中的 count(*)操作，常用操作如下：

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.8.30/202209201303404.png" alt="image-20220920130331333" style="zoom:80%;" />



## 实现搜索 – 分析

### 搜索关键

> 通过矩形的对角的坐标可以确定矩形搜索范围。按照不同的地图比例尺进行分组聚合查询，通过按照行政区、商圈或小区名进行分组，聚合数量、价格等数据
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.8.30/202209201322186.png" alt="image-20220920132256133" style="zoom:80%;" />

### Maven坐标

```xml
<dependencies>
    <dependency>
        <groupId>junit</groupId>
        <artifactId>junit</artifactId>
        <version>4.12</version>
        <scope>test</scope>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>cn.hutool</groupId>
        <artifactId>hutool-all</artifactId>
        <version>5.5.2</version>
    </dependency>
    <!--springdata对于mongodb支持-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-mongodb</artifactId>
    </dependency>
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <version>1.18.20</version>
    </dependency>

    <dependency>
        <groupId>com.squareup.okhttp3</groupId>
        <artifactId>okhttp</artifactId>
        <version>3.14.9</version>
    </dependency>

    <dependency>
        <groupId>us.codecraft</groupId>
        <artifactId>webmagic-core</artifactId>
        <version>0.7.3</version>
    </dependency>
    <dependency>
        <groupId>us.codecraft</groupId>
        <artifactId>webmagic-extension</artifactId>
        <version>0.7.3</version>
    </dependency>

    <!--Redis依赖-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-redis</artifactId>
    </dependency>
    <!--连接池依赖-->
    <dependency>
        <groupId>org.apache.commons</groupId>
        <artifactId>commons-pool2</artifactId>
    </dependency>
</dependencies>
```

```yml
spring:
  redis:
    port: 6379
    host: 127.0.0.1
    lettuce: # 默认连接池，不写不生效
      pool:
        max-active: 8  # 最大连接
        max-idle: 8    # 最大空闲连接
        min-idle: 0    # 最小空闲连接
        max-wait: 100ms # 连接等待时间
        time-between-eviction-runs: 10s #每10s运行一次空闲连接回收器(独立线程)
  data:
    mongodb:
      database: house
      port: 27017
      host: 127.0.0.1
      auto-index-creation: true
```

### 实体类

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
@Document(collection = "tb_house")
public class House {
    @Id
    private ObjectId id; //主键id
    private String title; //房源标题
    private Double price; //总价
    @GeoSpatialIndexed(type = GeoSpatialIndexType.GEO_2DSPHERE)
    private GeoJsonPoint location; //x:经度 y:纬度
    @Indexed
    private Integer districtCode; //所属行政区
    @Indexed
    private ObjectId communityId; //所属小区
    @Indexed
    private Integer businessCircleCode; //商圈
    private Long created; //创建时间
}
```

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
@Document(collection = "tb_district")
public class District { // 行政区
    @Id
    private ObjectId id; //主键id
    private String name; //名称
    @Indexed
    private Integer code; //编号
    @GeoSpatialIndexed(type = GeoSpatialIndexType.GEO_2DSPHERE)
    private GeoJsonPoint location; //x:经度 y:纬度
}
```

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
@Document(collection = "tb_community") //小区
public class Community {
    @Id
    private ObjectId id; //主键id
    private String name; //名称
    @GeoSpatialIndexed(type = GeoSpatialIndexType.GEO_2DSPHERE)
    private GeoJsonPoint location; //x:经度 y:纬度
    @Indexed
    private Integer districtCode; //所属区
    @Indexed
    private Integer businessCircleCode; //商圈
    private String lianJiaUrl; //链家网url
}
```

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
@Document(collection = "tb_business_circle")
public class BusinessCircle { // 商圈
    @Id
    private ObjectId id; //主键id
    private String name; //名称
    @Indexed
    private Integer code; //编号
    @GeoSpatialIndexed(type = GeoSpatialIndexType.GEO_2DSPHERE)
    private GeoJsonPoint location; //x:经度 y:纬度
    @Indexed
    private Integer districtCode; //所属区
    private String lianJiaUrl; //链家网url
}
```

```java
@Data
public class HouseResultVo {
    @JsonIgnore
    @Field("_id")
    private String code; //用于MongoDB聚合查询结果的映射
    private String name; //显示的名称，可能是区、商业圈、小区
    private String price; //均价
    private String total; //房源数量
    private Double longitude; //位置经度
    private Double latitude; //位置维度
}
```

### 搜索实现

```java
@Service
public class HouseSearchService {

    @Autowired
    private MongoTemplate mongoTemplate;

    /**
     * 地图找房搜索服务
     * @param maxLongitude 最大经度
     * @param minLongitude 最小经度
     * @param maxLatitude  最大纬度
     * @param minLatitude  最小纬度
     * @param zoom         地图缩放比例值
     */
    public List<HouseResultVo> search(Double maxLongitude,
                                      Double minLongitude,
                                      Double maxLatitude,
                                      Double minLatitude,
                                      Double zoom) {

        //收集聚合查询条件
        List<AggregationOperation> operationList = new ArrayList<>();

        //在可视范围内搜索(矩形范围搜索)
        Box box = new Box(new double[]{maxLongitude, maxLatitude}, 
                          new double[]{minLongitude, minLatitude});
        MatchOperation matchOperation = Aggregation.match(Criteria.where("location")
                                                   .within(box));
        //将搜索的结果放入集合中
        operationList.add(matchOperation);
        
        int type;
        GroupOperation groupOperation;
        //根据地图的缩放比例进行分组(比例尺)
        if (zoom < 13.5) { //2公里以上
            //按照行政区分组
            groupOperation = Aggregation.group("districtCode");
            type = 1;
        } else if (zoom < 15.5) { //200米以上
            //按照商圈分组
            groupOperation = Aggregation.group("businessCircleCode");
            type = 2;
        } else { //200以下
            //按照小区分组
            groupOperation = Aggregation.group("communityId");
            type = 3;
        }

        groupOperation = groupOperation.count().as("total")
                                       .avg("price").as("price");
        operationList.add(groupOperation);

        //生成最终的聚合条件
        Aggregation aggregation = Aggregation.newAggregation(operationList);

        //执行查询
        AggregationResults<HouseResultVo> aggregationResults = this.mongoTemplate
                         .aggregate(aggregation, House.class, HouseResultVo.class);

        List<HouseResultVo> houseResultVoList = aggregationResults.getMappedResults();
        if (CollUtil.isEmpty(houseResultVoList)) {
            return Collections.emptyList();
        }
        //填充数据
        switch (type) {
            case 1: {
                //查询行政区数据
                for (HouseResultVo houseResultVo : houseResultVoList) {
                    District district = this.queryDistrictByCode(Convert  
                                                               .toInt(houseResultVo.
                                                                      getCode()));
                    houseResultVo.setName(district.getName());
                    houseResultVo.setLongitude(district.getLocation().getX());
                    houseResultVo.setLatitude(district.getLocation().getY());
                    //价格保留2位小数
                    houseResultVo.setPrice(NumberUtil.roundStr(houseResultVo
                                                               .getPrice(), 2));
                }
                break;
            }
            case 2: {
                //查询商圈数据
                for (HouseResultVo houseResultVo : houseResultVoList) {
                    BusinessCircle businessCircle = this
                        .queryBusinessCircleByCode(Convert
                        .toInt(houseResultVo.getCode()));
                    houseResultVo.setName(businessCircle.getName());
                    houseResultVo.setLongitude(businessCircle.getLocation().getX());
                    houseResultVo.setLatitude(businessCircle.getLocation().getY());
                    //价格保留2位小数
                    houseResultVo.setPrice(NumberUtil.roundStr(houseResultVo.getPrice(),
                                                               2));
                }
                break;
            }
            case 3: {
                //查询小区数据
                for (HouseResultVo houseResultVo : houseResultVoList) {
                    Community community = this
                        .queryCommunityById(new ObjectId(houseResultVo.getCode()));
                    houseResultVo.setName(community.getName());
                    houseResultVo.setLongitude(community.getLocation().getX());
                    houseResultVo.setLatitude(community.getLocation().getY());
                    //价格保留2位小数
                    houseResultVo.setPrice(NumberUtil.roundStr(houseResultVo.getPrice(), 
                                                               2));
                }
                break;
            }
            default: {
                return Collections.emptyList();
            }
        }
        return houseResultVoList;
    }

    // 根据code查询行政区数据
    private District queryDistrictByCode(Integer code) {
        Query query = Query.query(Criteria.where("code").is(code));
        return this.mongoTemplate.findOne(query, District.class);
    }

    // 根据code查询商圈数据
    private BusinessCircle queryBusinessCircleByCode(Integer code) {
        Query query = Query.query(Criteria.where("code").is(code));
        return this.mongoTemplate.findOne(query, BusinessCircle.class);
    }

    // 根据code查询小区数据
    private Community queryCommunityById(ObjectId id) {
        return this.mongoTemplate.findById(id, Community.class);
    }
}
```

### 查询控制

```java
@CrossOrigin
@RequestMapping("house/search")
@RestController
public class HouseSearchController {

    @Autowired
    private HouseSearchService houseSearchService;

    /**
     * 地图找房搜索服务
     * @param maxLongitude 最大经度
     * @param minLongitude 最小经度
     * @param maxLatitude  最大纬度
     * @param minLatitude  最小纬度
     * @param zoom         地图缩放比例值
     * @return
     */
    @GetMapping
    public List<HouseResultVo> search(@RequestParam("maxLongitude") Double maxLongitude,
                                      @RequestParam("minLongitude") Double minLongitude,
                                      @RequestParam("maxLatitude") Double maxLatitude,
                                      @RequestParam("minLatitude") Double minLatitude,
                                      @RequestParam("zoom") Double zoom) {
        return this.houseSearchService.search(maxLongitude, minLongitude, 
                                              maxLatitude, minLatitude, zoom);
    }
}
```

### 测试使用

```java
@Autowired
private HouseSearchService houseSearchService;

@Test
public void search() {
    Double maxLongitude = 121.84924835674687;
    Double minLongitude = 121.11335648297293;
    Double maxLatitude = 31.27516459194276;
    Double minLatitude = 31.195131967625237;
    Double zoom = 12d;
    this.houseSearchService.search(maxLongitude, minLongitude, 
                                   maxLatitude, minLatitude, zoom)
        .forEach(System.out::println);
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.8.30/202209201804983.png" alt="image-20220920180440904" style="zoom:80%;" />

### 网页实现

```html
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>地图找房 - 地图搜索 </title>
    <style type="text/css">
        html {
            height: 100%
        }

        body {
            height: 100%;
            margin: 0px;
            padding: 0px
        }
        
        #container {
            height: 100%
        }
        
        .district {
            width: 84px;
            height: 84px;
            line-height: 16px;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 1px solid transparent;
            border-radius: 50%;
            overflow: hidden;
            text-align: center;
            font-family: PingFangSC-Semibold;
            color: #fff;
            background: #00ae66 !important;
            box-sizing: border-box;
        }

        .district i {
            font-size: 12px;
            color: hsla(0, 0%, 100%, .7);
            line-height: 12px;
            margin-top: 4px;
            font-style: normal;
        }

        #platform > div > div > div {
            background: none !important;
        }
    </style>
    <script type="text/javascript" src="jquery-3.6.0.min.js"></script>
    <script type="text/javascript"
            src="http://api.map.baidu.com/api?v=1.0&type=webgl&ak=LHHGlmhcb4ENvIXpR9QQ2tBYa6ooUowX"></script>
    <script src="RichMarker.min.js"></script>
</head>
<body>
<div id="container"></div>
<script type="application/javascript">
    function showInfo(map) {
        // 可视范围矩形坐标，其中sw表示矩形区域的西南角，参数ne表示矩形区域的东北角
        let bound = map.getBounds(); 
        let zoom = map.getZoom(); // 缩放级别
        console.log(bound);
        console.log(zoom);
        $.ajax({
            url: ":8899/house/search/",
            data: {
                maxLongitude: bound.ne.lng,
                minLongitude: bound.sw.lng,
                maxLatitude: bound.ne.lat,
                minLatitude: bound.sw.lat,
                zoom: zoom
            },
            success: function (data) {
                showMapMarker(data, map);
                console.log("访问成功")
                console.log(data)
            }
        });
    }

    //显示覆盖物
    function showMapMarker(data, map) {
        for (let vo of data) {
            let html = "<div class=\"district\">" + vo.name + "<span>" + 
                vo.price + "万</span><i>" + vo.total + "套</i></div>";
            let marker = new BMapGLLib.RichMarker(html, 
                                                  new BMapGL.Point(vo.longitude, vo.latitude));
            map.addOverlay(marker);
        }
    }

    //清除覆盖物
    function clearMapMarker(map) {
        let markers = map.getOverlays(); //获取到地图上所有的覆盖物
        for (let marker of markers) { //循环将其删除
            map.removeOverlay(marker);
        }
    }

    $(function () {
        //地图默认位置，上海市
        let defaultX = 121.48130241985999;
        let defaultY = 31.235156971414239;
        let defaultZoom = 12; //默认缩放比例

        let map = new BMapGL.Map("container");          // 创建地图实例
        let point = new BMapGL.Point(defaultX, defaultY);  // 创建点坐标
        map.centerAndZoom(point, defaultZoom);        // 初始化地图，设置中心点坐标和地图级别
        map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
        //显示比例尺
        map.addControl(new BMapGL.ScaleControl({anchor: BMAP_ANCHOR_BOTTOM_RIGHT}));

        map.addEventListener("dragstart", () => {  //拖动开始事件
            clearMapMarker(map)
        });
        map.addEventListener("dragend", () => { //拖动结束事件
            showInfo(map)
        });
        map.addEventListener("zoomstart", () => { //缩放开始事件
            clearMapMarker(map)
        });
        map.addEventListener("zoomend", () => { //缩放结束事件
            showInfo(map)
        });
        //初始显示数据
        showInfo(map);
    });
</script>
</body>
</html>
```

## 最终效果

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.8.30/202209201259601.png" alt="image-20220920125942500" style="zoom:80%;" />





