

# 环境搭建

## 工程启动

### minio

```sh
cd /root
# 后台运行，推荐
nohup minio server ~/minio --console-address :9090  >out.log 2>&1 &
# 访问地址
http://192.168.88.101:9000
# 账号和密码
minioadmin minioadmin
```

### docker

> 使用Docker开启了一大堆东西

```sh
docker start mongo es  kibana nacos redis xxl-job-admin mysql57
```

> xxl-job：http://192.168.88.101:8888/xxl-job-admin/
>
> kibana：http://192.168.88.101:5601/
>
> minio：http://192.168.88.101:9090/
>
> nacos：http://192.168.88.101:8848/nacos/

### Jenkins

```
cd /etc/init.d
./jenkins start
./jenkins stop
ps -ef | grep jenkins
用户名密码：root、315217
```

![image-20230703111928447](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230703111928447.png)

## 课程对比

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131503243.png" alt="image-20230613150354177" style="zoom:80%;" />



<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131505384.png" alt="image-20230613150507307" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131505931.png" alt="image-20230613150551847" style="zoom:80%;" />

## 项目概述

### 能让你收获什么

![image-20210407203902473](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131502521.png)

### 项目课程大纲

![image-20210407203935383](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131502557.png)

### 项目概述

> 随着智能手机的普及，人们更加习惯于通过手机来看新闻。由于生活节奏的加快，很多人只能利用碎片时间来获取信息，因此，对于移动资讯客户端的需求也越来越高。黑马头条项目正是在这样背景下开发出来。黑马头条项目采用当下火热的微服务+大数据技术架构实现。本项目主要着手于获取最新最热新闻资讯，通过大数据分析用户喜好精确推送咨询新闻
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131502539.png" alt="image-20210407204320559" style="zoom:80%;" />

### 功能架构图

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131507344.png" alt="image-20230613150728258" style="zoom:80%;" />

### 项目术语

![image-20210407204345614](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131502544.png)

### 业务说明

![image-20210407204405774](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131502568.png)

项目演示地址：

- 平台管理：[http://heima-admin-java.research.itcast.cn](http://heima-admin-java.research.itcast.cn/) 

- 自媒体：[http://heime-media-java.research.itcast.cn](http://heime-media-java.research.itcast.cn/) 

- app端：[http://heima-app-java.research.itcast.cn](http://heima-app-java.research.itcast.cn/) 

平台管理与自媒体为PC端，用电脑浏览器打开即可。

其中app端为移动端，打开方式有两种：                                                 

- 谷歌浏览器打开，调成移动端模式                      

- 手机浏览器打开或扫描右侧二维码

  ![image-20210407204213963](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131502217.png)



### 技术栈

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131509273.png" alt="image-20230613150920172" style="zoom: 80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131509273.png" alt="image-20230613150943171" style="zoom:80%;" />

- Spring-Cloud-Gateway : 微服务之前架设的网关服务，实现服务注册中的API请求路由，以及控制流速控制和熔断处理都是常用的架构手段，而这些功能Gateway天然支持
- 运用Spring Boot快速开发框架，构建项目工程；并结合Spring Cloud全家桶技术，实现后端个人中心、自媒体、管理中心等微服务。
- 运用Spring Cloud Alibaba Nacos作为项目中的注册中心和配置中心
- 运用mybatis-plus作为持久层提升开发效率
- 运用Kafka完成内部系统消息通知；与客户端系统消息通知；以及实时数据计算
- 运用Redis缓存技术，实现热数据的计算，提升系统性能指标
- 使用Mysql存储用户数据，以保证上层数据查询的高性能
- 使用Mongo存储用户热数据，以保证用户热数据高扩展和高性能指标
- 使用FastDFS作为静态资源存储器，在其上实现热静态资源缓存、淘汰等功能
- 运用Hbase技术，存储系统中的冷数据，保证系统数据的可靠性
- 运用ES搜索技术，对冷数据、文章数据建立索引，以保证冷数据、文章查询性能
- 运用AI技术，来完成系统自动化功能，以提升效率及节省成本。比如实名认证自动化
- PMD&P3C : 静态代码扫描工具，在项目中扫描项目代码，检查异常点、优化点、代码规范等，为开发团队提供规范统一，提升项目代码质量

## Nacos环境搭建

①：docker拉取镜像 

```shell
docker pull nacos/nacos-server:1.2.0
```

②：创建容器

```shell
docker run --env MODE=standalone --name nacos --restart=always  -d -p 8848:8848 nacos/nacos-server:1.2.0
```

- MODE=standalone 单机版

- --restart=always 开机启动

- -p 8848:8848  映射端口

- -d 创建一个守护式容器在后台运行

③：访问地址：http://192.168.200.130:8848/nacos 

![image-20210412141353694](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131502982.png)



## 初始工程搭建

### 环境准备

①：项目依赖环境（需提前安装好）

- JDK1.8

- Intellij Idea

- maven-3.6.1

- Git

②：在当天资料中解压heima-leadnews.zip文件，拷贝到一个没有中文和空格的目录，使用idea打开即可

![image-20210412141517519](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131502018.png)

③：IDEA开发工具配置

![image-20210412141601018](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131502170.png)

设置本地仓库，建议使用资料中提供好的仓库

④：设置项目编码格式

![image-20210412141631441](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131502395.png)

### 工程主体结构

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131514845.png" alt="image-20230613151422762" style="zoom:80%;" />

### 全局异常

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131516881.png" alt="image-20230613151610814" style="zoom:80%;" />



### 统一返回结果

> heima-leadnews-model模块

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230627165042460.png" alt="image-20230627165042460" style="zoom:80%;" />

```java
public enum AppHttpCodeEnum {

    // 成功段0
    SUCCESS(200,"操作成功"),
    // 登录段1~50
    NEED_LOGIN(1,"需要登录后操作"),
    LOGIN_PASSWORD_ERROR(2,"密码错误"),
    // TOKEN50~100
    TOKEN_INVALID(50,"无效的TOKEN"),
    TOKEN_EXPIRE(51,"TOKEN已过期"),
    TOKEN_REQUIRE(52,"TOKEN是必须的"),
    // SIGN验签 100~120
    SIGN_INVALID(100,"无效的SIGN"),
    SIG_TIMEOUT(101,"SIGN已过期"),
    // 参数错误 500~1000
    PARAM_REQUIRE(500,"缺少参数"),
    PARAM_INVALID(501,"无效参数"),
    PARAM_IMAGE_FORMAT_ERROR(502,"图片格式有误"),
    SERVER_ERROR(503,"服务器内部错误"),
    // 数据错误 1000~2000
    DATA_EXIST(1000,"数据已经存在"),
    AP_USER_DATA_NOT_EXIST(1001,"ApUser数据不存在"),
    DATA_NOT_EXIST(1002,"数据不存在"),
    // 数据错误 3000~3500
    NO_OPERATOR_AUTH(3000,"无权限操作"),
    NEED_ADMIND(3001,"需要管理员权限");

    int code;
    String errorMessage;

    AppHttpCodeEnum(int code, String errorMessage){
        this.code = code;
        this.errorMessage = errorMessage;
    }

    public int getCode() {
        return code;
    }

    public String getErrorMessage() {
        return errorMessage;
    }
}
```

> 分页DTO

```java
@Data
@Slf4j
public class PageRequestDto {

    protected Integer size;
    protected Integer page;

    public void checkParam() {
        if (this.page == null || this.page < 0) {
            setPage(1);
        }
        if (this.size == null || this.size < 0 || this.size > 100) {
            setSize(10);
        }
    }
}
```

```java
public class PageResponseResult extends ResponseResult implements Serializable {
    private Integer currentPage;
    private Integer size;
    private Integer total;

    public PageResponseResult(Integer currentPage, Integer size, Integer total) {
        this.currentPage = currentPage;
        this.size = size;
        this.total = total;
    }

    public PageResponseResult() {

    }

    public int getCurrentPage() {
        return currentPage;
    }

    public void setCurrentPage(int currentPage) {
        this.currentPage = currentPage;
    }

    public int getSize() {
        return size;
    }

    public void setSize(int size) {
        this.size = size;
    }

    public int getTotal() {
        return total;
    }

    public void setTotal(int total) {
        this.total = total;
    }
}
```

```java
public class ResponseResult<T> implements Serializable {

    private String host;

    private Integer code;

    private String errorMessage;

    private T data;

    public ResponseResult() {
        this.code = 200;
    }

    public ResponseResult(Integer code, T data) {
        this.code = code;
        this.data = data;
    }

    public ResponseResult(Integer code, String msg, T data) {
        this.code = code;
        this.errorMessage = msg;
        this.data = data;
    }

    public ResponseResult(Integer code, String msg) {
        this.code = code;
        this.errorMessage = msg;
    }

    public static ResponseResult errorResult(int code, String msg) {
        ResponseResult result = new ResponseResult();
        return result.error(code, msg);
    }

    public static ResponseResult okResult(int code, String msg) {
        ResponseResult result = new ResponseResult();
        return result.ok(code, null, msg);
    }

    public static ResponseResult okResult(Object data) {
        ResponseResult result = setAppHttpCodeEnum(AppHttpCodeEnum.SUCCESS,    
                                                   AppHttpCodeEnum
                                                   .SUCCESS.getErrorMessage());
        if(data!=null) {
            result.setData(data);
        }
        return result;
    }

    public static ResponseResult errorResult(AppHttpCodeEnum enums){
        return setAppHttpCodeEnum(enums,enums.getErrorMessage());
    }

    public static ResponseResult errorResult(AppHttpCodeEnum enums, 
                                             String errorMessage){
        return setAppHttpCodeEnum(enums,errorMessage);
    }

    public static ResponseResult setAppHttpCodeEnum(AppHttpCodeEnum enums){
        return okResult(enums.getCode(),enums.getErrorMessage());
    }

    private static ResponseResult setAppHttpCodeEnum(AppHttpCodeEnum enums, 
                                                     String errorMessage){
        return okResult(enums.getCode(),errorMessage);
    }

    public ResponseResult<?> error(Integer code, String msg) {
        this.code = code;
        this.errorMessage = msg;
        return this;
    }

    public ResponseResult<?> ok(Integer code, T data) {
        this.code = code;
        this.data = data;
        return this;
    }

    public ResponseResult<?> ok(Integer code, T data, String msg) {
        this.code = code;
        this.data = data;
        this.errorMessage = msg;
        return this;
    }

    public ResponseResult<?> ok(T data) {
        this.data = data;
        return this;
    }

    public Integer getCode() {
        return code;
    }

    public void setCode(Integer code) {
        this.code = code;
    }

    public String getErrorMessage() {
        return errorMessage;
    }

    public void setErrorMessage(String errorMessage) {
        this.errorMessage = errorMessage;
    }

    public T getData() {
        return data;
    }

    public void setData(T data) {
        this.data = data;
    }

    public String getHost() {
        return host;
    }

    public void setHost(String host) {
        this.host = host;
    }


    public static void main(String[] args) {
        //前置
        /*AppHttpCodeEnum success = AppHttpCodeEnum.SUCCESS;
        System.out.println(success.getCode());
        System.out.println(success.getErrorMessage());*/

        //查询一个对象
        /*Map map = new HashMap();
        map.put("name","zhangsan");
        map.put("age",18);
        ResponseResult result = ResponseResult.okResult(map);
        System.out.println(JSON.toJSONString(result));*/


        //新增，修改，删除  在项目中统一返回成功即可
       /* ResponseResult result = ResponseResult.errorResult(AppHttpCodeEnum.SUCCESS);
        System.out.println(JSON.toJSONString(result));*/


        //根据不用的业务返回不同的提示信息  比如：当前操作需要登录、参数错误
        /*ResponseResult result = ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);
        System.out.println(JSON.toJSONString(result));*/

        //查询分页信息
        PageResponseResult responseResult = new PageResponseResult(1,5,50);
        List list = new ArrayList();
        list.add("itcast");
        list.add("itheima");
        responseResult.setData(list);
        System.out.println(JSON.toJSONString(responseResult));
    }

}
```



# 登录功能

## 需求分析

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131516830.png" alt="image-20230613151651752" style="zoom:80%;" />

### 表结构分析

关于app端用户相关的内容较多，可以单独设置一个库leadnews_user

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131517153.png" alt="image-20230613151718093" style="zoom:80%;" />

从当前资料中找到对应数据库并导入到mysql中

登录需要用到的是ap_user表，表结构如下：

![image-20210412142006558](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131502736.png)

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131502770.png" alt="image-20210412142055047" style="zoom:80%;" />

项目中的持久层使用的mybatis-plus，一般都使用mybais-plus逆向生成对应的实体类

## 加密(MD5+盐)

> md5是不可逆加密，md5相同的密码每次加密都一样，不安全。在md5的基础上手动加盐（salt）处理
>

> 注册->生成盐
>

![image-20210412142315248](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131502918.png)

> 登录->使用盐来配合验证
>

![image-20210412142428499](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131502960.png)

> Jwt验证
>

![image-20210412142536782](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131502175.png)

> 1，用户输入了用户名和密码进行登录，校验成功后返回jwt(基于当前用户的id生成)
>
> 2，用户游客登录，生成jwt返回(基于默认值0生成)

## 项目搭建

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131519171.png" alt="image-20230613151927099" style="zoom:80%;" />

### heima-leadnews-user

> 在heima-leadnews-service创建模块heima-leadnews-user

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131520900.png" alt="image-20230613152001829" style="zoom:80%;" />

### ApUser

> app_user表对应的实体类如下：com/heima/model/common/user/pojos/ApUser.java
>

```java
@Data
@TableName("ap_user")
public class ApUser implements Serializable {

    private static final long serialVersionUID = 1L;

    //主键
    @TableId(value = "id", type = IdType.AUTO)
    private Integer id;

    //密码、通信等加密盐
    @TableField("salt")
    private String salt;

    //用户名
    @TableField("name")
    private String name;

    //密码,md5加密
    @TableField("password")
    private String password;

    //手机号
    @TableField("phone")
    private String phone;

    //头像
    @TableField("image")
    private String image;

    // 0 男 1 女 2 未知
    @TableField("sex")
    private Boolean sex;

    // 0 未 1 是
    @TableField("is_certification")
    private Boolean certification;

    //是否身份认证
    @TableField("is_identity_authentication")
    private Boolean identityAuthentication;

    // 0正常 1锁定
    @TableField("status")
    private Boolean status;

    // 0 普通用户 1 自媒体人 2 大V
    @TableField("flag")
    private Short flag;

    //注册时间
    @TableField("created_time")
    private Date createdTime;

}
```

### UserApplication

> com/heima/user/UserApplication.java

```java
@SpringBootApplication
@EnableDiscoveryClient
@MapperScan("com.heima.user.mapper")
public class UserApplication {
    public static void main(String[] args) {
        SpringApplication.run(UserApplication.class,args);
    }
}
```

### bootstrap.yml

> src/main/resources/bootstrap.yml，用来监听nacos配置文件：拼接name+file-extension

```yaml
server:
  port: 51801
spring:
  application:
    name: leadnews-user
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.88.101:8848
      config:
        server-addr: 192.168.88.101:8848
        file-extension: yml
```

> 在nacos中创建配置文件
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230627111900765.png" alt="image-20230627111900765" style="zoom:67%;" />

```yaml
spring:
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/leadnews_user?useUnicode=true&serverTimezone=UTC
    username: root
    password: 123456
# 设置Mapper接口所对应的XML文件位置，如果你在Mapper接口中有自定义方法，需要进行该配置
mybatis-plus:
  mapper-locations: classpath*:mapper/*.xml
  # 设置别名包扫描路径，通过该属性可以给包中的类注册别名
  type-aliases-package: com.heima.model.user.pojos
```

### logback.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>

<configuration>
    <!--定义日志文件的存储地址,使用绝对路径-->
    <property name="LOG_HOME" value="e:/logs"/>

    <!-- Console 输出设置 -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <!--格式化输出：%d表示日期，%thread表示线程名，
                %-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符-->
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - 
                     %msg%n</pattern>
            <charset>utf8</charset>
        </encoder>
    </appender>

    <!-- 按照每天生成日志文件 -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <!--日志文件输出的文件名-->
            <fileNamePattern>${LOG_HOME}/leadnews.%d{yyyy-MM-dd}.log</fileNamePattern>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - 
                     %msg%n</pattern>
        </encoder>
    </appender>

    <!-- 异步输出 -->
    <appender name="ASYNC" class="ch.qos.logback.classic.AsyncAppender">
        <!-- 不丢失日志.默认的,如果队列的80%已满,则会丢弃TRACT、DEBUG、INFO级别的日志 -->
        <discardingThreshold>0</discardingThreshold>
        <!-- 更改默认的队列的深度,该值会影响性能.默认值为256 -->
        <queueSize>512</queueSize>
        <!-- 添加附加的appender,最多只能添加一个 -->
        <appender-ref ref="FILE"/>
    </appender>


    <logger name="org.apache.ibatis.cache.decorators.LoggingCache" 
            level="DEBUG" additivity="false">
        <appender-ref ref="CONSOLE"/>
    </logger>
    <logger name="org.springframework.boot" level="debug"/>
    <root level="info">
        <!--<appender-ref ref="ASYNC"/>-->
        <appender-ref ref="FILE"/>
        <appender-ref ref="CONSOLE"/>
    </root>
</configuration>
```

## 登录功能实现

### 接口一览

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131520618.png" alt="image-20230613152041531" style="zoom:80%;" />

### 返回实体LoginDto

> com/heima/model/user/dtos/LoginDto.java

```java
@Data
public class LoginDto {
    // 手机号
    private String phone;
    // 密码
    private String password;
}
```

### 持久层mapper

```java
public interface ApUserMapper extends BaseMapper<ApUser> {
}
```

### 业务层service

```java
public interface ApUserService extends IService<ApUser>{
    public ResponseResult login(LoginDto dto);
}
```

> 实现类
>

```java
@Service
public class ApUserServiceImpl extends ServiceImpl<ApUserMapper, ApUser> 
                               implements ApUserService {

    @Override
    public ResponseResult login(LoginDto dto) {

        //1.正常登录（手机号+密码登录）
        if (!StringUtils.isBlank(dto.getPhone()) && 
            !StringUtils.isBlank(dto.getPassword())) {
            //1.1查询用户，根据手机号查询
            ApUser apUser = getOne(Wrappers.<ApUser>lambdaQuery()
                                   .eq(ApUser::getPhone, dto.getPhone()));
            if (apUser == null) {
                return ResponseResult.errorResult(AppHttpCodeEnum.DATA_NOT_EXIST,
                                                  "用户不存在");
            }
            //1.2 比对密码，查到的数据库字段对应得盐
            String salt = apUser.getSalt();
            // 自己输入得密码
            String pswd = dto.getPassword();
            // 得到加密后的密码(即自己输入的密码+盐=加密字符串)
            pswd = DigestUtils.md5DigestAsHex((pswd + salt).getBytes());
            // 密码不一致，错误
            if (!pswd.equals(apUser.getPassword())) {
                return ResponseResult.errorResult(AppHttpCodeEnum.LOGIN_PASSWORD_ERROR);
            }
            //1.3 返回数据  jwt，这里是自己写的JWT工具类
            Map<String, Object> map = new HashMap<>();
            map.put("token", AppJwtUtil.getToken(apUser.getId().longValue()));
            // 返回数据时候，要将盐和密码置空再返回
            apUser.setSalt("");
            apUser.setPassword("");
            map.put("user", apUser);
            // 返回结果
            return ResponseResult.okResult(map);
        } else {
            //2.游客  同样返回token  id = 0
            Map<String, Object> map = new HashMap<>();
            map.put("token", AppJwtUtil.getToken(0L));
            return ResponseResult.okResult(map);
        }
    }
}
```

### 控制层controller

```java
@RestController
@RequestMapping("/api/v1/login")
public class ApUserLoginController {

    @Autowired
    private ApUserService apUserService;

    @PostMapping("/login_auth")
    public ResponseResult login(@RequestBody LoginDto dto) {
        return apUserService.login(dto);
    }
}
```

> 启动测试，只要不报错就行，我们将token返给前端，前端负责把token保存到header中

### 启动测试

> 已经配置好了knif4j的情况下执行

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230627155623219.png" alt="image-20230627155623219" style="zoom:80%;" />

```json
{
  "password": "admin",
  "phone": "13511223456"
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230627155634619.png" alt="image-20230627155634619" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230627155705502.png" alt="image-20230627155705502" style="zoom:80%;" />

## 接口测试工具

### postman

> Postman是一款功能强大的网页调试与发送网页HTTP请求的Chrome插件。postman被500万开发者和超100,000家公司用于每月访问1.3亿个API。官方网址：https://www.postman.com/
>

> 解压资料文件夹中的软件，安装即可
>

![image-20210413162511873](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131502594.png)

> 通常的接口测试查看请求和响应，下面是登录请求的测试
>

![image-20210413162558657](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131502647.png)

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131522617.png" alt="image-20230613152214538" style="zoom:80%;" />

### knife4j⭐

> knife4j是为Java MVC框架集成Swagger生成Api文档的增强解决方案,前身是swagger-bootstrap-ui,取名kni4j是希望它能像一把匕首一样小巧,轻量,并且功能强悍!
>

> gitee地址：https://gitee.com/xiaoym/knife4j
>
> 官方文档：https://doc.xiaominfo.com/
>
> 效果演示：http://knife4j.xiaominfo.com/doc.html

> 在heima-leadnews-common模块中的`pom.xml`文件中引入`knife4j`的依赖,如下：

```xml
<dependency>
    <groupId>com.github.xiaoymin</groupId>
    <artifactId>knife4j-openapi2-spring-boot-starter</artifactId>
    <version>4.1.0</version>
</dependency>
```

> 创建Swagger配置文件

> 在**heima-leadnews-common**模块中新建配置类新建Swagger的配置文件`SwaggerConfiguration.java`文件,创建springfox提供的Docket分组对象,代码如下：
>

```yml
knife4j:
  enable: true
  openapi:
    title: Knife4j官方文档
    description: 我是测试
    email: xiaoymin@foxmail.com
    concat: 八一菜刀
    url: https://docs.xiaominfo.com
    version: v4.0
    license: Apache 2.0
    license-url: https://stackoverflow.com/
    terms-of-service-url: https://stackoverflow.com/
    group:
      test1:
        group-name: 接口
        api-rule: package
        # 只需要设置到com.heima即可，接口在com.heima.user.controller.v1下
        api-rule-resources:
          - com.heima
```

访问，在浏览器输入地址：`http://host:port/doc.html`

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230627154931575.png" alt="image-20230627154931575" style="zoom:80%;" />

## 网关

### 网关概述

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131523380.png" alt="image-20230613152328302" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131523424.png" alt="image-20230613152353357" style="zoom:80%;" />

### 项目搭建

> 在**heima-leadnews-gateway**模块导入以下依赖

> 父工程定义版本，子工程不用管版本
>
> 父工程引入依赖，子工程不用再次引入依赖

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-gateway</artifactId>
    </dependency>
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
    </dependency>
     <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
        </dependency>
    <dependency>
        <groupId>io.jsonwebtoken</groupId>
        <artifactId>jjwt</artifactId>
    </dependency>
</dependencies>
```

> 在heima-leadnews-gateway下创建heima-leadnews-app-gateway微服务

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230627160057844.png" alt="image-20230627160057844" style="zoom:80%;" />

```java
package com.heima.app.gateway;

@SpringBootApplication
@EnableDiscoveryClient  //开启注册中心
public class AppGatewayApplication {

    public static void main(String[] args) {
        SpringApplication.run(AppGatewayApplication.class,args);
    }
}
```

> bootstrap.yml
>

```yaml
server:
  port: 51601
spring:
  application:
    name: leadnews-app-gateway
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.88.101:8848
      config:
        server-addr: 192.168.88.101:8848
        file-extension: yml
```

> 在nacos的配置中心创建dataid为leadnews-app-gateway的yml配置
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230627160613933.png" alt="image-20230627160613933" style="zoom:80%;" />

```yaml
spring:
  cloud:
    gateway:
      # 跨域访问
      globalcors:
        add-to-simple-url-handler-mapping: true
        corsConfigurations:
          '[/**]':
            allowedHeaders: "*"
            allowedOrigins: "*"
            allowedMethods:
              - GET
              - POST
              - DELETE
              - PUT
              - OPTION
      routes:
        # 平台管理
        - id: user
          # 负载均衡，名称要和ApplicationName一致
          uri: lb://leadnews-user
          # 只要/user请求的路径才会匹配到该网关，即后续访问路径都加上这个/user才能匹配到
          # 注意：此时user接口是没有/user这个路径的
          predicates:
            - Path=/user/**
          # 去掉/user路径，对应上面，
          # 如果原始请求路径为"/user/login"，经过该过滤器后，实际请求到达后端服务的路径将为"/login"
          filters:
            - StripPrefix= 1
```

> 环境搭建完成以后，启动项目网关和用户两个服务，使用postman进行测试
>

> 请求地址：:51601/user/doc.html

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230627161001082.png" alt="image-20230627161001082" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230627161948866.png" alt="image-20230627161948866" style="zoom:80%;" />

### 全局过滤器

#### 思路分析

![image-20210705110434492](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131502014.png)

> 1. 用户进入网关开始登陆，网关过滤器进行判断，如果是登录，则路由到后台管理微服务进行登录
> 2. 用户登录成功，后台管理微服务签发JWT TOKEN信息返回给用户
> 3. 用户再次进入网关开始访问，网关过滤器接收用户携带的TOKEN 
> 4. 网关过滤器解析TOKEN ，判断是否有权限，如果有，则放行，如果没有则返回未认证错误
>

#### 具体实现

> 第一：在认证过滤器中需要用到jwt的解析，所以需要把工具类拷贝一份到网关微服务

```java
public class AppJwtUtil {

    // TOKEN的有效期一天（S）
    private static final int TOKEN_TIME_OUT = 3_600;
    // 加密KEY
    private static final String TOKEN_ENCRY_KEY = 
                                "MDk4ZjZiY2Q0NjIxZDM3M2NhZGU0ZTgzMjYyN2I0ZjY";
    // 最小刷新间隔(S)
    private static final int REFRESH_TIME = 300;

    // 生产ID
    public static String getToken(Long id){
        Map<String, Object> claimMaps = new HashMap<>();
        claimMaps.put("id",id);
        long currentTime = System.currentTimeMillis();
        return Jwts.builder()
                .setId(UUID.randomUUID().toString())
                .setIssuedAt(new Date(currentTime))  //签发时间
                .setSubject("system")  //说明
                .setIssuer("heima") //签发者信息
                .setAudience("app")  //接收用户
                .compressWith(CompressionCodecs.GZIP)  //数据压缩方式
                .signWith(SignatureAlgorithm.HS512, generalKey()) //加密方式
                .setExpiration(new Date(currentTime + TOKEN_TIME_OUT * 1000))//过期时间戳
                .addClaims(claimMaps) //cla信息
                .compact();
    }

    // 获取token中的claims信息
    private static Jws<Claims> getJws(String token) {
            return Jwts.parser()
                    .setSigningKey(generalKey())
                    .parseClaimsJws(token);
    }

    // 获取payload body信息
    public static Claims getClaimsBody(String token) {
        try {
            return getJws(token).getBody();
        }catch (ExpiredJwtException e){
            return null;
        }
    }

    // 获取hearder body信息
    public static JwsHeader getHeaderBody(String token) {
        return getJws(token).getHeader();
    }

    // 是否过期 @return -1：有效，0：有效，1：过期，2：过期
    public static int verifyToken(Claims claims) {
        if(claims==null){
            return 1;
        }
        try {
            claims.getExpiration()
                    .before(new Date());
            // 需要自动刷新TOKEN
            if((claims.getExpiration().getTime()-System
                      .currentTimeMillis())>REFRESH_TIME*1000){
                return -1;
            }else {
                return 0;
            }
        } catch (ExpiredJwtException ex) {
            return 1;
        }catch (Exception e){
            return 2;
        }
    }

    // 由字符串生成加密key
    public static SecretKey generalKey() {
        byte[] encodedKey = Base64.getEncoder().encode(TOKEN_ENCRY_KEY.getBytes());
        SecretKey key = new SecretKeySpec(encodedKey, 0, encodedKey.length, "AES");
        return key;
    }

    public static void main(String[] args) {
       /* Map map = new HashMap();
        map.put("id","11");*/
        System.out.println(AppJwtUtil.getToken(1102L));
        Jws<Claims> jws = AppJwtUtil.getJws("eyJhbGciOiJIUzUxMiIsInppcCI6IkdaSVAifQ.H4sIAAAAAAAAADWLQQqEMAwA_5KzhURNt_qb1KZYQSi0wi6Lf9942NsMw3zh6AVW2DYmDGl2WabkZgreCaM6VXzhFBfJMcMARTqsxIG9Z888QLui3e3Tup5Pb81013KKmVzJTGo11nf9n8v4nMUaEY73DzTabjmDAAAA.4SuqQ42IGqCgBai6qd4RaVpVxTlZIWC826QA9kLvt9d-yVUw82gU47HDaSfOzgAcloZedYNNpUcd18Ne8vvjQA");
        Claims claims = jws.getBody();
        System.out.println(claims.get("id"));
    }
}
```

> 第二：在网关微服务中新建全局过滤器：

```java
@Component
@Slf4j
public class AuthorizeFilter implements Ordered, GlobalFilter {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        //1.获取request和response对象
        ServerHttpRequest request = exchange.getRequest();
        ServerHttpResponse response = exchange.getResponse();

        //2.判断是否是登录接口
        if(request.getURI().getPath().contains("/login")){
            //放行
            return chain.filter(exchange);
        }

        //3.获取token
        String token = request.getHeaders().getFirst("token");

        //4.判断token是否存在
        if(StringUtils.isBlank(token)){
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            return response.setComplete();
        }

        //5.判断token是否有效
        try {
            Claims claimsBody = AppJwtUtil.getClaimsBody(token);
            //是否是过期
            int result = AppJwtUtil.verifyToken(claimsBody);
            if(result == 1 || result  == 2){
                response.setStatusCode(HttpStatus.UNAUTHORIZED);
                return response.setComplete();
            }
        }catch (Exception e){
            e.printStackTrace();
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            return response.setComplete();
        }

        //6.放行
        return chain.filter(exchange);
    }

    // 优先级设置  值越小  优先级越高
    @Override
    public int getOrder() {
        return 0;
    }
}
```

> 测试：启动user服务，继续访问其他微服务，会提示需要认证才能访问，这个时候需要在heads中设置设置token才能正常访问。

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230627162730045.png" alt="image-20230627162730045" style="zoom:80%;" />

## 前端集成

### 前端项目部署思路

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131524814.png" alt="image-20230613152457743" style="zoom:80%;" />

通过nginx来进行配置，功能如下

> - 通过nginx的反向代理功能访问后台的网关资源
> - 通过nginx的静态服务器功能访问前端静态页面

### 配置启动nginx

> ①：解压资料文件夹中的压缩包nginx-1.18.0.zip
>
> ②：解压资料文件夹中的前端项目app-web.zip
>
> ③：配置nginx.conf文件

> 在nginx安装的conf目录下新建一个文件夹`leadnews.conf`,在当前文件夹中新建`heima-leadnews-app.conf`文件，heima-leadnews-app.conf配置如下：
>

```nginx
upstream  heima-app-gateway{
    server localhost:51601;
}

server {
	listen 8801;
	location / {
		root H:/app-web/;
		index index.html;
	}
	
	location ~/app/(.*) {
		proxy_pass http://heima-app-gateway/$1;
		proxy_set_header HOST $host;  # 不改变源请求头的值
		proxy_pass_request_body on;  #开启获取请求体
		proxy_pass_request_headers on;  #开启获取请求头
		proxy_set_header X-Real-IP $remote_addr;   # 记录真实发出请求的客户端IP
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  #记录代理信息
	}
}
```

> nginx.conf   把里面注释的内容和静态资源配置相关删除，引入heima-leadnews-app.conf文件加载
>

```nginx
#user  nobody;
worker_processes  1;

events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
	# 引入自定义配置文件
	include leadnews.conf/*.conf;
}
```

> ④ ：启动nginx
>

    在nginx安装包中使用命令提示符打开，输入命令nginx启动项目
    
    可查看进程，检查nginx是否启动:nginx.exe
    
    重新加载配置文件：`nginx -s reload`

> ⑤：打开前端项目进行测试  -- >  :8801
>

     用谷歌浏览器打开，调试移动端模式进行访问

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230627163726334.png" alt="image-20230627163726334" style="zoom:67%;" />

> 点击开始使用，能进入就表示已经成功了

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230627163941154.png" alt="image-20230627163941154" style="zoom:50%;" />

> 访问测试，发现token已经成功保存

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230627164301943.png" alt="image-20230627164301943" style="zoom:80%;" />



# 文章列表

## 效果演示

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131541705.png" alt="image-20230613154115592" style="zoom:80%;" />

文章布局展示

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131526068.png" alt="image-20210419151801252" style="zoom:80%;" />

## 表结构

### 表结构拆分

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131542041.png" alt="image-20230613154202957" style="zoom:80%;" />

> ap_article  文章基本信息表
>

![image-20210419151839634](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131526076.png)

> ap_article_config  文章配置表
>

![image-20210419151854868](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131526079.png)

> ap_article_content 文章内容表
>

![image-20210419151912063](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131526078.png)

### 表关系分析

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131542610.png" alt="image-20230613154222530" style="zoom:80%;" />

### 为什么要拆分

> 垂直分表：将一个表的字段分散到多个表中，每个表存储其中一部分字段。

> 1. 减少IO争抢，减少锁表的几率，查看文章概述与文章详情互不影响
> 2. 发挥高频数据的操作效率，对文章数据操作的高效率不会被操作文章详情数据的低效率所拖累。

> 拆分规则：
>
> 1. 把不常用的字段单独放在一张表
> 2. 把text，blob等大字段拆分出来单独放在一张表
> 3. 经常组合查询的字段单独放在一张表中



## SQL实现

![image-20230628091350053](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628091350053.png)

> 基础SQL实现，注意看时间即可

```sql
# 加载首页，只需要传入时间的上限就行，然后按照最新时间依次排序
select * from ap_article aa
where aa.channel_id = 1
and aa.publish_time < '2063-04-19 00:20:17'
order by aa.publish_time desc
limit 10;

# 加载更多，传入小于当前时间即可
select * from ap_article aa 
where aa.channel_id = 1
and aa.publish_time < '2020-09-07 22:30:09'
order by aa.publish_time desc
limit 10;

# 加载最新
select * from ap_article aa
where aa.channel_id = 1
and aa.publish_time > '2020-09-07 22:30:09'
order by aa.publish_time desc
limit 10;
```

> 联表查看是否已删除或已下架，基于上面SQL进行的改进，方法一样

```sql
# 加载最新
select aa.id id,title,created_time from ap_article aa
left join ap_article_config aac on aa.id = aac.article_id
where aac.is_down !=1 and aac.is_delete !=1
and aa.channel_id = 1
and aa.publish_time > '2020-09-07 22:30:09'
order by aa.publish_time desc
limit 10;
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628092714519.png" alt="image-20230628092714519" style="zoom:67%;" />

## 功能实现

### 接口分析

|          | **加载首页**         | **加载更多**             | **加载最新**            |
| -------- | -------------------- | ------------------------ | ----------------------- |
| 接口路径 | /api/v1/article/load | /api/v1/article/loadmore | /api/v1/article/loadnew |
| 请求方式 | POST                 | POST                     | POST                    |
| 参数     | ArticleHomeDto       | ArticleHomeDto           | ArticleHomeDto          |
| 响应结果 | ResponseResult       | ResponseResult           | ResponseResult          |

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628095901679.png" alt="image-20230628095901679" style="zoom:80%;" />

### 实体类

> 这些都是放在model模块的

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628094104396.png" alt="image-20230628094104396" style="zoom:80%;" />

#### ap_article文章表

```java
@Data
@TableName("ap_article")
public class ApArticle implements Serializable {

    @TableId(value = "id",type = IdType.ASSIGN_ID)
    private Long id;

    //标题
    private String title;

    //作者id
    @TableField("author_id")
    private Long authorId;

    //作者名称
    @TableField("author_name")
    private String authorName;

    //频道id
    @TableField("channel_id")
    private Integer channelId;

    //频道名称
    @TableField("channel_name")
    private String channelName;

    //文章布局  0 无图文章   1 单图文章    2 多图文章
    private Short layout;
    
    //文章标记  0 普通文章   1 热点文章   2 置顶文章   3 精品文章   4 大V 文章
    private Byte flag;

    //文章封面图片 多张逗号分隔
    private String images;

    //标签
    private String labels;

    //点赞数量
    private Integer likes;

    //收藏数量
    private Integer collection;

    //评论数量
    private Integer comment;

    //阅读数量
    private Integer views;

    //省市
    @TableField("province_id")
    private Integer provinceId;

    //市区
    @TableField("city_id")
    private Integer cityId;

    //区县
    @TableField("county_id")
    private Integer countyId;

    //创建时间
    @TableField("created_time")
    private Date createdTime;

    //发布时间
    @TableField("publish_time")
    private Date publishTime;
    
    //同步状态
    @TableField("sync_status")
    private Boolean syncStatus;

    //来源
    private Boolean origin;

    //静态页面地址
    @TableField("static_url")
    private String staticUrl;
}
```

#### ap_article_config文章配置

```java
@Data
@TableName("ap_article_config")
public class ApArticleConfig implements Serializable {

    @TableId(value = "id",type = IdType.ASSIGN_ID)
    private Long id;

    //文章id
    @TableField("article_id")
    private Long articleId;

    // 是否可评论 true: 可以评论   1 false: 不可评论  0
    @TableField("is_comment")
    private Boolean isComment;

    // 是否转发 true: 可以转发   1 false: 不可转发  0
    @TableField("is_forward")
    private Boolean isForward;

    // 是否下架 true: 下架   1 false: 没有下架  0
    @TableField("is_down")
    private Boolean isDown;

    // 是否已删除 true: 删除   1 false: 没有删除  0
    @TableField("is_delete")
    private Boolean isDelete;
}
```

#### ap_article_content 文章内容

```java
@Data
@TableName("ap_article_content")
public class ApArticleContent implements Serializable {

    @TableId(value = "id",type = IdType.ASSIGN_ID)
    private Long id;

    //文章id
    @TableField("article_id")
    private Long articleId;

    //文章内容
    private String content;
}
```

#### ArticleHomeDto参数转换

```java
@Data
public class ArticleHomeDto {
    // 最大时间
    Date maxBehotTime;
    // 最小时间
    Date minBehotTime;
    // 分页size
    Integer size;
    // 频道ID
    String tag;
}
```

#### ArticleConstants常量类

> 表示加载更多还是加载最新还是默认

```java
package com.heima.common.constants;

public class ArticleConstants {
    public static final Short LOADTYPE_LOAD_MORE = 1;
    public static final Short LOADTYPE_LOAD_NEW = 2;
    public static final String DEFAULT_TAG = "__all__";

}
```



### heima-leadnews-article

> 创建maven模块，内容和user的差不多

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628093529331.png" alt="image-20230628093529331" style="zoom:80%;" />

<font color='red'>注意：需要在heima-leadnews-service的pom文件夹中添加子模块信息，如下：</font>

```xml
<modules>
    <module>heima-leadnews-user</module>
    <module>heima-leadnews-article</module>
</modules>
```

> 在idea中的maven中更新一下，如果工程还是灰色的，需要在重新添加文章微服务的pom文件
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131526647.png" alt="image-20210420001037992" style="zoom:80%;" />

### ArticleApplication

```java
@SpringBootApplication
@EnableDiscoveryClient
@MapperScan("com.heima.article.mapper")
public class ArticleApplication {

    public static void main(String[] args) {
        SpringApplication.run(ArticleApplication.class,args);
    }

    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
}
```

### bootstrap.yml

```yml
server:
  port: 51802
spring:
  application:
    name: leadnews-article
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.88.101:8848
      config:
        server-addr: 192.168.88.101:8848
        file-extension: yml
```

### nacos配置

> 需要在nacos中添加对应的配置

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628093758096.png" alt="image-20230628093758096" style="zoom:67%;" />

```yaml
spring:
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    # useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC
    url: jdbc:mysql://localhost:3306/leadnews_article?serverTimezone=UTC
    username: root
    password: 123456
# 设置Mapper接口所对应的XML文件位置，如果你在Mapper接口中有自定义方法，需要进行该配置
mybatis-plus:
  mapper-locations: classpath*:mapper/*.xml
  # 设置别名包扫描路径，通过该属性可以给包中的类注册别名
  type-aliases-package: com.heima.model.article.pojos
```

### ApArticleMapper

```java
public interface ApArticleMapper extends BaseMapper<ApArticle> {
	// 加载文章列表
    public List<ApArticle> loadArticleList(@Param("dto") ArticleHomeDto dto, 
                                           @Param("type") Short type);
}
```

> 对应的映射文件，在resources中新建mapper/ApArticleMapper.xml     如下配置：
>

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.heima.article.mapper.ApArticleMapper">

    <resultMap id="resultMap" type="com.heima.model.article.pojos.ApArticle">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="author_id" property="authorId"/>
        <result column="author_name" property="authorName"/>
        <result column="channel_id" property="channelId"/>
        <result column="channel_name" property="channelName"/>
        <result column="layout" property="layout"/>
        <result column="flag" property="flag"/>
        <result column="images" property="images"/>
        <result column="labels" property="labels"/>
        <result column="likes" property="likes"/>
        <result column="collection" property="collection"/>
        <result column="comment" property="comment"/>
        <result column="views" property="views"/>
        <result column="province_id" property="provinceId"/>
        <result column="city_id" property="cityId"/>
        <result column="county_id" property="countyId"/>
        <result column="created_time" property="createdTime"/>
        <result column="publish_time" property="publishTime"/>
        <result column="sync_status" property="syncStatus"/>
        <result column="static_url" property="staticUrl"/>
    </resultMap>
    <select id="loadArticleList" resultMap="resultMap">
        SELECT
        aa.*
        FROM
        `ap_article` aa
        LEFT JOIN ap_article_config aac ON aa.id = aac.article_id
        <where>
            and aac.is_delete != 1
            and aac.is_down != 1
            <!-- 为1为加载更多，小于传过来的时间 -->
            <if test="type != null and type == 1">
                and aa.publish_time <![CDATA[<]]> #{dto.minBehotTime}
            </if>
            <!-- 为2为加载最新，大于传过来的时间 -->
            <if test="type != null and type == 2">
                and aa.publish_time <![CDATA[>]]> #{dto.maxBehotTime}
            </if>
            <!-- 频道：__all__没有传过来频道,__all__，参数是自定义的 -->
            <if test="dto.tag != '__all__'">
                and aa.channel_id = #{dto.tag}
            </if>
        </where>
        order by aa.publish_time desc
        limit #{dto.size}
    </select>

</mapper>
```

### ApArticleService

```java
package com.heima.article.service;

public interface ApArticleService extends IService<ApArticle> {
    // 根据参数加载文章列表 @param loadtype 1为加载更多  2为加载最新
    ResponseResult load(Short loadtype, ArticleHomeDto dto);
}
```

```java
package com.heima.article.service.impl;


@Service
@Slf4j
public class ApArticleServiceImpl extends ServiceImpl<ApArticleMapper, ApArticle> 
                                  implements ApArticleService {

    // 单页最大加载的数字
    private final static short MAX_PAGE_SIZE = 50;

    @Autowired
    private ApArticleMapper apArticleMapper;

    // 根据参数加载文章列表 @param loadtype 1为加载更多  2为加载最新
    @Override
    public ResponseResult load(Short loadtype, ArticleHomeDto dto) {
        //1.校验参数
        Integer size = dto.getSize();
        if(size == null || size == 0){
            size = 10;
        }
        size = Math.min(size,MAX_PAGE_SIZE);
        dto.setSize(size);

        //类型参数检验
        if(!loadtype.equals(ArticleConstants.LOADTYPE_LOAD_MORE)&&
           !loadtype.equals(ArticleConstants.LOADTYPE_LOAD_NEW)) {
            loadtype = ArticleConstants.LOADTYPE_LOAD_MORE;
        }
        
        //文章频道校验
        if(StringUtils.isEmpty(dto.getTag())){
            dto.setTag(ArticleConstants.DEFAULT_TAG);
        }
        //时间校验
        if(dto.getMaxBehotTime() == null) dto.setMaxBehotTime(new Date());
        if(dto.getMinBehotTime() == null) dto.setMinBehotTime(new Date());
        //2.查询数据
        List<ApArticle> apArticles = apArticleMapper.loadArticleList(dto, loadtype);
        //3.结果封装
        ResponseResult responseResult = ResponseResult.okResult(apArticles);
        return responseResult;
    } 
}
```

### ArticleHomeController

```java
package com.heima.article.controller.v1;

@RestController
@RequestMapping("/api/v1/article")
public class ArticleHomeController {

    @Autowired
    private ApArticleService apArticleService;

    @PostMapping("/load")
    public ResponseResult load(@RequestBody ArticleHomeDto dto) {
        return apArticleService.load(ArticleConstants.LOADTYPE_LOAD_MORE,dto);
    }

    @PostMapping("/loadmore")
    public ResponseResult loadMore(@RequestBody ArticleHomeDto dto) {
        return apArticleService.load(ArticleConstants.LOADTYPE_LOAD_MORE,dto);
    }

    @PostMapping("/loadnew")
    public ResponseResult loadNew(@RequestBody ArticleHomeDto dto) {
        return apArticleService.load(ArticleConstants.LOADTYPE_LOAD_NEW,dto);
    }
}
```

### 网关配置

第一：在app网关的微服务的nacos的配置中心添加文章微服务的路由，完整配置如下：

```yaml
spring:
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]': # 匹配所有请求
            allowedOrigins: "*" #跨域处理 允许所有的域
            allowedMethods: # 支持的方法
              - GET
              - POST
              - PUT
              - DELETE
      routes:
        # 用户微服务
        - id: user
          uri: lb://leadnews-user
          predicates:
            - Path=/user/**
          filters:
            - StripPrefix= 1
        # 文章微服务
        - id: article
          uri: lb://leadnews-article
          predicates:
            - Path=/article/**
          filters:
            - StripPrefix= 1
```

## 接口测试

> 启动nginx，直接使用前端项目测试，启动文章微服务，用户微服务、app网关微服务

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628102627486.png" alt="image-20230628102627486" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628102615239.png" alt="image-20230628102615239" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628102831758.png" alt="image-20230628102831758" style="zoom:80%;" />



# Freemarker

> FreeMarker 是一款 模板引擎： 即一种基于模板和要改变的数据， 并用来生成输出文本(HTML网页，电子邮件，配置文件，源代码等)的通用工具。 它不是面向最终用户的，而是一个Java类库，是一款程序员可以嵌入他们所开发产品的组件。
>

> 模板编写为FreeMarker Template Language (FTL)。它是简单的，专用的语言， *不是* 像PHP那样成熟的编程语言。 那就意味着要准备数据在真实编程语言中来显示，比如数据库查询和业务运算， 之后模板显示已经准备好的数据。在模板中，你可以专注于如何展现数据， 而在模板之外可以专注于要展示什么数据。 
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131531740.png" alt="image-20230613153148656" style="zoom:80%;" />

> 常用的java模板引擎还有哪些？
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131532087.png" alt="image-20230613153202998" style="zoom:80%;" />

> - Jsp 为 Servlet 专用，不能单独进行使用。
> - Thymeleaf 为新技术，功能较为强大，但是执行的效率比较低。
> - Velocity从2010年更新完 2.0 版本后，便没有在更新。

## 快速入门

> freemarker作为springmvc一种视图格式，默认情况下SpringMVC支持freemarker视图格式。需要创建Spring Boot+Freemarker工程用于测试模板。
>

### 测试工程

> 创建一个freemarker-demo 的测试工程专门用于freemarker的功能测试与模板的测试。

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628103307069.png" alt="image-20230628103307069" style="zoom:80%;" />

### 依赖坐标

> 在freemarker-demo中

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-freemarker</artifactId>
    </dependency>

    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
    </dependency>
    <!-- lombok -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
    </dependency>

    <!-- apache 对 java io 的封装工具库 -->
    <dependency>
        <groupId>org.apache.commons</groupId>
        <artifactId>commons-io</artifactId>
        <version>1.3.2</version>
    </dependency>
</dependencies>
```

### 配置文件

> 配置application.yml
>

```yaml
server:
  port: 8881 #服务端口
spring:
  application:
    name: freemarker-demo #指定服务名
  freemarker:
    cache: false  #关闭模板缓存，方便测试
    settings:
      # #检查模板更新延迟时间，设置为0表示立即检查，如果时间大于0会有缓存不方便进行模板测试
      template_update_delay: 0 
    suffix: .ftl   #指定Freemarker模板文件的后缀名
```

### 实体类

> 在freemarker的测试工程下创建模型类型用于测试
>

```java
@Data
public class Student {
    private String name;//姓名
    private int age;//年龄
    private Date birthday;//生日
    private Float money;//钱包
}
```

### 控制器+模板

创建Controller类，向Map中添加name，最后返回模板文件。

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131532686.png" alt="image-20230613153249584" style="zoom:80%;" />

```java
@Controller
public class HelloController {

    @GetMapping("/basic")
    public String test(Model model) {
        //1.纯文本形式的参数
        model.addAttribute("name", "freemarker");
        //2.实体类相关的参数
        Student student = new Student();
        student.setName("小明");
        student.setAge(18);
        model.addAttribute("stu", student);
        return "01-basic";
    }
}
```

> 01-basic.ftl，使用插值表达式填充数据

> 在resources下创建templates，此目录为freemarker的默认模板存放目录。

> 在templates下创建模板文件 01-basic.ftl ，模板中的插值表达式最终会被freemarker替换成具体的数据。

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hello World!</title>
</head>
<body>
<b>普通文本 String 展示：</b><br><br>
Hello ${name} <br>
<hr>
<b>对象Student中的数据展示：</b><br/>
姓名：${stu.name}<br/>
年龄：${stu.age}
<hr>
</body>
</html>
```

### 启动类

```java
@SpringBootApplication
public class FreemarkerDemotApplication {
    public static void main(String[] args) {
        SpringApplication.run(FreemarkerDemotApplication.class,args);
    }
}
```

### 测试freemarker

请求：:8881/basic

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628104708984.png" alt="image-20230628104708984" style="zoom:80%;" />

## 基础语法

>   注释，即<#--  -->，介于其之间的内容会被freemarker忽略
>

```velocity
<#--我是一个freemarker注释-->
```

>   插值（Interpolation）：即 **`${..}`** 部分,freemarker会用真实的值代替**`${..}`**
>

```velocity
Hello ${name}
```

> FTL指令：和HTML标记类似，名字前加#予以区分，Freemarker会解析标签中的表达式或逻辑。
>

```velocity
<# >FTL指令</#> 
```

> 文本信息，这些不是freemarker的注释、插值、FTL指令的内容会被freemarker忽略，直接输出内容。
>

```velocity
<#--freemarker中的普通文本-->
我是一个普通的文本
```

## 集合指令（List和Map）

> 在HelloController中新增如下方法：
>

```java
@GetMapping("/list")
public String list(Model model){

    //------------------------------------
    Student stu1 = new Student();
    stu1.setName("小强");
    stu1.setAge(18);
    stu1.setMoney(1000.86f);
    stu1.setBirthday(new Date());

    //小红对象模型数据
    Student stu2 = new Student();
    stu2.setName("小红");
    stu2.setMoney(200.1f);
    stu2.setAge(19);

    //将两个对象模型数据存放到List集合中
    List<Student> stus = new ArrayList<>();
    stus.add(stu1);
    stus.add(stu2);

    //向model中存放List集合数据
    model.addAttribute("stus",stus);

    //------------------------------------

    //创建Map数据
    HashMap<String,Student> stuMap = new HashMap<>();
    stuMap.put("stu1",stu1);
    stuMap.put("stu2",stu2);
    // 3.1 向model中存放Map数据
    model.addAttribute("stuMap", stuMap);

    return "02-list";
}
```

> 模板：在templates中新增`02-list.ftl`文件
>

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hello World!</title>
</head>
<body>
    
<#-- list 数据的展示 -->
<b>展示list中的stu数据:</b>
<br>
<br>
<table>
    <tr>
        <td>序号</td>
        <td>姓名</td>
        <td>年龄</td>
        <td>钱包</td>
    </tr>
    <#list stus as stu>
        <tr>
            <td>${stu_index+1}</td>
            <td>${stu.name}</td>
            <td>${stu.age}</td>
            <td>${stu.money}</td>
        </tr>
    </#list>

</table>
<hr>
    
<#-- Map 数据的展示 -->
<b>map数据的展示：</b>
<br/><br/>
<a href="###">方式一：通过map['keyname'].property</a><br/>
输出stu1的学生信息：<br/>
姓名：${stuMap['stu1'].name}<br/>
年龄：${stuMap['stu1'].age}<br/>
<br/>
<a href="###">方式二：通过map.keyname.property</a><br/>
输出stu2的学生信息：<br/>
姓名：${stuMap.stu2.name}<br/>
年龄：${stuMap.stu2.age}<br/>

<br/>
<a href="###">遍历map中两个学生信息：</a><br/>
<table>
    <tr>
        <td>序号</td>
        <td>姓名</td>
        <td>年龄</td>
        <td>钱包</td>
    </tr>
    <#list stuMap?keys as key >
        <tr>
            <td>${key_index}</td>
            <td>${stuMap[key].name}</td>
            <td>${stuMap[key].age}</td>
            <td>${stuMap[key].money}</td>
        </tr>
    </#list>
</table>
<hr>
 
</body>
</html>
```

> 代码解释：${k_index}：index：得到循环的下标，使用方法是在stu后边加"_index"，它的值是从0开始
>

## if指令

> if 指令即判断指令，是常用的FTL指令，freemarker在解析时遇到if会进行判断，条件为真则输出if中间的内容，否则跳过内容不再输出。指令格式

```html
<#if ></if>
```

> 数据模型：使用list指令中测试数据模型，判断名称为小红的数据字体显示为红色。
>

```velocity
<table>
    <tr>
        <td>姓名</td>
        <td>年龄</td>
        <td>钱包</td>
    </tr>
    <#list stus as stu >
        <#if stu.name='小红'>
            <tr style="color: red">
                <td>${stu_index}</td>
                <td>${stu.name}</td>
                <td>${stu.age}</td>
                <td>${stu.money}</td>
            </tr>
            <#else >
            <tr>
                <td>${stu_index}</td>
                <td>${stu.name}</td>
                <td>${stu.age}</td>
                <td>${stu.money}</td>
            </tr>
        </#if>
    </#list>
</table>
```

> 姓名为“小强”则字体颜色显示为红色。
>

![1539947776259](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131526966.png)

## 运算符

### 算数运算符

FreeMarker表达式中完全支持算术运算,FreeMarker支持的算术运算符包括:

> - 加法： `+`
> - 减法： `-`
> - 乘法： `*`
> - 除法： `/`
> - 求模 (求余)： `%`

模板代码

```html
<b>算数运算符</b>
<br/><br/>
    100+5 运算：  ${100 + 5 }<br/>
    100 - 5 * 5运算：${100 - 5 * 5}<br/>
    5 / 2运算：${5 / 2}<br/>
    12 % 10运算：${12 % 10}<br/>
<hr>
```

> 除了 + 运算以外，其他的运算只能和 number 数字类型的计算。
>

### 比较运算符

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131534838.png" alt="image-20230613153403748" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131534458.png" alt="image-20230613153417375" style="zoom:80%;" />

> - **`=`**或者**`==`**:判断两个值是否相等. 
> - **`!=`**:判断两个值是否不等. 
> - **`>`**或者**`gt`**:判断左边值是否大于右边值 
> - **`>=`**或者**`gte`**:判断左边值是否大于等于右边值 
> - **`<`**或者**`lt`**:判断左边值是否小于右边值 
> - **`<=`**或者**`lte`**:判断左边值是否小于等于右边值 

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hello World!</title>
</head>
<body>
    <b>比较运算符</b>
    <br/>
    <br/>

    <dl>
        <dt> =/== 和 != 比较：</dt>
        <dd>
            <#if "xiaoming" == "xiaoming">
                字符串的比较 "xiaoming" == "xiaoming"
            </#if>
        </dd>
        <dd>
            <#if 10 != 100>
                数值的比较 10 != 100
            </#if>
        </dd>
    </dl>

    <dl>
        <dt>其他比较</dt>
        <dd>
            <#if 10 gt 5 >
                形式一：使用特殊字符比较数值 10 gt 5
            </#if>
        </dd>
        <dd>
            <#-- 日期的比较需要通过?date将属性转为data类型才能进行比较 -->
            <#if (date1?date >= date2?date)>
                形式二：使用括号形式比较时间 date1?date >= date2?date
            </#if>
        </dd>
    </dl>

    <br/>
<hr>
</body>
</html>
```

> Controller 的 数据模型代码
>

```java
@GetMapping("operation")
public String testOperation(Model model) {
    //构建 Date 数据
    Date now = new Date();
    model.addAttribute("date1", now);
    model.addAttribute("date2", now);   
    return "03-operation";
}
```

**比较运算符注意**

> - **`=`**和**`!=`**可以用于字符串、数值和日期来比较是否相等
> - **`=`**和**`!=`**两边必须是相同类型的值,否则会产生错误
> - 字符串 **`"x"`** 、**`"x "`** 、**`"X"`**比较是不等的.因为FreeMarker是精确比较
> - 其它的运行符可以作用于数字和日期,但不能作用于字符串
> - 使用**`gt`**等字母运算符代替**`>`**会有更好的效果,因为 FreeMarker会把**`>`**解释成FTL标签的结束字符
> - 可以使用括号来避免这种情况,如:**`<#if (x>y)>`**

### 逻辑运算符

> - 逻辑与:&& 
> - 逻辑或:|| 
> - 逻辑非:! 

> 逻辑运算符只能作用于布尔值,否则将产生错误 。
>

```html
<b>逻辑运算符</b>
    <br/>
    <br/>
    <#if (10 lt 12 )&&( 10  gt  5 )  >
        (10 lt 12 )&&( 10  gt  5 )  显示为 true
    </#if>
    <br/>
    <br/>
    <#if !false>
        false 取反为true
    </#if>
<hr>
```

## 空值处理

> **判断某变量是否存在使用 “??”**

> 用法为:variable??,如果该变量存在,返回true,否则返回false 
>

> 例：为防止stus为空报错可以加上判断如下：
>

```velocity
<#if stus??>
<#list stus as stu>
	......
</#list>
</#if>
```

> **缺失变量默认值使用 “!”**

> 使用!要以指定一个默认值，当变量为空时显示默认值，例：  ${name!''}表示如果name为空显示空字符串。如果是嵌套对象则建议使用（）括起来，例： ${(stu.bestFriend.name)!''}表示，如果stu或bestFriend或name为空默认显示空字符串。
>

## 内建函数

内建函数语法格式： **`变量+?+函数名称`**  

> **某个集合的大小**：**`${集合名?size}`**

> **日期格式化**

> 显示年月日: **`${today?date}`** 
> 显示时分秒：**`${today?time}`**   
> 显示日期+时间：**`${today?datetime}`**   
> 自定义格式化：  **`${today?string("yyyy年MM月")}`**

> **内建函数`c`**

> model.addAttribute("point", 102920122);
>
> point是数字型，使用${point}会显示这个数字的值，每三位使用逗号分隔。
>
> 如果不想显示为每三位分隔的数字，可以使用c函数将数字型转成字符串输出**`${point?c}`**

> **将json字符串转成对象**：其中用到了 assign标签，assign的作用是定义一个变量。

```velocity
<#assign text="{'bank':'工商银行','account':'10101920201920212'}" />
<#assign data=text?eval />
开户行：${data.bank}  账号：${data.account}
```

内建函数模板页面：04-innerFunc.ftl

```velocity
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>inner Function</title>
</head>
<body>

    <b>获得集合大小</b><br>

    集合大小：${stus?size}
    <hr>

    <b>获得日期</b><br>

    显示年月日: ${today?date}       <br>

    显示时分秒：${today?time}<br>

    显示日期+时间：${today?datetime}<br>

    自定义格式化：  ${today?string("yyyy年MM月")}<br>

    <hr>
    <b>内建函数C</b><br>
    没有C函数显示的数值：${point} <br>

    有C函数显示的数值：${point?c}

    <hr>

    <b>声明变量assign</b><br>
    <#assign text="{'bank':'工商银行','account':'10101920201920212'}" />
    <#assign data=text?eval />
    开户行：${data.bank}  账号：${data.account}

<hr>
</body>
</html>
```

内建函数Controller数据模型：

```java
@GetMapping("innerFunc")
public String testInnerFunc(Model model) {
    //1.1 小强对象模型数据
    Student stu1 = new Student();
    stu1.setName("小强");
    stu1.setAge(18);
    stu1.setMoney(1000.86f);
    stu1.setBirthday(new Date());
    //1.2 小红对象模型数据
    Student stu2 = new Student();
    stu2.setName("小红");
    stu2.setMoney(200.1f);
    stu2.setAge(19);
    //1.3 将两个对象模型数据存放到List集合中
    List<Student> stus = new ArrayList<>();
    stus.add(stu1);
    stus.add(stu2);
    model.addAttribute("stus", stus);
    // 2.1 添加日期
    Date date = new Date();
    model.addAttribute("today", date);
    // 3.1 添加数值
    model.addAttribute("point", 102920122);
    return "04-innerFunc";
}
```

> 访问：:8881/innerFunc
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628110732752.png" alt="image-20230628110732752" style="zoom:80%;" />

## 静态化生成

> 之前的测试都是SpringMVC将Freemarker作为视图解析器（ViewReporter）来集成到项目中，工作中，有的时候需要使用Freemarker原生Api来生成静态内容，下面一起来学习下原生Api生成文本文件。
>

### 需求分析

> 使用freemarker原生Api将页面生成html文件，本节测试html文件生成的方法：
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628111701436.png" alt="image-20230628111701436" style="zoom:80%;" />

### 静态化测试 

根据模板文件生成html文件

> ①：修改application.yml文件，添加以下模板存放位置的配置信息，完整配置如下：
>

```yaml
server:
  port: 8881 #服务端口
spring:
  application:
    name: freemarker-demo #指定服务名
  freemarker:
    cache: false  #关闭模板缓存，方便测试
    settings:
      #检查模板更新延迟时间，设置为0表示立即检查，如果时间大于0会有缓存不方便进行模板测试
      template_update_delay: 0 
    suffix: .ftl               #指定Freemarker模板文件的后缀名
    template-loader-path: classpath:/templates   #模板存放位置
```

> ②：在test下创建测试类

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628111823248.png" alt="image-20230628111823248" style="zoom:80%;" />

```java
package com.heima.freemarker.test;

@SpringBootTest
public class FreemarkerTest {

    @Autowired
    private Configuration configuration;

    @Test
    public void test() throws IOException, TemplateException {
        //freemarker的模板对象，获取模板，见上面的模板
        Template template = configuration.getTemplate("02-list.ftl");
        Map params = getData();
        //合成
        //第一个参数 数据模型
        //第二个参数  输出流
        template.process(params, new FileWriter("d:/list.html"));
    }

    private Map getData() {
        Map<String, Object> map = new HashMap<>();

        //小强对象模型数据
        Student stu1 = new Student();
        stu1.setName("小强");
        stu1.setAge(18);
        stu1.setMoney(1000.86f);
        stu1.setBirthday(new Date());

        //小红对象模型数据
        Student stu2 = new Student();
        stu2.setName("小红");
        stu2.setMoney(200.1f);
        stu2.setAge(19);

        //将两个对象模型数据存放到List集合中
        List<Student> stus = new ArrayList<>();
        stus.add(stu1);
        stus.add(stu2);

        //向map中存放List集合数据
        map.put("stus", stus);

        //创建Map数据
        HashMap<String, Student> stuMap = new HashMap<>();
        stuMap.put("stu1", stu1);
        stuMap.put("stu2", stu2);
        //向map中存放Map数据
        map.put("stuMap", stuMap);
        //返回Map
        return map;
    }
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628140922318.png" alt="image-20230628140922318" style="zoom:80%;" />

# MinIO 

## MinIO概述 

> MinIO基于Apache License v2.0开源协议的对象存储服务，可以做为云存储的解决方案用来保存海量的图片，视频，文档。由于采用Golang实现，服务端可以工作在Windows,Linux, OS X和FreeBSD上。配置简单，基本是复制可执行程序，单行命令可以运行起来。**S3 （ Simple Storage Service简单存储服务）**
>

> MinIO兼容亚马逊S3云存储服务接口，非常适合于存储大容量非结构化的数据，例如图片、视频、日志文件、备份数据和容器/虚拟机镜像等，而一个对象文件可以是任意大小，从几kb到最大5T不等。
>

### 基本概念

> 官网文档：http://docs.minio.org.cn/docs/

> - bucket – 类比于文件系统的目录
> - Object – 类比文件系统的文件
> - Keys – 类比文件名

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131537522.png" alt="image-20230613153738431" style="zoom:67%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131538401.png" alt="image-20230613153812305" style="zoom:80%;" />

### MinIO特点 

> - 数据保护：Minio使用Minio Erasure Code（纠删码）来防止硬件故障。即便损坏一半以上的driver，但是仍然可以从中恢复。
>
> - 高性能：作为高性能对象存储，在标准硬件条件下它能达到55GB/s的读、35GB/s的写速率
>
> - 可扩容：不同MinIO集群可以组成联邦，并形成一个全局的命名空间，并跨越多个数据中心
>
> - SDK支持：基于Minio轻量的特点，它得到类似Java、Python或Go等语言的sdk支持
>
> - 有操作页面：面向用户友好的简单操作界面，非常方便的管理Bucket及里面的文件资源
>
> - 功能简单：这一设计原则让MinIO不容易出错、更快启动
>
> - 丰富的API：支持文件资源的分享连接及分享链接的过期策略、存储桶操作、文件列表访问及文件上传下载的基本功能等。
>
> - 文件变化主动通知：存储桶（Bucket）如果发生改变,比如上传对象和删除对象，可以使用存储桶事件通知机制进行监控，并通过以下方式发布出去:AMQP、MQTT、Elasticsearch、Redis、NATS、MySQL、Kafka、Webhooks等。


## 开箱使用 

### 安装启动   

> [Linux 快速入门 — MinIO 文档](https://docs.min.io/minio/baremetal/quickstart/linux.html#quickstart-linux)

```yaml
docker run -p 9000:9000 --name minio -d --restart=always -e "MINIO_ACCESS_KEY=minio" -e "MINIO_SECRET_KEY=minio123" -v /home/data:/data -v /home/config:/root/.minio minio/minio server /data
```

```c
wget https://dl.min.io/server/minio/release/linux-amd64/minio
chmod +x minio
sudo mv minio /usr/local/bin/
```

```apl
# 文件保存位置
mkdir ~/minio
# 在任意位置启动(前台运行，不推荐)
minio server ~/minio --console-address :9090
# 后台运行，推荐
nohup minio server ~/minio --console-address :9090  >out.log 2>&1 &
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.5.13/202205310941934.png" alt="image-20220531094119725" style="zoom:67%;" />

> 进行访问
>

```c
http://192.168.88.101:9000
# 账号和密码
minioadmin minioadmin
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.5.13/202205131527035.png" alt="image-20220513152713944" style="zoom:67%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2022.5.13/202205131527580.png" alt="image-20220513152727503" style="zoom:80%;" />

### 自定义账号密码

```sh
vim /etc/profile
```

```sh
export MINIO_ACCESS_KEY=renshuo(自行设置) 
export MINIO_SECRET_KEY=315217(自行设置)
```

```sh
source /etc/profile
```

### 管理控制台   

> 假设我们的服务器地址为http://192.168.88.101:9000 即可进入登录界面。
>

![image-20210417102204739](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131526093.png)

> 点击右下角的“+”号 ，点击下面的图标，创建一个桶
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628144418561.png" alt="image-20230628144418561" style="zoom:80%;" />

### 权限设置

> 如果文件上传成功后不能访问，则需要设置bucket的访问权限

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628144503722.png" alt="image-20230628144503722" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628144514184.png" alt="image-20230628144514184" style="zoom:80%;" />

### 上传访问测试

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628144937496.png" alt="image-20230628144937496" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628144924515.png" alt="image-20230628144924515" style="zoom:80%;" />

> http://192.168.88.101:9000/heimaleadnews/g4_clear.png

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628144857251.png" alt="image-20230628144857251" style="zoom:80%;" />

## 快速入门

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131540497.png" alt="image-20230613154023409" style="zoom: 67%;" />

### 创建工程

> 创建minio-demo,对应pom如下

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628145052786.png" alt="image-20230628145052786" style="zoom:80%;" />

### 依赖坐标

```xml
<dependencies>
    <dependency>
        <groupId>io.minio</groupId>
        <artifactId>minio</artifactId>
        <version>7.1.0</version>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
    </dependency>
</dependencies>
```

### MinIOApplication

```java
@SpringBootApplication
public class MinIOApplication {

    public static void main(String[] args) {
        SpringApplication.run(MinIOApplication.class,args);
    }
}
```

> 创建测试类，上传html文件

### MinIOTest

```java
public class MinIOTest {
    public static void main(String[] args) {
        // 读取文件流
        FileInputStream fileInputStream = null;
        try {
            fileInputStream =  new FileInputStream("D:\\springbootProject\\list.html");
            //1.创建minio链接客户端
            MinioClient minioClient = MinioClient.builder()
                    .credentials("minioadmin", "minioadmin")
                    .endpoint("http://192.168.88.101:9000").build();
            //2.上传，传入参数
            PutObjectArgs putObjectArgs = PutObjectArgs.builder()
                    .object("list.html")//文件名
                    .contentType("text/html")//文件类型
                    .bucket("heimaleadnews")//桶名词  与minio创建的名词一致
                     // -1表示所有内容
                    .stream(fileInputStream, fileInputStream.available(), -1) //文件流
                    .build();
            // 彻底上传
            minioClient.putObject(putObjectArgs);
        } catch (Exception ex) {
            ex.printStackTrace();
        }
    }
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628150244561.png" alt="image-20230628150244561" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628150411305.png" alt="image-20230628150411305" style="zoom:80%;" />

## 封装starter⭐

### 模块创建

> heima-leadnews-starter/heima-file-starter

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628150908873.png" alt="image-20230628150908873" style="zoom:80%;" />

### 依赖坐标

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-autoconfigure</artifactId>
    </dependency>
    <dependency>
        <groupId>io.minio</groupId>
        <artifactId>minio</artifactId>
        <version>7.1.0</version>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-configuration-processor</artifactId>
        <optional>true</optional>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
</dependencies>
```

### 配置类

> MinIOConfigProperties
>

```java
package com.heima.file.config;

@Data
@ConfigurationProperties(prefix = "minio")  // 文件上传 配置前缀file.oss
public class MinIOConfigProperties implements Serializable {

    private String accessKey;
    private String secretKey;
    private String bucket;
    private String endpoint;
    private String readPath;
}
```

> MinIOConfig
>

```java
package com.heima.file.config;


@Data
@Configuration
@EnableConfigurationProperties({MinIOConfigProperties.class})
//当引入FileStorageService接口时
@ConditionalOnClass(FileStorageService.class)
public class MinIOConfig {

   @Autowired
   private MinIOConfigProperties minIOConfigProperties;

    @Bean
    public MinioClient buildMinioClient(){
        return MinioClient
                .builder()
                .credentials(minIOConfigProperties.getAccessKey(), 
                             minIOConfigProperties.getSecretKey())
                .endpoint(minIOConfigProperties.getEndpoint())
                .build();
    }
}
```

### Service⭐

> FileStorageService
>

```java
package com.heima.file.service;

public interface FileStorageService {


    /**
     *  上传图片文件
     * @param prefix  文件前缀
     * @param filename  文件名
     * @param inputStream 文件流
     * @return  文件全路径
     */
    public String uploadImgFile(String prefix, String filename,InputStream inputStream);

    /**
     *  上传html文件
     * @param prefix  文件前缀
     * @param filename   文件名
     * @param inputStream  文件流
     * @return  文件全路径
     */
    public String uploadHtmlFile(String prefix, String filename,InputStream inputStream);

    /**
     * 删除文件
     * @param pathUrl  文件全路径
     */
    public void delete(String pathUrl);

    /**
     * 下载文件
     * @param pathUrl  文件全路径
     * @return
     *
     */
    public byte[]  downLoadFile(String pathUrl);

}
```

> MinIOFileStorageService
>

```java
package com.heima.file.service.impl;

@Slf4j
@EnableConfigurationProperties(MinIOConfigProperties.class)
@Import(MinIOConfig.class)
public class MinIOFileStorageService implements FileStorageService {

    @Autowired
    private MinioClient minioClient;

    @Autowired
    private MinIOConfigProperties minIOConfigProperties;

    private final static String separator = "/";

    /**
     * @param dirPath
     * @param filename  yyyy/mm/dd/file.jpg
     * @return
     */
    public String builderFilePath(String dirPath,String filename) {
        StringBuilder stringBuilder = new StringBuilder(50);
        if(!StringUtils.isEmpty(dirPath)){
            stringBuilder.append(dirPath).append(separator);
        }
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy/MM/dd");
        String todayStr = sdf.format(new Date());
        stringBuilder.append(todayStr).append(separator);
        stringBuilder.append(filename);
        return stringBuilder.toString();
    }

    /**
     *  上传图片文件
     * @param prefix  文件前缀
     * @param filename  文件名
     * @param inputStream 文件流
     * @return  文件全路径
     */
    @Override
    public String uploadImgFile(String prefix, String filename,InputStream inputStream) {
        String filePath = builderFilePath(prefix, filename);
        try {
            PutObjectArgs putObjectArgs = PutObjectArgs.builder()
                    .object(filePath)
                    .contentType("image/jpg")
                    .bucket(minIOConfigProperties.getBucket())
                    .stream(inputStream,inputStream.available(),-1)
                    .build();
            minioClient.putObject(putObjectArgs);
            StringBuilder urlPath = new StringBuilder(minIOConfigProperties
                                                      .getReadPath());
            urlPath.append(separator+minIOConfigProperties.getBucket());
            urlPath.append(separator);
            urlPath.append(filePath);
            return urlPath.toString();
        }catch (Exception ex){
            log.error("minio put file error.",ex);
            throw new RuntimeException("上传文件失败");
        }
    }

    /**
     *  上传html文件
     * @param prefix  文件前缀
     * @param filename   文件名
     * @param inputStream  文件流
     * @return  文件全路径
     */
    @Override
    public String uploadHtmlFile(String prefix, String filename,
                                 InputStream inputStream) {
        String filePath = builderFilePath(prefix, filename);
        try {
            PutObjectArgs putObjectArgs = PutObjectArgs.builder()
                    .object(filePath)
                    .contentType("text/html")
                    .bucket(minIOConfigProperties.getBucket()).
                     stream(inputStream,inputStream.available(),-1)
                    .build();
            minioClient.putObject(putObjectArgs);
            StringBuilder urlPath = new StringBuilder(minIOConfigProperties
                                                     .getReadPath());
            urlPath.append(separator+minIOConfigProperties.getBucket());
            urlPath.append(separator);
            urlPath.append(filePath);
            return urlPath.toString();
        }catch (Exception ex){
            log.error("minio put file error.",ex);
            ex.printStackTrace();
            throw new RuntimeException("上传文件失败");
        }
    }

    /**
     * 删除文件
     * @param pathUrl  文件全路径
     */
    @Override
    public void delete(String pathUrl) {
        String key = pathUrl.replace(minIOConfigProperties.getEndpoint()+"/","");
        int index = key.indexOf(separator);
        String bucket = key.substring(0,index);
        String filePath = key.substring(index+1);
        // 删除Objects
        RemoveObjectArgs removeObjectArgs = RemoveObjectArgs.builder().bucket(bucket)
                                                            .object(filePath).build();
        try {
            minioClient.removeObject(removeObjectArgs);
        } catch (Exception e) {
            log.error("minio remove file error.  pathUrl:{}",pathUrl);
            e.printStackTrace();
        }
    }


    /**
     * 下载文件
     * @param pathUrl  文件全路径
     * @return  文件流
     *
     */
    @Override
    public byte[] downLoadFile(String pathUrl)  {
        String key = pathUrl.replace(minIOConfigProperties.getEndpoint()+"/","");
        int index = key.indexOf(separator);
        String bucket = key.substring(0,index);
        String filePath = key.substring(index+1);
        InputStream inputStream = null;
        try {
            inputStream = minioClient
                .getObject(GetObjectArgs.builder()                                                       .bucket(minIOConfigProperties.getBucket())
                .object(filePath).build());
        } catch (Exception e) {
            log.error("minio down file error.  pathUrl:{}",pathUrl);
            e.printStackTrace();
        }

        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        byte[] buff = new byte[100];
        int rc = 0;
        while (true) {
            try {
                if (!((rc = inputStream.read(buff, 0, 100)) > 0)) break;
            } catch (IOException e) {
                e.printStackTrace();
            }
            byteArrayOutputStream.write(buff, 0, rc);
        }
        return byteArrayOutputStream.toByteArray();
    }
}
```

### 自动配置

> 在resources中新建`META-INF/spring.factories`
>

```java
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
  com.heima.file.service.impl.MinIOFileStorageService
```

> 注意：pom.xml无需打包插件

> 对maven进行执行clean和install命令即可，每次修改都要重新执行该命令
>
> 切记使用之前先clean后install安装到maven仓库，确保资源更新

## 微服务使用

> 还是去minio-demo中去使用

> 第一，导入heima-file-starter的依赖

```xml
<dependency>
    <groupId>com.heima</groupId>
    <artifactId>heima-file-starter</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```

> 第二，在微服务中添加minio所需要的配置
>

```yaml
minio:
  accessKey: minioadmin
  secretKey: minioadmin
  bucket: heimaleadnews
  endpoint: http://192.168.88.101:9000
  readPath: http://192.168.88.101:9000
```

> 第三，在对应使用的业务类中注入FileStorageService，样例如下：
>

```java
@SpringBootTest
public class MinioTest1 {

    @Autowired
    private FileStorageService fileStorageService;

    @Test
    public void testUpdateImgFile() {
        try {
           // 修改文件名，避免重复
           File file = new File("C:\\Users\\renshuo\\OneDrive\\图片\\g3.jpg");
           String fileName = file.getName();
           String baseName = fileName.substring(0,fileName.lastIndexOf("."));
           String extension = fileName.substring(fileName.lastIndexOf(".") + 1);
           String newName = baseName + UUID.randomUUID().toString() + "." + extension;
           System.out.println(newName); // g3b83c8951-ade1-4cc7-8839-3425d58b4ac9.jpg
           //  上传图片
           FileInputStream fileInputStream = new FileInputStream(file);
           String filePath = fileStorageService.uploadImgFile("",newName , 
                                                              fileInputStream);
           System.out.println(filePath);
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        }
    }
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628154000233.png" alt="image-20230628154000233" style="zoom:80%;" />

> 下载文件

```java
// 下载文件
@Test
public void testDownloadImgFile() {
    try {
        String url = "http://192.168.88.101:9000/heimaleadnews/2023/06/28/g3717aab35-e4df-4154-b6fe-7ab7a7464434.jpg";
        byte[] bytes = fileStorageService.downLoadFile(url);
        String fileName = url.substring(url.lastIndexOf("/")+1);
        System.out.println(fileName);
        // commons-io包下的方法
        FileUtils.writeByteArrayToFile(new File(fileName),bytes);
    } catch (IOException e) {
        e.printStackTrace();
    }
}
```

> 删除文件

```java
// 删除文件
@Test
public void testDeleteImgFile() {
    String url = "http://192.168.88.101:9000/heimaleadnews/2023/06/28/g3717aab35-e4df-4154-b6fe-7ab7a7464434.jpg";
    fileStorageService.delete(url);
}
```



# 文章详情

## 需求分析

![image-20210602180753705](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131526375.png)

## 实现方案

> 方案一：用户某一条文章，根据文章的id去查询文章内容表，返回渲染页面
>

![image-20210602180824202](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131526493.png)

> 方案二：根据minio
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131544875.png" alt="image-20230613154413772" style="zoom:80%;" />

## 实现步骤

> 1.在heima-leadnews-artile微服务中添加MinIO和freemarker的支持，参考测试项目

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-freemarker</artifactId>
    </dependency>
    <dependency>
        <groupId>com.heima</groupId>
        <artifactId>heima-file-starter</artifactId>
        <version>1.0-SNAPSHOT</version>
    </dependency>
</dependencies>
```

> 在nacos配置文件中加入上面的minio配置

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628160519624.png" alt="image-20230628160519624" style="zoom:80%;" />

> 2.资料中找到模板文件（article.ftl）拷贝到article微服务下

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628160805515.png" alt="image-20230628160805515" style="zoom:80%;" />

![image-20210602180931839](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131526685.png)

> 3.资料中找到index.js和index.css两个文件手动上传到MinIO中

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628161120380.png" alt="image-20230628161120380" style="zoom:80%;" />

![image-20210602180957787](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131526785.png)

> 5.新建ApArticleContentMapper

```java
package com.heima.article.mapper;


@Mapper
public interface ApArticleContentMapper extends BaseMapper<ApArticleContent> {
}
```

> 6.在artile微服务中新增测试类（后期新增文章的时候创建详情静态页，目前暂时手动生成）

> 启动测试时要注释掉knif4j的依赖

```java
@SpringBootTest
public class ArticleTest {
    @Autowired
    private Configuration configuration;

    @Autowired
    private FileStorageService fileStorageService;

    @Resource
    private ApArticleMapper apArticleMapper;

    @Resource
    private ApArticleContentMapper apArticleContentMapper;

    @Test
    public void createStaticUrlTest() throws Exception {
        //1.获取文章内容
        ApArticleContent apArticleContent = apArticleContentMapper
                .selectOne(Wrappers.<ApArticleContent>lambdaQuery()
                .eq(ApArticleContent::getArticleId, 1302862387124125698L));
        if(apArticleContent != null &&
                StringUtils.isNotBlank(apArticleContent.getContent())){
            //2.文章内容通过freemarker生成html文件
            StringWriter out = new StringWriter();
            Template template = configuration.getTemplate("article.ftl");

            Map<String, Object> params = new HashMap<>();
            params.put("content", JSONArray.parseArray(apArticleContent.getContent()));
            template.process(params, out);
            InputStream is = new ByteArrayInputStream(out.toString().getBytes());
            System.out.println(is);
            System.out.println(123);

            //3.把html文件上传到minio中
            String path = fileStorageService.uploadHtmlFile("",
                    apArticleContent
                            .getArticleId() + ".html", is);
            System.out.println(path);
            //4.修改ap_article表，保存static_url字段
            ApArticle article = new ApArticle();
            article.setId(apArticleContent.getArticleId());
            article.setStaticUrl(path);
            apArticleMapper.updateById(article);
        }
    }
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628163019955.png" alt="image-20230628163019955" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230628163029931.png" alt="image-20230628163029931" style="zoom:80%;" />



# 自媒体文章发布

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131547208.png" alt="image-20230613154759097" style="zoom:80%;" />

## 后端搭建

### 项目结构



![image-20210426110728659](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131545562.png)

### 实体类

> model模块的

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629151222136.png" alt="image-20230629151222136" style="zoom:80%;" />

```java
@Data
@TableName("wm_user")
public class WmUser implements Serializable {

    private static final long serialVersionUID = 1L;

    //主键
    @TableId(value = "id", type = IdType.AUTO)
    private Integer id;

    @TableField("ap_user_id")
    private Integer apUserId;

    @TableField("ap_author_id")
    private Integer apAuthorId;

    //登录用户名
    @TableField("name")
    private String name;

    //登录密码
    @TableField("password")
    private String password;

    //盐
    @TableField("salt")
    private String salt;

    //昵称
    @TableField("nickname")
    private String nickname;

    //头像
    @TableField("image")
    private String image;

    //归属地
    @TableField("location")
    private String location;

    //手机号
    @TableField("phone")
    private String phone;

    /**
     * 状态
            0 暂时不可用
            1 永久不可用
            9 正常可用
     */
    @TableField("status")
    private Integer status;

    //邮箱
    @TableField("email")
    private String email;

    /**
     * 账号类型
            0 个人 
            1 企业
            2 子账号
     */
    @TableField("type")
    private Integer type;

    //运营评分
    @TableField("score")
    private Integer score;

    //最后一次登录时间
    @TableField("login_time")
    private Date loginTime;

    //创建时间
    @TableField("created_time")
    private Date createdTime;

}
```

```java
@Data
public class WmLoginDto {

    //用户名
    private String name;
    //密码
    private String password;
}
```

### heima-leadnews-wemedia

> service模块下的heima-leadnews-wemedia模块

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629151357899.png" alt="image-20230629151357899" style="zoom:80%;" />

#### bootstrap.yml

```yml
server:
  port: 51803
spring:
  application:
    name: leadnews-wemedia
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.88.101:8848
      config:
        server-addr: 192.168.88.101:8848
        file-extension: yml
```

>  添加对应的nacos配置
>

```yaml
spring:
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/leadnews_wemedia?useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC
    username: root
    password: 123456
# 设置Mapper接口所对应的XML文件位置，如果你在Mapper接口中有自定义方法，需要进行该配置
mybatis-plus:
  mapper-locations: classpath*:mapper/*.xml
  # 设置别名包扫描路径，通过该属性可以给包中的类注册别名
  type-aliases-package: com.heima.model.media.pojos
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629150649176.png" alt="image-20230629150649176" style="zoom:80%;" />

#### WemediaApplication

```java
@SpringBootApplication
@EnableDiscoveryClient
@MapperScan("com.heima.wemedia.mapper")
public class WemediaApplication {

    public static void main(String[] args) {
        SpringApplication.run(WemediaApplication.class,args);
    }
}
```

#### WmUserMapper

```java
@Mapper
public interface WmUserMapper extends BaseMapper<WmUser> {
}
```

#### WmUserService

```java
public interface WmUserService extends IService<WmUser> {

    /**
     * 自媒体端登录
     * @param dto
     * @return
     */
    public ResponseResult login(WmLoginDto dto);

}
```

```java
@Service
public class WmUserServiceImpl extends ServiceImpl<WmUserMapper, WmUser> 
                               implements WmUserService {

    @Override
    public ResponseResult login(WmLoginDto dto) {
        //1.检查参数
        if(StringUtils.isBlank(dto.getName()) || 
           StringUtils.isBlank(dto.getPassword())){
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID,
                                              "用户名或密码为空");
        }

        //2.查询用户
        WmUser wmUser = getOne(Wrappers.<WmUser>lambdaQuery()
                                       .eq(WmUser::getName, dto.getName()));
        if(wmUser == null){
            return ResponseResult.errorResult(AppHttpCodeEnum.DATA_NOT_EXIST);
        }

        //3.比对密码
        String salt = wmUser.getSalt();
        String pswd = dto.getPassword();
        pswd = DigestUtils.md5DigestAsHex((pswd + salt).getBytes());
        if(pswd.equals(wmUser.getPassword())){
            //4.返回数据  jwt
            Map<String,Object> map  = new HashMap<>();
            map.put("token", AppJwtUtil.getToken(wmUser.getId().longValue()));
            wmUser.setSalt("");
            wmUser.setPassword("");
            map.put("user",wmUser);
            return ResponseResult.okResult(map);

        }else {
            return ResponseResult.errorResult(AppHttpCodeEnum.LOGIN_PASSWORD_ERROR);
        }
    }
}
```

#### LoginController

```java
@RestController
@RequestMapping("/login")
public class LoginController {

    @Autowired
    private WmUserService wmUserService;

    @PostMapping("/in")
    public ResponseResult login(@RequestBody WmLoginDto dto){
        return wmUserService.login(dto);
    }
}
```

### heima-leadnews-wemedia-gateway

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629152313171.png" alt="image-20230629152313171" style="zoom:80%;" />

#### bootstarp.yml

```yml
server:
  port: 51602
spring:
  application:
    name: leadnews-wemedia-gateway
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.88.101:8848
      config:
        server-addr: 192.168.88.101:8848
        file-extension: yml
```

#### AuthorizeFilter

```java
@Component
@Slf4j
public class AuthorizeFilter implements Ordered, GlobalFilter {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        //1.获取request和response对象
        ServerHttpRequest request = exchange.getRequest();
        ServerHttpResponse response = exchange.getResponse();

        //2.判断是否是登录
        if(request.getURI().getPath().contains("/login")){
            //放行
            return chain.filter(exchange);
        }

        //3.获取token
        String token = request.getHeaders().getFirst("token");

        //4.判断token是否存在
        if(StringUtils.isBlank(token)){
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            return response.setComplete();
        }

        //5.判断token是否有效
        try {
            Claims claimsBody = AppJwtUtil.getClaimsBody(token);
            //是否是过期
            int result = AppJwtUtil.verifyToken(claimsBody);
            if(result == 1 || result  == 2){
                response.setStatusCode(HttpStatus.UNAUTHORIZED);
                return response.setComplete();
            }

        } catch (Exception e) {
            e.printStackTrace();
        }

        //6.放行
        return chain.filter(exchange);
    }

    /**
     * 优先级设置  值越小  优先级越高
     * @return
     */
    @Override
    public int getOrder() {
        return 0;
    }
}
```

#### AppJwtUtil

```java
public class AppJwtUtil {

    // TOKEN的有效期一天（S）
    private static final int TOKEN_TIME_OUT = 3_600;
    // 加密KEY
    private static final String TOKEN_ENCRY_KEY = 
                                "MDk4ZjZiY2Q0NjIxZDM3M2NhZGU0ZTgzMjYyN2I0ZjY";
    // 最小刷新间隔(S)
    private static final int REFRESH_TIME = 300;

    // 生产ID
    public static String getToken(Long id){
        Map<String, Object> claimMaps = new HashMap<>();
        claimMaps.put("id",id);
        long currentTime = System.currentTimeMillis();
        return Jwts.builder()
                .setId(UUID.randomUUID().toString())
                .setIssuedAt(new Date(currentTime))  //签发时间
                .setSubject("system")  //说明
                .setIssuer("heima") //签发者信息
                .setAudience("app")  //接收用户
                .compressWith(CompressionCodecs.GZIP)  //数据压缩方式
                .signWith(SignatureAlgorithm.HS512, generalKey()) //加密方式
                .setExpiration(new Date(currentTime + TOKEN_TIME_OUT * 1000))//过期时间戳
                .addClaims(claimMaps) //cla信息
                .compact();
    }

    // 获取token中的claims信息
    private static Jws<Claims> getJws(String token) {
            return Jwts.parser()
                    .setSigningKey(generalKey())
                    .parseClaimsJws(token);
    }

    // 获取payload body信息
    public static Claims getClaimsBody(String token) {
        try {
            return getJws(token).getBody();
        }catch (ExpiredJwtException e){
            return null;
        }
    }

    // 获取hearder body信息
    public static JwsHeader getHeaderBody(String token) {
        return getJws(token).getHeader();
    }

    // 是否过期 @return -1：有效，0：有效，1：过期，2：过期
    public static int verifyToken(Claims claims) {
        if(claims==null){
            return 1;
        }
        try {
            claims.getExpiration()
                    .before(new Date());
            // 需要自动刷新TOKEN
            if((claims.getExpiration().getTime()-System
                      .currentTimeMillis())>REFRESH_TIME*1000){
                return -1;
            }else {
                return 0;
            }
        } catch (ExpiredJwtException ex) {
            return 1;
        }catch (Exception e){
            return 2;
        }
    }

    // 由字符串生成加密key
    public static SecretKey generalKey() {
        byte[] encodedKey = Base64.getEncoder().encode(TOKEN_ENCRY_KEY.getBytes());
        SecretKey key = new SecretKeySpec(encodedKey, 0, encodedKey.length, "AES");
        return key;
    }

    public static void main(String[] args) {
       /* Map map = new HashMap();
        map.put("id","11");*/
        System.out.println(AppJwtUtil.getToken(1102L));
        Jws<Claims> jws = AppJwtUtil.getJws("eyJhbGciOiJIUzUxMiIsInppcCI6IkdaSVAifQ.H4sIAAAAAAAAADWLQQqEMAwA_5KzhURNt_qb1KZYQSi0wi6Lf9942NsMw3zh6AVW2DYmDGl2WabkZgreCaM6VXzhFBfJMcMARTqsxIG9Z888QLui3e3Tup5Pb81013KKmVzJTGo11nf9n8v4nMUaEY73DzTabjmDAAAA.4SuqQ42IGqCgBai6qd4RaVpVxTlZIWC826QA9kLvt9d-yVUw82gU47HDaSfOzgAcloZedYNNpUcd18Ne8vvjQA");
        Claims claims = jws.getBody();
        System.out.println(claims.get("id"));
    }
}
```

#### WemediaGatewayAplication

```java
@SpringBootApplication
@EnableDiscoveryClient
public class WemediaGatewayAplication {

    public static void main(String[] args) {
        SpringApplication.run(WemediaGatewayAplication.class,args);
    }
}
```



>  添加对应的nacos配置

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629143719119.png" alt="image-20230629143719119" style="zoom:80%;" />

```yaml
spring:
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]': # 匹配所有请求
            allowedOrigins: "*" #跨域处理 允许所有的域
            allowedMethods: # 支持的方法
              - GET
              - POST
              - PUT
              - DELETE
      routes:
        # 平台管理
        - id: wemedia
          uri: lb://leadnews-wemedia
          predicates:
            - Path=/wemedia/**
          filters:
            - StripPrefix= 1
```

### 启动访问测试

> 启动这两个服务

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629144757468.png" alt="image-20230629144757468" style="zoom:80%;" />

> :51803/doc.htm

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629145408438.png" alt="image-20230629145408438" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629145428574.png" alt="image-20230629145428574" style="zoom:80%;" />

## 前台搭建

![image-20210426110913007](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131545564.png)

> 通过nginx的虚拟主机功能，使用同一个nginx访问多个项目。搭建步骤：
>

> ①：资料中找到wemedia-web.zip解压
>
> ②：在nginx中leadnews.conf目录中新增heima-leadnews-wemedia.conf文件

> - 网关地址修改（localhost:51602）
>
> - 前端项目目录修改（wemedia-web解压的目录）
>
> - 访问端口修改(8802)

```javascript
upstream  heima-wemedia-gateway{
    server localhost:51602;
}

server {
	listen 8802;
	location / {
		root H:/nginx-1.18.0/wemedia-web/;
		index index.html;
	}
	
	location ~/wemedia/MEDIA/(.*) {
		proxy_pass http://heima-wemedia-gateway/$1;
		proxy_set_header HOST $host;  # 不改变源请求头的值
		proxy_pass_request_body on;  #开启获取请求体
		proxy_pass_request_headers on;  #开启获取请求头
		proxy_set_header X-Real-IP $remote_addr;   # 记录真实发出请求的客户端IP
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  #记录代理信息
	}
}
```



③：启动nginx，启动自媒体微服务和对应网关

④：联调测试登录功能

![image-20210426111329136](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131545568.png)

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629150815763.png" alt="image-20230629150815763" style="zoom:80%;" />



## 素材上传⭐

### 需求-方案

> 图片上传的页面，首先是展示素材信息，可以点击图片上传，弹窗后可以上传图片

![image-20210426144327206](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131545575.png)

> 实现思路

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131545586.png" alt="image-20210426144603541" style="zoom:80%;" />

> ①：前端发送上传图片请求，类型为MultipartFile
>
> ②：网关进行token解析后，把解析后的用户信息存储到header中

### 表结构-实体类

媒体图文素材信息表wm_material

![image-20210426144500239](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131545572.png)

> 对应实体类：放到model模块中去
>

```java
@Data
@TableName("wm_material")
public class WmMaterial implements Serializable {

    private static final long serialVersionUID = 1L;

    //主键
    @TableId(value = "id", type = IdType.AUTO)
    private Integer id;

    //自媒体用户ID
    @TableField("user_id")
    private Integer userId;

    //图片地址
    @TableField("url")
    private String url;

    // 素材类型 0 图片 1 视频
    @TableField("type")
    private Short type;

    //是否收藏
    @TableField("is_collection")
    private Short isCollection;

    //创建时间
    @TableField("created_time")
    private Date createdTime;

}
```

### 网关配置

> 这里需要修改网关的filter/AuthorizeFilter

```java
//5.判断token是否有效
try {
    Claims claimsBody = AppJwtUtil.getClaimsBody(token);
    //是否是过期
    int result = AppJwtUtil.verifyToken(claimsBody);
    if(result == 1 || result  == 2){
        response.setStatusCode(HttpStatus.UNAUTHORIZED);
        return response.setComplete();
    }
    //获得token解析后中的用户信息🚗🚗，修改的是这里
    Object userId = claimsBody.get("id");
    //在header中添加新的信息
    ServerHttpRequest serverHttpRequest = request.mutate().headers(httpHeaders -> {
        httpHeaders.add("userId", userId + "");
    }).build();
    //重置当前的header
    exchange.mutate().request(serverHttpRequest).build();

} catch (Exception e) {
    e.printStackTrace();
}
```

### 拦截器配置

> 自媒体微服务使用拦截器获取到header中的的用户信息，并放入到threadlocal中

#### WmThreadLocalUtil

> 在heima-leadnews-utils中新增工具类
>

```java
public class WmThreadLocalUtil {

    private final static ThreadLocal<WmUser> WM_USER_THREAD_LOCAL = new ThreadLocal<>();

    // 添加用户
    public static void  setUser(WmUser wmUser){
        WM_USER_THREAD_LOCAL.set(wmUser);
    }

    //获取用户
    public static WmUser getUser(){
        return WM_USER_THREAD_LOCAL.get();
    }

    //清理用户
    public static void clear(){
        WM_USER_THREAD_LOCAL.remove();
    }
}
```

#### WmTokenInterceptor

> 在heima-leadnews-wemedia中新增拦截器
>

```java
@Slf4j
public class WmTokenInterceptor implements HandlerInterceptor {

    // 得到header中的用户信息(在网关中保存的)，并且存入当前线程中
    @Override
    public boolean preHandle(HttpServletRequest request, 
                             HttpServletResponse response,
                             Object handler) throws Exception {
        // 得到header中的信息
        String userId = request.getHeader("userId");
        // 判断userId是否为空
        Optional<String> optional = Optional.ofNullable(userId);
        if(optional.isPresent()){
            //把用户id存入threadloacl线程中
            WmUser wmUser = new WmUser();
            wmUser.setId(Integer.valueOf(userId));
            WmThreadLocalUtil.setUser(wmUser);
            log.info("wmTokenFilter设置用户信息到threadlocal中...");
        }

        return true;
    }

    // 清理线程中的数据
    @Override
    public void postHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler, ModelAndView modelAndView) throws Exception {
        log.info("清理threadlocal...");
        WmThreadLocalUtil.clear();
    }
}
```

#### WebMvcConfig

> 配置使拦截器生效，拦截所有的请求

```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new WmTokenInterceptor()).addPathPatterns("/**");
    }
}
```

### 图片上传接口

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131549146.png" alt="image-20230613154950007" style="zoom:80%;" />

#### 集成heima-file-starter

> ④：先把图片上传到minIO中，获取到图片请求的路径——（2.2.5查看具体功能实现）
>
> ⑤：把用户id和图片上的路径保存到素材表中——（2.2.5查看具体功能实现）

> ①：heima-leadnews-wemedia模块导入heima-file-starter
>

```xml
<dependencies>
    <dependency>
        <groupId>com.heima</groupId>
        <artifactId>heima-file-starter</artifactId>
        <version>1.0-SNAPSHOT</version>
    </dependency>
</dependencies>
```

> ②：在自媒体微服务的配置中心添加以下配置：

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629155204569.png" alt="image-20230629155204569" style="zoom:80%;" />

```yaml
minio:
  accessKey: minioadmin
  secretKey: minioadmin
  bucket: heimaleadnews
  endpoint: http://192.168.88.101:9000
  readPath: http://192.168.88.101:9000
```

#### 配置最大上传文件

```yml
spring:
# 最大请求大小。值可以使用后缀“MB”或“KB”分别表示兆字节或千字节
  servlet:
    multipart:
      # 最大请求大小。值可以使用后缀“MB”或“KB”分别表示兆字节或千字节
      max-request-size: 100MB
      # 单个文件上传大小,值可以使用后缀“MB”或“KB”分别表示兆字节或千字节
      max-file-size: 100MB
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629160358378.png" alt="image-20230629160358378" style="zoom:80%;" />

> 如果使用了nginx，还需配置nginx最大上传文件大小,nginx默认1m

```nginx
#user  nobody;
worker_processes  1;

events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    client_max_body_size 100m; # 就是这个参数
    sendfile        on;
    keepalive_timeout  65;
	# 引入自定义配置文件
	include leadnews.conf/*.conf;
}
```

#### mapper

```java
@Mapper
public interface WmMaterialMapper extends BaseMapper<WmMaterial> {
}
```

#### 业务层

```java
public interface WmMaterialService extends IService<WmMaterial> {
    // 图片上传
    public ResponseResult uploadPicture(MultipartFile multipartFile);
}
```

> 业务层实现类
>

```java
@Slf4j
@Service
public class WmMaterialServiceImpl extends ServiceImpl<WmMaterialMapper, WmMaterial>
                                   implements WmMaterialService {

    @Autowired
    private FileStorageService fileStorageService;

    // 图片上传
    @Override
    public ResponseResult uploadPicture(MultipartFile multipartFile) {

        //1.检查参数
        if(multipartFile == null || multipartFile.getSize() == 0){
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
        }

        //2.上传图片到minIO中
        String fileName = UUID.randomUUID().toString().replace("-", "");
        //aa.jpg
        String originalFilename = multipartFile.getOriginalFilename();
        String postfix = originalFilename.substring(originalFilename.lastIndexOf("."));
        String fileId = null;
        try {
            fileId = fileStorageService.uploadImgFile("", fileName + postfix, 
                                                      multipartFile.getInputStream());
            log.info("上传图片到MinIO中，fileId:{}",fileId);
        } catch (IOException e) {
            e.printStackTrace();
            log.error("WmMaterialServiceImpl-上传文件失败");
        }

        //3.保存到数据库中
        WmMaterial wmMaterial = new WmMaterial();
        wmMaterial.setUserId(WmThreadLocalUtil.getUser().getId());
        wmMaterial.setUrl(fileId);
        wmMaterial.setIsCollection((short)0);
        wmMaterial.setType((short)0);
        wmMaterial.setCreatedTime(new Date());
        save(wmMaterial);

        //4.返回结果
        return ResponseResult.okResult(wmMaterial);
    }
}
```

#### 控制器

```java
@RestController
@RequestMapping("/api/v1/material")
public class WmMaterialController {

    @Autowired
    private WmMaterialService wmMaterialService;


    @PostMapping("/upload_picture")
    public ResponseResult uploadPicture(MultipartFile multipartFile){
        return wmMaterialService.uploadPicture(multipartFile);
    }

}
```

#### 测试启动

> 自媒体微服务和自媒体网关，使用前端项目进行测试

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629161340559.png" alt="image-20230629161340559" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629162604717.png" alt="image-20230629162604717" style="zoom:80%;" />

> 上传图片接口

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629163004739.png" alt="image-20230629163004739" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629163217769.png" alt="image-20230629163217769" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629163417265.png" alt="image-20230629163417265" style="zoom:80%;" />

## 素材列表查询

### 接口定义

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131550025.png" alt="image-20230613155014880" style="zoom:80%;" />

### WmMaterialDto  

> model类中新建WmMaterialDto

```java
@Data
public class WmMaterialDto extends PageRequestDto {

    // 1 收藏。0 未收藏
    private Short isCollection;
}
```

### WmMaterialController

> 在WmMaterialController类中新增方法，mapper上面已定义

```java
@PostMapping("/list")
public ResponseResult findList(@RequestBody WmMaterialDto dto){
    return wmMaterialService.findList(dto);
}
```

### WmMaterialService

> 在WmMaterialService中新增方法
>

```java
// 素材列表查询
public ResponseResult findList( WmMaterialDto dto);
```

> 实现方法：
>

```java
// 素材列表查询
@Override
public ResponseResult findList(WmMaterialDto dto) {

    //1.检查参数
    dto.checkParam();

    //2.分页查询
    IPage page = new Page(dto.getPage(),dto.getSize());
    LambdaQueryWrapper<WmMaterial> lambdaQueryWrapper = new LambdaQueryWrapper<>();
    //是否收藏
    if(dto.getIsCollection() != null && dto.getIsCollection() == 1){
        lambdaQueryWrapper.eq(WmMaterial::getIsCollection,dto.getIsCollection());
    }
    //按照用户查询
    lambdaQueryWrapper.eq(WmMaterial::getUserId,WmThreadLocalUtil.getUser().getId());

    //按照时间倒序
    lambdaQueryWrapper.orderByDesc(WmMaterial::getCreatedTime);
    page = page(page,lambdaQueryWrapper);

    //3.结果返回
    ResponseResult responseResult = new PageResponseResult(dto.getPage(),
                                                           dto.getSize(),
                                                           (int)page.getTotal());
    responseResult.setData(page.getRecords());
    return responseResult;
}
```

> ⑤：在自媒体引导类中添加mybatis-plus的分页拦截器

```java
@Bean
public MybatisPlusInterceptor mybatisPlusInterceptor() {
    MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
    interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
    return interceptor;
}
```

### 接口测试

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629164355577.png" alt="image-20230629164355577" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629164443329.png" alt="image-20230629164443329" style="zoom:80%;" />



## 自媒体文章管理

### 查询所有频道

![image-20210426205631708](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131545140.png)

#### 表结构-实体类

> wm_channel 频道信息表
>

![image-20210426210148580](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131545162.png)

> 对应实体类：
>

```java
@Data
@TableName("wm_channel")
public class WmChannel implements Serializable {

    private static final long serialVersionUID = 1L;

    @TableId(value = "id", type = IdType.AUTO)
    private Integer id;

    //频道名称
    @TableField("name")
    private String name;

    //频道描述
    @TableField("description")
    private String description;

    // 是否默认频道 1：默认     true 0：非默认   false
    @TableField("is_default")
    private Boolean isDefault;

    // 是否启用 1：启用   true 0：禁用   false
    @TableField("status")
    private Boolean status;

    //默认排序
    @TableField("ord")
    private Integer ord;

    //创建时间
    @TableField("created_time")
    private Date createdTime;

}
```

#### 接口定义

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131550401.png" alt="image-20230613155046273" style="zoom:80%;" />

#### mapper

```java
@Mapper
public interface WmChannelMapper extends BaseMapper<WmChannel> {
}
```

#### service

```java
public interface WmChannelService extends IService<WmChannel> {

    // 查询所有频道
    public ResponseResult findAll();
}
```

> 实现类
>

```java
@Service
@Slf4j
public class WmChannelServiceImpl extends ServiceImpl<WmChannelMapper, WmChannel> 
                                  implements WmChannelService {
    // 查询所有频道
    @Override
    public ResponseResult findAll() {
        return ResponseResult.okResult(list());
    }
}
```

#### WmchannelController

```java
@RestController
@RequestMapping("/api/v1/channel")
public class WmchannelController {

    @Autowired
    private WmChannelService wmChannelService;

    @GetMapping("/channels")
    public ResponseResult findAll(){
        return wmChannelService.findAll();
    }
}
```

#### 功能测试

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629165140431.png" alt="image-20230629165140431" style="zoom:80%;" />

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629165208297.png" alt="image-20230629165208297" style="zoom:80%;" />



### 查询自媒体文章

> 需求说明
>

![image-20210426210402672](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131545184.png)

#### 表结构-实体类

wm_news 自媒体文章表

![image-20210426210434861](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131545470.png)

> 对应实体类：
>

```java
@Data
@TableName("wm_news")
public class WmNews implements Serializable {

    private static final long serialVersionUID = 1L;

    //主键
    @TableId(value = "id", type = IdType.AUTO)
    private Integer id;

    //自媒体用户ID
    @TableField("user_id")
    private Integer userId;

    //标题
    @TableField("title")
    private String title;

    //图文内容
    @TableField("content")
    private String content;

    /**
     * 文章布局
     0 无图文章
     1 单图文章
     3 多图文章
     */
    @TableField("type")
    private Short type;

    //图文频道ID
    @TableField("channel_id")
    private Integer channelId;

    @TableField("labels")
    private String labels;

    //创建时间
    @TableField("created_time")
    private Date createdTime;

    //提交时间
    @TableField("submited_time")
    private Date submitedTime;

    /**
     * 当前状态
     0 草稿
     1 提交（待审核）
     2 审核失败
     3 人工审核
     4 人工审核通过
     8 审核通过（待发布）
     9 已发布
     */
    @TableField("status")
    private Short status;

    //定时发布时间，不定时则为空
    @TableField("publish_time")
    private Date publishTime;

    //拒绝理由
    @TableField("reason")
    private String reason;

    //发布库文章ID
    @TableField("article_id")
    private Long articleId;

    ////图片用逗号分隔
    @TableField("images")
    private String images;

    @TableField("enable")
    private Short enable;

    //状态枚举类
    @Alias("WmNewsStatus")
    public enum Status{
        NORMAL((short)0),
        SUBMIT((short)1),
        FAIL((short)2),
        ADMIN_AUTH((short)3),
        ADMIN_SUCCESS((short)4),
        SUCCESS((short)8),
        PUBLISHED((short)9);
        short code;
        Status(short code){
            this.code = code;
        }
        public short getCode(){
            return this.code;
        }
    }
}
```

#### 接口定义

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131551545.png" alt="image-20230613155130403" style="zoom:80%;" />

#### WmNewsPageReqDto  

```java
@Data
public class WmNewsPageReqDto extends PageRequestDto {
    //状态
    private Short status;
    //开始时间
    private Date beginPubDate;
    //结束时间
    private Date endPubDate;
    //所属频道ID
    private Integer channelId;
    //关键字
    private String keyword;
}
```

#### WmNewsMapper

```java
public interface WmNewsMapper  extends BaseMapper<WmNews> {
}
```

#### WmNewsService

```java
public interface WmNewsService extends IService<WmNews> {
    // 查询文章
    public ResponseResult findAll(WmNewsPageReqDto dto);
}
```

> 实现类
>

```java
@Service
@Slf4j
public class WmNewsServiceImpl  extends ServiceImpl<WmNewsMapper, WmNews> 
                                implements WmNewsService {

    // 查询文章
    @Override
    public ResponseResult findAll(WmNewsPageReqDto dto) {
        //1.检查参数
        if(dto == null){
            return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
        }
        //分页参数检查
        dto.checkParam();
        //获取当前登录人的信息
        WmUser user = WmThreadLocalUtil.getUser();
        if(user == null){
            return ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);
        }
        //2.分页条件查询
        IPage page = new Page(dto.getPage(),dto.getSize());
        LambdaQueryWrapper<WmNews> lambdaQueryWrapper = new LambdaQueryWrapper<>();
        //状态精确查询
        if(dto.getStatus() != null){
            lambdaQueryWrapper.eq(WmNews::getStatus,dto.getStatus());
        }
        //频道精确查询
        if(dto.getChannelId() != null){
            lambdaQueryWrapper.eq(WmNews::getChannelId,dto.getChannelId());
        }
        //时间范围查询
        if(dto.getBeginPubDate()!=null && dto.getEndPubDate()!=null){
            lambdaQueryWrapper.between(WmNews::getPublishTime,
                                       dto.getBeginPubDate(),dto.getEndPubDate());
        }
        //关键字模糊查询
        if(StringUtils.isNotBlank(dto.getKeyword())){
            lambdaQueryWrapper.like(WmNews::getTitle,dto.getKeyword());
        }
        //查询当前登录用户的文章,只要当前用户
        lambdaQueryWrapper.eq(WmNews::getUserId,user.getId());

        //发布时间倒序查询
        lambdaQueryWrapper.orderByDesc(WmNews::getCreatedTime);
        page = page(page,lambdaQueryWrapper);

        //3.结果返回
        ResponseResult responseResult = new PageResponseResult(dto.getPage(),
                                                               dto.getSize(),
                                                               (int)page.getTotal());
        responseResult.setData(page.getRecords());

        return responseResult;
    }
}
```

#### WmNewsController

```java
@RestController
@RequestMapping("/api/v1/news")
public class WmNewsController {


    @Autowired
    private WmNewsService wmNewsService;

    @PostMapping("/list")
    public ResponseResult findAll(@RequestBody WmNewsPageReqDto dto){
        return  wmNewsService.findAll(dto);
    }
}
```

#### 功能测试

> 启动后端自媒体微服务和自媒体网关微服务，测试文章列表查询
>

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629170707809.png" alt="image-20230629170707809" style="zoom:80%;" />

```json
{
    "page": 1,
    "size": 3,
    "channelId": 1,
    "keyword": "kafka",
    "beginPubDate": "2021-04-18T16:19:23.000+00:00",
    "status": 9
}
```

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629170732778.png" alt="image-20230629170732778" style="zoom:80%;" />

### 文章发布⭐

#### 需求+思路

![image-20210427014931255](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131545489.png)

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629194156885.png" alt="image-20230629194156885" style="zoom:80%;" />

> 思路

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131552258.png" alt="image-20230613155231119" style="zoom:80%;" />

#### 表结构-实体类

> 保存文章，除了需要wm_news表以外，还需要另外两张表
>

> wm_material 素材表
>

![image-20210427015037964](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131545511.png)

> wm_news_material 文章素材关系表
>

![image-20210427015054428](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131545770.png)

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131552518.png" alt="image-20230613155202408" style="zoom:80%;" />

> 其中wm_material和wm_news表的实体类已经导入到了项目中，下面是wm_news_material实体类：
>

```java
@Data
@TableName("wm_news_material")
public class WmNewsMaterial implements Serializable {

    private static final long serialVersionUID = 1L;

    //主键
    @TableId(value = "id", type = IdType.AUTO)
    private Integer id;

    //素材ID
    @TableField("material_id")
    private Integer materialId;

    //图文ID
    @TableField("news_id")
    private Integer newsId;

    // 引用类型 0 内容引用 1 主图引用
    @TableField("type")
    private Short type;

    //引用排序
    @TableField("ord")
    private Short ord;
}
```

#### 接口分析

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.3.30/202306131553166.png" alt="image-20230613155338035" style="zoom:80%;" />

#### WmNewsDto  

```java
@Data
public class WmNewsDto {
	//主键id
    private Integer id;
    //标题
    private String title;
    //频道id
    private Integer channelId;
    //标签
    private String labels;
    //发布时间
    private Date publishTime;
    //文章内容
    private String content;
    //文章封面类型  0 无图 1 单图 3 多图 -1 自动
    private Short type;
    //提交时间
    private Date submitedTime;
    //状态 提交为1  草稿为0
    private Short status;
    //封面图片列表 多张图以逗号隔开
    private List<String> images;
}
```

#### WmNewsMaterialMapper

> 新增WmNewsMaterialMapper类，**文章与素材的关联关系需要批量保存**
>
> 索引需要定义mapper文件和对应的映射文件

```java
public interface WmNewsMaterialMapper extends BaseMapper<WmNewsMaterial> {
	 // 批量保存：参数分别是所有素材id，文章id，封面类型
     void saveRelations(@Param("materialIds") List<Integer> materialIds,
                        @Param("newsId") Integer newsId, 
                        @Param("type")Short type);
}
```

> mapper/WmNewsMaterialMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.heima.wemedia.mapper.WmNewsMaterialMapper">

    <insert id="saveRelations">
        insert into wm_news_material (material_id,news_id,type,ord)
        values
        <foreach collection="materialIds" index="ord" item="mid" separator=",">
            (#{mid},#{newsId},#{type},#{ord})
        </foreach>
    </insert>

</mapper>
```

#### WemediaConstants

```java
package com.heima.common.constants;

public class WemediaConstants {

    public static final Short COLLECT_MATERIAL = 1;//收藏

    public static final Short CANCEL_COLLECT_MATERIAL = 0;//取消收藏

    public static final String WM_NEWS_TYPE_IMAGE = "image";

    public static final Short WM_NEWS_NONE_IMAGE = 0;
    public static final Short WM_NEWS_SINGLE_IMAGE = 1;
    public static final Short WM_NEWS_MANY_IMAGE = 3;
    public static final Short WM_NEWS_TYPE_AUTO = -1;

    public static final Short WM_CONTENT_REFERENCE = 0;
    public static final Short WM_COVER_REFERENCE = 1;
}
```

#### WmNewsService

```java
// 发布文章或保存草稿
public ResponseResult submitNews(WmNewsDto dto);
```

#### WmNewsServiceImpl⭐

> 主方法：发布修改文章或保存为草稿

```java
// 发布修改文章或保存为草稿
@Override
public ResponseResult submitNews(WmNewsDto dto) {
    //0.条件判断
    if(dto == null || dto.getContent() == null){
        return ResponseResult.errorResult(AppHttpCodeEnum.PARAM_INVALID);
    }
    //1.保存或修改文章
    WmNews wmNews = new WmNews();
    //属性拷贝 属性名词和类型相同才能拷贝
    BeanUtils.copyProperties(dto,wmNews);
    //封面图片  list---> string
    if(dto.getImages() != null && dto.getImages().size() > 0){
        //[1dddfsd.jpg,sdlfjldk.jpg]-->   1dddfsd.jpg,sdlfjldk.jpg
        String imageStr = StringUtils.join(dto.getImages(), ",");
        wmNews.setImages(imageStr);
    }
    //如果当前封面类型为自动 -1
    if(dto.getType().equals(WemediaConstants.WM_NEWS_TYPE_AUTO)){
        wmNews.setType(null); // 这里设置为null，后面再处理
    }
    saveOrUpdateWmNews(wmNews);
    //2.判断是否为草稿  如果为草稿结束当前方法
    if(dto.getStatus().equals(WmNews.Status.NORMAL.getCode())){
        return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
    }
    //3.不是草稿，保存文章内容图片与素材的关系
    //获取到文章内容中的图片信息
    List<String> materials =  ectractUrlInfo(dto.getContent());
    saveRelativeInfoForContent(materials,wmNews.getId());
    //4.不是草稿，保存文章封面图片与素材的关系，如果当前布局是自动，需要匹配封面图片
    saveRelativeInfoForCover(dto,wmNews,materials);
    return ResponseResult.okResult(AppHttpCodeEnum.SUCCESS);
}
```

> 如果当前封面类型为自动，则设置封面类型的数据

```java
/**
 * 第一个功能：如果当前封面类型为自动，则设置封面类型的数据
 * 匹配规则：
 * 1，如果内容图片大于等于1，小于3  单图  type 1
 * 2，如果内容图片大于等于3  多图  type 3
 * 3，如果内容没有图片，无图  type 0 
 * 第二个功能：保存封面图片与素材的关系
 */ 
private void saveRelativeInfoForCover(WmNewsDto dto, WmNews wmNews, 
                                      List<String> materials) {

    List<String> images = dto.getImages();
    //如果当前封面类型为自动，则设置封面类型的数据
    if(dto.getType().equals(WemediaConstants.WM_NEWS_TYPE_AUTO)){
        //多图
        if(materials.size() >= 3){
            wmNews.setType(WemediaConstants.WM_NEWS_MANY_IMAGE);
            images = materials.stream().limit(3).collect(Collectors.toList());
        }else if(materials.size() >= 1 && materials.size() < 3){
            //单图
            wmNews.setType(WemediaConstants.WM_NEWS_SINGLE_IMAGE);
            images = materials.stream().limit(1).collect(Collectors.toList());
        }else {
            //无图
            wmNews.setType(WemediaConstants.WM_NEWS_NONE_IMAGE);
        }
        //修改文章
        if(images != null && images.size() > 0){
            wmNews.setImages(StringUtils.join(images,","));
        }
        updateById(wmNews);
    }
    if(images != null && images.size() > 0){
        saveRelativeInfo(images,wmNews.getId(),WemediaConstants.WM_COVER_REFERENCE);
    }
}
```

>  处理文章内容图片与素材的关系

```java
private void saveRelativeInfoForContent(List<String> materials, Integer newsId) {
    saveRelativeInfo(materials,newsId,WemediaConstants.WM_CONTENT_REFERENCE);
}
```

```java
// 保存文章图片与素材的关系到数据库中
private void saveRelativeInfo(List<String> materials, Integer newsId, Short type) {
    if(materials!=null && !materials.isEmpty()){
        //通过图片的url查询素材的id
        List<WmMaterial> dbMaterials = wmMaterialMapper
                          .selectList(Wrappers.<WmMaterial>lambdaQuery()
                          .in(WmMaterial::getUrl, materials));
        //判断素材是否有效
        if(dbMaterials==null || dbMaterials.size() == 0){
            //手动抛出异常   第一个功能：能够提示调用者素材失效了，第二个功能，进行数据的回滚
            throw new CustomException(AppHttpCodeEnum.PARAM_INVALID);
        }
        if(materials.size() != dbMaterials.size()){
            throw new CustomException(AppHttpCodeEnum.PARAM_INVALID);
        }

        List<Integer> idList = dbMaterials.stream().map(WmMaterial::getId)
                                          .collect(Collectors.toList());
        //批量保存
        wmNewsMaterialMapper.saveRelations(idList,newsId,type);
    }
}
```

> 提取文章内容中的图片信息

```java
private List<String> ectractUrlInfo(String content) {
    List<String> materials = new ArrayList<>();
    List<Map> maps = JSON.parseArray(content, Map.class);
    for (Map map : maps) {
        if(map.get("type").equals("image")){
            String imgUrl = (String) map.get("value");
            materials.add(imgUrl);
        }
    }
    return materials;
}
```

> 保存或修改文章

```java
@Resource
private WmNewsMaterialMapper wmNewsMaterialMapper;

private void saveOrUpdateWmNews(WmNews wmNews) {
    //补全属性
    wmNews.setUserId(WmThreadLocalUtil.getUser().getId());
    wmNews.setCreatedTime(new Date());
    wmNews.setSubmitedTime(new Date());
    wmNews.setEnable((short)1);//默认上架

    if(wmNews.getId() == null){
        //保存
        save(wmNews);
    }else {
        //修改
        //删除文章图片与素材的关系
        wmNewsMaterialMapper.delete(Wrappers.<WmNewsMaterial>lambdaQuery()
                            .eq(WmNewsMaterial::getNewsId,wmNews.getId()));
        updateById(wmNews);
    }
}
```

#### WmNewsController

```java
@PostMapping("/submit")
public ResponseResult submitNews(@RequestBody WmNewsDto dto){
    return  wmNewsService.submitNews(dto);
}
```

#### 功能测试

![image-20230629213248522](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629213248522.png)

![image-20230629213309103](https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629213309103.png)

> Apipost测试

<img src="https://edu-8673.oss-cn-beijing.aliyuncs.com/img2023.6.17/image-20230629213949286.png" alt="image-20230629213949286" style="zoom:80%;" />

```json
{
  "title": "这里是标题:java123",
  "type": "3",
  "labels": "java",
  "publishTime": "2023-06-15T04:00:00.000Z",
  "channelId": 1,
  "images": [
    "http://192.168.88.101:9000/heimaleadnews/2023/06/29/be941.png",
    "http://192.168.88.101:9000/heimaleadnews/2023/06/29/69bc360c3fd3bd.jpg",
    "http://192.168.88.101:9000/heimaleadnews/2023/06/29/a0dcf81b9305.jpg"
  ],
  "status": 1,
  "content": "[{\"type\":\"image\",\"value\":\"http://192.168.88.101:9000/heimaleadnews/2023/06/29/69bc3622e5cb4b5798280a0d0c3fd3bd.jpg\"},{\"type\":\"text\",\"value\":\"大撒大撒的撒大苏打\"},{\"type\":\"text\",\"value\":\"请在这里输入正文\"}]"
}
```

